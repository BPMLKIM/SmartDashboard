<script type="text/babel">

  const { useState, useEffect, useMemo, useRef } = React;

  const parseCurrency = (val) => {
    if (!val) return 0;
    if (typeof val === 'number') return val;
    // Buang koma dan tukar jadi nombor. Jika NaN, return 0.
    return parseFloat(val.toString().replace(/,/g, "")) || 0;
  };

  // ICONS
  const Icons = {
    Filter: () => (
      <svg className="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
      </svg>
    ),
    Chart: () => (
      <svg className="w-8 h-8 text-blue-500 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z"></path>
      </svg>
    ),
    Money: () => (
      <svg className="w-8 h-8 text-emerald-500 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    ),
    Alert: () => (
      <svg className="w-8 h-8 text-red-500 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
    ),
    Check: () => (
      <svg className="w-8 h-8 text-indigo-500 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    ),
    Print: () => (
      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
      </svg>
    ),
  };

  // --- KOMPONEN CHART (FIXED: GUNA USEREF UNTUK ELAK MEMORY LEAK) ---
  const ChartSection = ({ data, darkMode, onStatusClick }) => {
    const statusChartRef = useRef(null);
    const costChartRef = useRef(null);

    // 1. Persiapan Data
    const chartData = React.useMemo(() => {
      const statusCount = {};
      let totalProjek = 0;
      data.forEach((r) => {
        statusCount[r.LOGIK_SIAP] = (statusCount[r.LOGIK_SIAP] || 0) + 1;
        totalProjek++;
      });

      const bahagianCost = {};
      data.forEach((r) => {
        let nama = r.BAHAGIAN_NAMA.replace("BAHAGIAN ", "").replace("SEKSYEN ", "").replace("DAN ", "& ");
        // Gunakan parseCurrency yang selamat di sini juga
        bahagianCost[nama] = (bahagianCost[nama] || 0) + parseCurrency(r.KOS_AKHIR || r.JUMLAH);
      });

      const sortedBahagian = Object.entries(bahagianCost)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      return { statusCount, sortedBahagian, totalProjek };
    }, [data]);

    // 2. Palette Warna
    const statusColors = {
      "Siap (CPC)": "#10b981",
      "Dalam Jadual": "#3b82f6",
      "Siap (Lewat)": "#f59e0b",
      "Lewat (Overdue)": "#ef4444",
      Batal: "#94a3b8",
      "Belum Mula": "#8b5cf6",
    };

    React.useEffect(() => {
      const textColor = darkMode ? "#cbd5e1" : "#64748b";

      // --- 1. RENDER DONUT CHART ---
      const ctx1 = document.getElementById("chartStatus");
      if (ctx1) {
        // Hancurkan chart lama menggunakan Ref (LEBIH SELAMAT DARI WINDOW)
        if (statusChartRef.current) {
          statusChartRef.current.destroy();
        }

        const labels = Object.keys(chartData.statusCount);
        const dataValues = Object.values(chartData.statusCount);
        const bgColors = labels.map((l) => statusColors[l] || "#cbd5e1");

        statusChartRef.current = new Chart(ctx1, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: dataValues,
                backgroundColor: bgColors,
                borderWidth: 0,
                spacing: 5,
                hoverOffset: 20,
                borderRadius: 8,
                cutout: "85%",
                cursor: 'pointer'
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            onClick: (event, elements, chart) => {
                        if (elements[0]) {
                            const index = elements[0].index;
                            const clickedStatus = chart.data.labels[index];
                            
                            // Panggil fungsi parent untuk filter & tukar tab
                            if (onStatusClick) {
                                onStatusClick(clickedStatus);
                            }
                        }
                    },
            onHover: (event, chartElement) => {
                        // Ubah cursor jadi pointer bila hover atas carta
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
            animation: {
              animateScale: true,
              animateRotate: true,
              duration: 1500,
              easing: "easeOutQuart",
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(15, 23, 42, 0.95)",
                titleColor: "#f8fafc",
                bodyColor: "#e2e8f0",
                padding: 14,
                cornerRadius: 12,
                displayColors: true,
                boxPadding: 6,
                usePointStyle: true,
                callbacks: {
                  label: function (context) {
                    let label = context.label || "";
                    let value = context.raw || 0;
                    let percentage = Math.round((value / chartData.totalProjek) * 100) + "%";
                    return ` ${label}: ${value} (${percentage})`;
                  },
                },
              },
            },
          },
        });
      }

      // --- 2. RENDER BAR CHART ---
      const ctx2 = document.getElementById("chartCost");
      if (ctx2) {
        if (costChartRef.current) {
          costChartRef.current.destroy();
        }

        const gradient = ctx2.getContext("2d").createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "#4f46e5");
        gradient.addColorStop(1, "#06b6d4");

        costChartRef.current = new Chart(ctx2, {
          type: "bar",
          data: {
            labels: chartData.sortedBahagian.map((i) => i[0]),
            datasets: [{
              label: "Nilai Kontrak",
              data: chartData.sortedBahagian.map((i) => i[1]),
              backgroundColor: gradient,
              borderRadius: 8,
              barThickness: 30,
              hoverBackgroundColor: "#4338ca",
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { display: false, grid: { display: false } },
              x: {
                grid: { display: false },
                ticks: {
                  color: textColor,
                  font: { size: 10, family: "'Plus Jakarta Sans', sans-serif", weight: "600" },
                  callback: function (value) {
                    let label = this.getLabelForValue(value);
                    return label.length > 8 ? label.substr(0, 8) + "..." : label;
                  },
                },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: (c) => c[0].label,
                  label: (c) => " RM " + new Intl.NumberFormat("ms-MY", { minimumFractionDigits: 2 }).format(c.parsed.y),
                },
                backgroundColor: darkMode ? "rgba(255, 255, 255, 0.9)" : "rgba(15, 23, 42, 0.95)",
                titleColor: darkMode ? "#0f172a" : "#f8fafc",
                bodyColor: darkMode ? "#334155" : "#e2e8f0",
                titleFont: { size: 13 },
                padding: 14,
                cornerRadius: 12,
                displayColors: false,
              },
            },
          },
        });
      }

      // CLEANUP FUNCTION (PENTING UNTUK MENGELAKKAN MEMORY LEAK)
      return () => {
        if (statusChartRef.current) statusChartRef.current.destroy();
        if (costChartRef.current) costChartRef.current.destroy();
      };

    }, [chartData, darkMode]);

    return (
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        {/* KAD 1: STATUS PROJEK (DOUGHNUT) */}
        <div className="glass-card p-6 relative overflow-hidden group hover:-translate-y-2 hover:shadow-2xl transition-all duration-500 border border-white/60 bg-gradient-to-br from-white/80 to-white/40">
          {/* Hiasan Latar Belakang (Glow Blobs) */}
          <div className="absolute -top-10 -right-10 w-40 h-40 bg-blue-400/20 rounded-full blur-3xl group-hover:bg-blue-500/30 transition-all duration-700"></div>
          <div className="absolute bottom-10 left-10 w-24 h-24 bg-emerald-400/20 rounded-full blur-3xl group-hover:bg-emerald-500/30 transition-all duration-700"></div>

          {/* Header */}
          <div className="flex items-center justify-between mb-4 relative z-10">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-blue-50 rounded-lg text-blue-600 shadow-sm border border-blue-100">
                <svg
                  className="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"
                  ></path>
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"
                  ></path>
                </svg>
              </div>
              <div>
                <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-[0.25em]">
                  Analisis Status
                </h4>
                <div className="text-sm font-extrabold text-slate-700">
                  Prestasi Keseluruhan
                </div>
              </div>
            </div>
          </div>

          {/* CHART AREA */}
          <div className="relative w-full h-56 flex justify-center items-center my-2 z-10">
            <canvas id="chartStatus"></canvas>

            {/* Center Text Animasi */}
            <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none animate-fade-in pb-1">
              <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-br from-slate-800 to-slate-500 drop-shadow-sm tracking-tighter">
                {chartData.totalProjek}
              </span>
              <span className="text-[5px] font-black text-slate-500 uppercase tracking-widest mt-0 bg-white/70 px-3 py-1 rounded-full shadow-sm backdrop-blur-md border border-white/50">
                Projek
              </span>
            </div>
          </div>

          {/* CUSTOM LEGEND - GAYA "CHIPS" */}
          <div className="flex flex-wrap justify-center gap-2 mt-4 px-2 relative z-10">
            {Object.keys(chartData.statusCount).map((status) => (
              <div
                key={status}
                onClick={() => onStatusClick && onStatusClick(status)}
                className="flex items-center gap-2 px-3 py-1.5 bg-white/60 hover:bg-white rounded-full border border-slate-100 shadow-sm hover:shadow-md transition-all duration-300 cursor-default"
              >
                <span
                  className="w-2 h-2 rounded-full ring-2 ring-white"
                  style={{ backgroundColor: statusColors[status] || "#cbd5e1" }}
                ></span>
                <span className="text-[10px] font-bold text-slate-600 uppercase tracking-tight">
                  {status}
                </span>
                <span className="text-[10px] font-black text-slate-400 bg-slate-100 px-1.5 rounded-md ml-1">
                  {chartData.statusCount[status]}
                </span>
              </div>
            ))}
          </div>
        </div>

        {/* KAD 2: PERBELANJAAN (BAR) */}
        <div className="glass-card p-6 relative overflow-hidden group hover:-translate-y-2 hover:shadow-2xl transition-all duration-500 border border-white/60 bg-gradient-to-br from-white/80 to-white/40">
          {/* Hiasan Latar Belakang */}
          <div className="absolute -bottom-10 -right-10 w-48 h-48 bg-indigo-400/20 rounded-full blur-3xl group-hover:bg-indigo-500/30 transition-all duration-700"></div>

          {/* Header */}
          <div className="flex items-center justify-between mb-6 relative z-10">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600 shadow-sm border border-indigo-100">
                <svg
                  className="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              <div>
                <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-[0.25em]">
                  Kewangan
                </h4>
                <div className="text-sm font-extrabold text-slate-700">
                  Top 5 Nilai Kontrak
                </div>
              </div>
            </div>
          </div>

          {/* Chart Area */}
          <div className="w-full h-64 relative z-10">
            <canvas id="chartCost"></canvas>
          </div>
        </div>
      </div>
    );
  };

  // --- 2. KOMPONEN TICKER & ALERT (VERSI SOPAN & TAHUN SEMASA) ---
  const CriticalTicker = ({ data }) => {
    // 1. Dapatkan Tahun Semasa (Auto detect tahun PC user)
    const currentYear = new Date().getFullYear();

    // 2. Filter Projek:
    //    - Status MESTI 'Lewat' atau 'Overdue'
    //    - DAN Tahun Mula MESTI sama dengan Tahun Semasa
    const critical = data.filter((r) => {
      const isLate =
        r.LOGIK_SIAP.includes("Lewat") || r.LOGIK_SIAP.includes("Overdue");
      const isCurrentYear = parseInt(r.TAHUN_MULA) === currentYear;
      return isLate && isCurrentYear;
    });

    // Jika tiada projek lewat tahun ini, jangan tunjuk apa-apa (Bersih)
    if (critical.length === 0) return null;

    return (
      // UBAH SINI: Guna 'relative' (bukan fixed) supaya dia tolak content bawah. Takkan block tajuk.
      // Tambah 'mb-6' untuk jarak sikit dengan tajuk sistem
      <div className="relative w-full z-50 bg-gradient-to-r from-red-600 via-orange-600 to-red-600 text-white shadow-xl border-b border-white/20 ticker-container group mb-6 overflow-hidden rounded-b-2xl mx-auto max-w-7xl mt-4">
        <div className="flex items-center h-12">
          {/* LABEL STATIK (Tahun Semasa) */}
          <div className="flex-shrink-0 bg-black/20 backdrop-blur-md h-full px-6 flex items-center gap-3 border-r border-white/20 relative z-20">
            <div className="relative flex h-3 w-3">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-200 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-3 w-3 bg-white"></span>
            </div>
            <div className="flex flex-col justify-center">
              <span className="text-[9px] font-black uppercase tracking-[0.2em] text-orange-100 leading-none mb-0.5">
                Isu Kritikal
              </span>
              <span className="text-[10px] font-black text-white leading-none">
                Tahun {currentYear}
              </span>
            </div>
          </div>

          {/* KAWASAN BERGERAK (TICKER) */}
          <div className="ticker-wrap flex items-center relative z-10 w-full">
            <div className="ticker flex items-center gap-12 py-2 pl-4">
              {critical.map((r, i) => (
                <div
                  key={i}
                  className="flex items-center gap-3 bg-black/10 px-3 py-1 rounded-lg border border-white/10"
                >
                  {/* Ikon Warning Comel */}
                  <svg
                    className="w-4 h-4 text-orange-300 animate-bounce"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>

                  <span className="text-xs font-semibold tracking-wide flex items-center gap-2">
                    <span className="font-bold text-white whitespace-nowrap">
                      {r.NAMA_PAPARAN}
                    </span>

                    {/* Badge Status */}
                    <span
                      className={`px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider text-white border border-white/20 ${r.LOGIK_SIAP.includes("Overdue")
                        ? "bg-red-500"
                        : "bg-orange-500"
                        }`}
                    >
                      {r.LOGIK_SIAP}
                    </span>

                    <span className="text-orange-100 text-[10px] italic border-l border-white/30 pl-2 whitespace-nowrap">
                      {r.INFO_LEWAT}
                    </span>
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // --- KOMPONEN BARU: CARTA S-CURVE (PRESTASI BELANJA) ---
  const SCurveWidget = ({ data, selectedYear }) => {
      const chartRef = useRef(null);

      // 1. LOGIK PEMPROSESAN DATA
      const curveData = useMemo(() => {
          // Tentukan tahun untuk diplot (Jika 'All', guna tahun semasa)
          const targetYear = selectedYear === "All" ? new Date().getFullYear() : parseInt(selectedYear);
          
          const months = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogos", "Sep", "Okt", "Nov", "Dis"];
          const monthlySpends = new Array(12).fill(0);
          
          let totalContractValue = 0;

          // Loop setiap projek
          data.forEach(p => {
              // Kira Total Nilai Kontrak (Untuk Garisan Siling)
              // Hanya ambil kira projek yang aktif pada tahun tersebut
              const thnMula = p.TAHUN_MULA ? parseInt(p.TAHUN_MULA) : 0;
              if (selectedYear === "All" || thnMula <= targetYear) {
                  totalContractValue += parseCurrency(p.KOS_AKHIR || p.JUMLAH);
              }

              // Loop Financials (Rekod Bayaran)
              if (p.financials && Array.isArray(p.financials)) {
                  p.financials.forEach(f => {
                      if (!f["TARIKH PERAKUAN"]) return;
                      
                      // Parse Tarikh: DD/MM/YYYY
                      const parts = f["TARIKH PERAKUAN"].split('/');
                      if (parts.length < 3) return;
                      
                      const payYear = parseInt(parts[2]);
                      const payMonth = parseInt(parts[1]) - 1; // 0-11

                      // Masukkan jumlah jika tahun sama dengan target
                      if (payYear === targetYear) {
                          const amount = (parseFloat(f.JUMLAH) || 0) + (parseFloat(f.SST) || 0);
                          if (payMonth >= 0 && payMonth < 12) {
                              monthlySpends[payMonth] += amount;
                          }
                      }
                  });
              }
          });

          // Tukar kepada Kumulatif (Accumulative) untuk bentuk S-Curve
          let runningTotal = 0;
          const cumulativeData = monthlySpends.map(val => {
              runningTotal += val;
              return runningTotal;
          });

          // Kira % Pencapaian setakat bulan terkini (atau Disember)
          const currentMonthIndex = new Date().getFullYear() === targetYear ? new Date().getMonth() : 11;
          const currentSpend = cumulativeData[currentMonthIndex];
          const performance = totalContractValue > 0 ? (currentSpend / totalContractValue) * 100 : 0;

          return { 
              labels: months, 
              actual: cumulativeData, 
              totalLimit: totalContractValue,
              performance: performance,
              year: targetYear
          };
      }, [data, selectedYear]);

      // 2. RENDER CARTA
      useEffect(() => {
          const ctx = document.getElementById("chartSCurve");
          if (ctx) {
              if (chartRef.current) chartRef.current.destroy();

              const ctx2d = ctx.getContext("2d");
              // Gradient Ungu Cantik
              const gradient = ctx2d.createLinearGradient(0, 0, 0, 400);
              gradient.addColorStop(0, "rgba(99, 102, 241, 0.5)"); // Indigo cair
              gradient.addColorStop(1, "rgba(99, 102, 241, 0.0)"); // Transparent

              chartRef.current = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: curveData.labels,
                      datasets: [
                          {
                              label: 'Belanja Kumulatif',
                              data: curveData.actual,
                              borderColor: '#6366f1', // Indigo 500
                              backgroundColor: gradient,
                              borderWidth: 3,
                              pointBackgroundColor: '#fff',
                              pointBorderColor: '#6366f1',
                              pointRadius: 4,
                              pointHoverRadius: 6,
                              fill: true,
                              tension: 0.4 // Jadikan garisan melengkung (S-shape)
                          },
                          {
                              label: 'Siling Kontrak',
                              data: new Array(12).fill(curveData.totalLimit),
                              borderColor: '#cbd5e1', // Slate 300
                              borderWidth: 2,
                              borderDash: [5, 5], // Garisan putus-putus
                              pointRadius: 0,
                              fill: false
                          }
                      ]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      interaction: {
                          mode: 'index',
                          intersect: false,
                      },
                      plugins: {
                          legend: { display: false }, // Kita buat custom legend tepi
                          tooltip: {
                              callbacks: {
                                  label: (c) => " RM " + new Intl.NumberFormat("ms-MY", { minimumFractionDigits: 2, compactDisplay: "short", notation: "compact" }).format(c.raw)
                              },
                              backgroundColor: 'rgba(15, 23, 42, 0.9)',
                              padding: 10,
                              cornerRadius: 8
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              grid: { color: '#f1f5f9' },
                              ticks: {
                                  callback: (val) => (val / 1000000).toFixed(1) + "M", // Format Juta
                                  font: { size: 10 }
                              }
                          },
                          x: {
                              grid: { display: false },
                              ticks: { font: { size: 10, weight: 'bold' } }
                          }
                      }
                  }
              });
          }
          return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [curveData]);

      const fmtCompact = (val) => "RM" + new Intl.NumberFormat("en-US", { notation: "compact", maximumFractionDigits: 1 }).format(val);

      return (
          <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-xl mb-8 flex flex-col md:flex-row gap-6">
              
              {/* INFO PANEL (KIRI) */}
              <div className="w-full md:w-1/4 flex flex-col justify-between">
                  <div>
                      <div className="flex items-center gap-2 mb-2">
                          <div className="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                          </div>
                          <h3 className="text-sm font-black text-slate-700 uppercase tracking-widest leading-tight">Prestasi Belanja<br/><span className="text-[10px] text-slate-400">Tahun {curveData.year}</span></h3>
                      </div>
                      <p className="text-[10px] text-slate-400 font-medium leading-relaxed mb-4">
                          Analisis kumulatif perbelanjaan sebenar berbanding jumlah nilai kontrak projek yang aktif.
                      </p>
                  </div>

                  <div className="bg-slate-50 rounded-xl p-4 border border-slate-100">
                      <div className="mb-3">
                          <div className="text-[9px] font-bold text-slate-400 uppercase">Jumlah Belanja (YTD)</div>
                          <div className="text-2xl font-black text-indigo-600">
                              {fmtCompact(curveData.actual[curveData.actual.length - 1] || curveData.actual.reduce((a,b)=> Math.max(a,b),0))}
                          </div>
                      </div>
                      <div>
                          <div className="flex justify-between text-[9px] font-bold text-slate-500 mb-1">
                              <span>Kadar Utilisasi</span>
                              <span>{curveData.performance.toFixed(1)}%</span>
                          </div>
                          <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                              <div className="bg-indigo-500 h-full rounded-full transition-all duration-1000" style={{ width: `${curveData.performance}%` }}></div>
                          </div>
                      </div>
                  </div>
              </div>

              {/* CARTA AREA (KANAN) */}
              <div className="flex-1 h-64 relative">
                  <canvas id="chartSCurve"></canvas>
              </div>
          </div>
      );
  };

  // --- KOMPONEN BARU: TAKWIM MILESTONE (DENGAN FILTER) ---
  const MasterCalendarWidget = ({ data }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDayEvents, setSelectedDayEvents] = useState([]);

      // 1. STATE UNTUK FILTER (BARU TAMBAH)
      const [filters, setFilters] = useState({ // <--- BARU: State Filter
          urs: true,
          uat: true,
          live: true,
          eot: true
      });

      // 2. GENERATE CALENDAR DATA (KEKAL SAMA)
      const calendarData = useMemo(() => {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth(); 
          
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const daysInMonth = lastDay.getDate();
          const startDayOfWeek = firstDay.getDay();

          const days = [];
          for (let i = 0; i < startDayOfWeek; i++) days.push(null);
          for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));

          const eventsMap = {}; 

          data.forEach(p => {
              if (p.LOGIK_SIAP === 'Batal') return;
              const sdlc = p.sdlc || {};

              const addEvent = (dateStr, type, color) => {
                  if (!dateStr || dateStr === "-" || dateStr.trim() === "") return;
                  const parts = dateStr.split('/');
                  if (parts.length < 3) return;
                  const d = parseInt(parts[0], 10);
                  const m = parseInt(parts[1], 10) - 1; 
                  const y = parseInt(parts[2], 10);
                  const key = `${y}-${m}-${d}`;
                  
                  if (!eventsMap[key]) eventsMap[key] = [];
                  eventsMap[key].push({ type, color, name: p.NAMA_PAPARAN, ref: p["NO SEBUT HARGA"], pic: p.PEGAWAI_NAMA });
              };

              const tURS = sdlc["TARIKH URS SEBENAR"] || sdlc["TARIKH URS BARU"] || sdlc["TARIKH URS ASAL"];
              addEvent(tURS, "URS", "bg-blue-500");

              const tUAT = sdlc["TARIKH UAT SEBENAR"] || sdlc["TARIKH UAT BARU"] || sdlc["TARIK UAT BARU"] || sdlc["TARIKH UAT ASAL"];
              addEvent(tUAT, "UAT", "bg-orange-500");

              const tLive = sdlc["TARIKH GO LIVE SEBENAR"] || sdlc["TARIKH GO LIVE BARU"] || sdlc["TARIKH GO LIVE ASAL"];
              addEvent(tLive, "GO-LIVE", "bg-emerald-500");

              if(p["EOT"]) addEvent(p["EOT"], "TAMAT EOT", "bg-red-500");
          });

          return { days, eventsMap };
      }, [data, currentDate]);

      // Navigation (KEKAL SAMA)
      const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
      const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
      const today = new Date();

      const handleDayClick = (date) => {
          if (!date) return;
          const key = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
          
          // KITA TAPIS DATA BILA KLIK JUGA (SUPAYA LIST KANAN PUN IKUT FILTER)
          const allEvents = calendarData.eventsMap[key] || [];
          const filteredEvents = allEvents.filter(ev => { // <--- BARU: Logic filter
              if (ev.type === 'URS' && !filters.urs) return false;
              if (ev.type === 'UAT' && !filters.uat) return false;
              if (ev.type === 'GO-LIVE' && !filters.live) return false;
              if (ev.type === 'TAMAT EOT' && !filters.eot) return false;
              return true;
          });

          setSelectedDayEvents({ date, events: filteredEvents });
      };

      // Auto select today (KEKAL SAMA)
      useEffect(() => {
          const todayKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
          if (calendarData.eventsMap[todayKey]) handleDayClick(today);
          else handleDayClick(new Date()); 
      }, [calendarData, filters]); // <--- Tambah 'filters' dalam dependency supaya auto refresh bila tekan toggle

      const monthNames = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];

      return (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 h-full">
              
              {/* KALENDAR VIEW (KIRI) */}
              <div className="lg:col-span-2 bg-white rounded-3xl p-6 border border-slate-200 shadow-xl relative overflow-hidden">
                  <div className="flex justify-between items-center mb-4"> {/* Margin Bottom dikurangkan sikit */}
                      <div>
                          <h3 className="text-lg font-black text-slate-800 uppercase tracking-tighter">Takwim Projek</h3>
                          <p className="text-xs text-slate-400 font-bold">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</p>
                      </div>
                      <div className="flex gap-2">
                          <button onClick={prevMonth} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg></button>
                          <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-black uppercase hover:bg-indigo-100 transition-colors">Hari Ini</button>
                          <button onClick={nextMonth} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg></button>
                      </div>
                  </div>

                  {/* --- BARU: BUTANG TOGGLE FILTER DI SINI --- */}
                  <div className="flex flex-wrap gap-2 mb-4 px-1">
                      <button onClick={() => setFilters(f => ({...f, urs: !f.urs}))} className={`text-[9px] font-bold px-2 py-1 rounded-md border transition-all ${filters.urs ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-slate-50 text-slate-400 border-slate-100 opacity-50 grayscale'}`}>URS (Biru)</button>
                      <button onClick={() => setFilters(f => ({...f, uat: !f.uat}))} className={`text-[9px] font-bold px-2 py-1 rounded-md border transition-all ${filters.uat ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-slate-50 text-slate-400 border-slate-100 opacity-50 grayscale'}`}>UAT (Oren)</button>
                      <button onClick={() => setFilters(f => ({...f, live: !f.live}))} className={`text-[9px] font-bold px-2 py-1 rounded-md border transition-all ${filters.live ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-50 text-slate-400 border-slate-100 opacity-50 grayscale'}`}>GO-LIVE (Hijau)</button>
                      <button onClick={() => setFilters(f => ({...f, eot: !f.eot}))} className={`text-[9px] font-bold px-2 py-1 rounded-md border transition-all ${filters.eot ? 'bg-red-100 text-red-700 border-red-200' : 'bg-slate-50 text-slate-400 border-slate-100 opacity-50 grayscale'}`}>EOT (Merah)</button>
                  </div>
                  {/* ------------------------------------------ */}

                  <div className="grid grid-cols-7 gap-2 mb-2 text-center">
                      {["Ahad", "Isnin", "Selasa", "Rabu", "Khamis", "Jumaat", "Sabtu"].map(d => (
                          <div key={d} className="text-[10px] font-black text-slate-300 uppercase tracking-wider">{d}</div>
                      ))}
                  </div>
                  
                  <div className="grid grid-cols-7 gap-2">
                      {calendarData.days.map((day, i) => {
                          if (!day) return <div key={i} className="h-20 sm:h-24 bg-slate-50/30 rounded-xl border border-transparent"></div>;
                          
                          const key = `${day.getFullYear()}-${day.getMonth()}-${day.getDate()}`;
                          const allEvents = calendarData.eventsMap[key] || [];
                          
                          // --- BARU: LOGIK TAPISAN DI SINI (LANGKAH 3) ---
                          // Kita filter events SEBELUM render titik-titik
                          const events = allEvents.filter(ev => {
                              if (ev.type === 'URS' && !filters.urs) return false;
                              if (ev.type === 'UAT' && !filters.uat) return false;
                              if (ev.type === 'GO-LIVE' && !filters.live) return false;
                              if (ev.type === 'TAMAT EOT' && !filters.eot) return false;
                              return true;
                          });
                          // -----------------------------------------------

                          const isToday = day.getDate() === today.getDate() && day.getMonth() === today.getMonth() && day.getFullYear() === today.getFullYear();
                          const isSelected = selectedDayEvents.date && day.getDate() === selectedDayEvents.date.getDate() && day.getMonth() === selectedDayEvents.date.getMonth();

                          return (
                              <div 
                                  key={i} 
                                  onClick={() => handleDayClick(day)}
                                  className={`h-20 sm:h-24 rounded-xl p-2 border transition-all cursor-pointer relative group flex flex-col justify-between
                                      ${isSelected ? 'border-indigo-500 ring-2 ring-indigo-200 bg-indigo-50/30' : 'border-slate-100 bg-slate-50/50 hover:border-indigo-300 hover:bg-white'}
                                      ${isToday ? 'bg-white shadow-inner ring-1 ring-slate-200' : ''}
                                  `}
                              >
                                  <span className={`text-xs font-black ${isToday ? 'text-white bg-indigo-600 w-6 h-6 flex items-center justify-center rounded-full shadow-md shadow-indigo-300' : 'text-slate-400'}`}>
                                      {day.getDate()}
                                  </span>
                                  
                                  <div className="flex flex-wrap gap-1 content-end">
                                      {/* Gunakan variable 'events' yang dah ditapis tadi */}
                                      {events.slice(0, 4).map((ev, idx) => (
                                          <div key={idx} className={`w-2 h-2 rounded-full ${ev.color} shadow-sm ring-1 ring-white`} title={ev.type}></div>
                                      ))}
                                      {events.length > 4 && <span className="text-[8px] text-slate-400 font-bold pl-0.5">+{events.length - 4}</span>}
                                  </div>
                              </div>
                          );
                      })}
                  </div>
              </div>

              {/* DETAIL EVENTS (KANAN) */}
              <div className="lg:col-span-1 bg-slate-900 text-white rounded-3xl p-6 shadow-2xl flex flex-col relative overflow-hidden">
                  <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500 rounded-full blur-[60px] opacity-20"></div>
                  <div className="absolute bottom-0 left-0 w-40 h-40 bg-purple-500 rounded-full blur-[60px] opacity-20"></div>

                  <div className="relative z-10 h-full flex flex-col">
                      <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Agenda Harian</h4>
                      <h2 className="text-3xl font-black mb-6">
                          {selectedDayEvents.date ? `${selectedDayEvents.date.getDate()} ${monthNames[selectedDayEvents.date.getMonth()]}` : "Pilih Tarikh"}
                      </h2>

                      <div className="space-y-3 overflow-y-auto custom-scroll pr-2 flex-1">
                          {selectedDayEvents.events && selectedDayEvents.events.length > 0 ? (
                              selectedDayEvents.events.map((ev, idx) => (
                                  <div key={idx} className="bg-white/10 backdrop-blur-md rounded-xl p-3 border border-white/10 hover:bg-white/20 transition-colors group">
                                      <div className="flex justify-between items-start mb-2">
                                          <span className={`text-[9px] font-black px-2 py-0.5 rounded shadow-sm text-white uppercase tracking-wider ${ev.color}`}>
                                              {ev.type}
                                          </span>
                                          {ev.ref && <span className="text-[8px] text-slate-400 font-mono truncate max-w-[80px]">{ev.ref}</span>}
                                      </div>
                                      <div className="text-sm font-bold leading-tight mb-2 group-hover:text-blue-300 transition-colors">{ev.name}</div>
                                      <div className="text-[10px] text-slate-400 flex items-center gap-1.5 pt-2 border-t border-white/10">
                                          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                          <span className="truncate">{ev.pic || "Tiada Nama"}</span>
                                      </div>
                                  </div>
                              ))
                          ) : (
                              <div className="h-full flex flex-col items-center justify-center text-slate-500 italic pb-10">
                                  <span className="text-4xl block mb-3 opacity-30">ðŸ“…</span>
                                  <p>Tiada aktiviti penting pada tarikh ini.</p>
                              </div>
                          )}
                      </div>
                  </div>
              </div>
          </div>
      );
  };

  // --- KOMPONEN BARU: UNJURAN ALIRAN TUNAI (CASH FLOW) ---
  const CashFlowWidget = ({ data }) => {
      const chartRef = useRef(null);

      // 1. LOGIK PENGIRAAN UNJURAN
      const projectionData = useMemo(() => {
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();
          
          // Kita nak unjurkan untuk: Bulan Ini, Bulan Depan, Bulan Satu Lagi (3 Bulan)
          const months = [];
          const monthLabels = [];
          
          for (let i = 0; i < 3; i++) {
              const d = new Date(currentYear, currentMonth + i, 1);
              months.push(d); // Object Date untuk comparison
              // Format Label: "Jan 2025"
              monthLabels.push(d.toLocaleDateString('ms-MY', { month: 'short', year: 'numeric' }));
          }

          // Init Data: [Bulan 1, Bulan 2, Bulan 3]
          const totals = [0, 0, 0];
          const details = [[], [], []]; // Untuk simpan nama projek bagi setiap bulan

          data.forEach(p => {
              // Abaikan projek batal atau dah siap sepenuhnya (100% progress masa & fizikal)
              if (p.LOGIK_SIAP === 'Batal' || (p.LOGIK_SIAP === 'Siap (CPC)' && p.PROGRESS_MASA >= 100)) return;

              const kos = parseFloat(p.KOS_AKHIR || 0);
              if (kos <= 0) return;

              const sdlc = p.sdlc || {};
              
              // Helper untuk cek tarikh jatuh dalam bulan mana (0, 1, atau 2)
              const checkMonthIndex = (dateStr) => {
                  if (!dateStr || dateStr === "-") return -1;
                  const parts = dateStr.split('/');
                  const dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                  
                  // Cari index bulan yang sepadan
                  return months.findIndex(m => 
                      m.getMonth() === dateObj.getMonth() && 
                      m.getFullYear() === dateObj.getFullYear()
                  );
              };

              // A. Milestone URS (30%)
              // Guna Tarikh Baru jika ada, kalau tak guna Asal
              const dateURS = sdlc["TARIKH URS BARU"] || sdlc["TARIKH URS ASAL"];
              const idxURS = checkMonthIndex(dateURS);
              if (idxURS >= 0) {
                  const amount = kos * 0.30;
                  totals[idxURS] += amount;
                  details[idxURS].push({ name: p.NAMA_PAPARAN, type: 'URS (30%)', val: amount });
              }

              // B. Milestone UAT (60%)
              const dateUAT = sdlc["TARIKH UAT BARU"] || sdlc["TARIK UAT BARU"] || sdlc["TARIKH UAT ASAL"];
              const idxUAT = checkMonthIndex(dateUAT);
              if (idxUAT >= 0) {
                  const amount = kos * 0.60;
                  totals[idxUAT] += amount;
                  details[idxUAT].push({ name: p.NAMA_PAPARAN, type: 'UAT (60%)', val: amount });
              }

              // C. Milestone Go-Live (10%)
              const dateLive = sdlc["TARIKH GO LIVE BARU"] || sdlc["TARIKH GO LIVE ASAL"];
              const idxLive = checkMonthIndex(dateLive);
              if (idxLive >= 0) {
                  const amount = kos * 0.10;
                  totals[idxLive] += amount;
                  details[idxLive].push({ name: p.NAMA_PAPARAN, type: 'CPC (10%)', val: amount });
              }
          });

          return { labels: monthLabels, values: totals, details: details };
      }, [data]);

      // 2. RENDER CARTA (EFFECT)
      useEffect(() => {
          const ctx = document.getElementById("chartCashFlow");
          if (ctx) {
              if (chartRef.current) {
                  chartRef.current.destroy();
              }

              // Gradient Cantik
              const ctx2d = ctx.getContext("2d");
              const gradient = ctx2d.createLinearGradient(0, 0, 0, 300);
              gradient.addColorStop(0, "#8b5cf6"); // Violet
              gradient.addColorStop(1, "#ec4899"); // Pink

              chartRef.current = new Chart(ctx, {
                  type: "bar",
                  data: {
                      labels: projectionData.labels,
                      datasets: [{
                          label: "Unjuran Bayaran",
                          data: projectionData.values,
                          backgroundColor: gradient,
                          borderRadius: 6,
                          barThickness: 40,
                          hoverBackgroundColor: "#7c3aed",
                      }],
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              callbacks: {
                                  label: (c) => " RM " + new Intl.NumberFormat("ms-MY", { minimumFractionDigits: 2 }).format(c.raw),
                              },
                              backgroundColor: "rgba(17, 24, 39, 0.9)",
                              padding: 12,
                              cornerRadius: 8,
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              grid: { color: "#f1f5f9" },
                              ticks: {
                                  callback: (val) => "RM" + (val / 1000) + "k", // Format ribu
                                  font: { size: 10 }
                              }
                          },
                          x: {
                              grid: { display: false },
                              ticks: { font: { weight: 'bold' } }
                          }
                      }
                  },
              });
          }
          return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [projectionData]);

      // UI HELPER: Format RM
      const fmt = (v) => "RM " + v.toLocaleString("en-MY", { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      return (
          <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-xl mb-8 relative overflow-hidden group">
              
              {/* Header */}
              <div className="flex justify-between items-end mb-6 relative z-10">
                  <div>
                      <div className="flex items-center gap-2 mb-1">
                          <span className="p-1.5 bg-purple-100 text-purple-600 rounded-lg">
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                          </span>
                          <h3 className="text-sm font-black text-slate-700 uppercase tracking-widest">Unjuran Aliran Tunai</h3>
                      </div>
                      <p className="text-[10px] text-slate-400 font-medium">Jangkaan komitmen pembayaran untuk 3 bulan akan datang berdasarkan milestone projek.</p>
                  </div>
                  <div className="text-right">
                      <div className="text-[10px] font-bold text-slate-400 uppercase">Jumlah 3 Bulan</div>
                      <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500">
                          {fmt(projectionData.values.reduce((a,b)=>a+b, 0))}
                      </div>
                  </div>
              </div>

              {/* Content Grid */}
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  
                  {/* KIRI: CARTA */}
                  <div className="lg:col-span-2 h-48 relative z-10">
                      <canvas id="chartCashFlow"></canvas>
                  </div>

                  {/* KANAN: LIST BREAKDOWN */}
                  <div className="lg:col-span-1 bg-slate-50 rounded-2xl p-4 border border-slate-100 overflow-y-auto max-h-48 custom-scroll relative z-10">
                      <h4 className="text-[10px] font-black text-slate-400 uppercase mb-3 border-b border-slate-200 pb-2">Perincian Bulan Terdekat</h4>
                      <div className="space-y-3">
                          {/* Papar detail untuk bulan pertama sahaja (Immediate action) */}
                          {projectionData.details[0].length > 0 ? (
                              projectionData.details[0].map((item, i) => (
                                  <div key={i} className="flex justify-between items-center group/item">
                                      <div className="w-[70%]">
                                          <div className="text-[10px] font-bold text-slate-700 truncate" title={item.name}>{item.name}</div>
                                          <div className="text-[9px] text-purple-500 font-bold">{item.type}</div>
                                      </div>
                                      <div className="text-[10px] font-mono font-black text-slate-600 bg-white px-1.5 py-0.5 rounded border border-slate-200">
                                          {fmt(item.val)}
                                      </div>
                                  </div>
                              ))
                          ) : (
                              <div className="text-center py-4 text-[10px] text-slate-400 italic">Tiada tuntutan dijangka bulan ini.</div>
                          )}
                      </div>
                  </div>
              </div>

              {/* Hiasan Latar */}
              <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
          </div>
      );
  };

// --- KOMPONEN BARU: PETA HABA RISIKO (RISK HEATMAP) ---
const RiskHeatmapWidget = ({ data }) => {
    const [selectedCell, setSelectedCell] = useState(null); // { label, projects, color }

    // 1. LOGIK PENGELASAN RISIKO AUTOMATIK
    const matrixData = useMemo(() => {
        // Grid 3x3: [High-Low, High-Med, High-High, ...]
        // Format Key: "IMPACT-PROBABILITY" (e.g., "HIGH-HIGH")
        const grid = {
            "HIGH-HIGH": [], "HIGH-MED": [], "HIGH-LOW": [],
            "MED-HIGH": [],  "MED-MED":  [], "MED-LOW":  [],
            "LOW-HIGH":  [], "LOW-MED":  [], "LOW-LOW":  []
        };

        data.forEach(p => {
            // Abaikan projek batal atau dah siap sepenuhnya
            if (p.LOGIK_SIAP === 'Batal' || (p.LOGIK_SIAP === 'Siap (CPC)' && p.PROGRESS_MASA >= 100)) return;

            // A. TENTUKAN IMPAK (Y-AXIS) - Berdasarkan Kos
            const kos = parseFloat(p.KOS_AKHIR ? p.KOS_AKHIR.toString().replace(/,/g, "") : 0);
            let impact = "LOW";
            if (kos > 500000) impact = "HIGH";
            else if (kos > 50000) impact = "MED";

            // B. TENTUKAN KEBARANGKALIAN (X-AXIS) - Berdasarkan Kesihatan
            // Guna logik gap yang sama macam ProjectCard
            const finScore = parseFloat(p.PROGRESS_MASA || 0);
            
            // Kira % Masa (Solid Bar)
            const today = new Date(); today.setHours(0,0,0,0);
            const dMula = p["TARIKH MULA"] ? new Date(p["TARIKH MULA"].split('/')[2], p["TARIKH MULA"].split('/')[1]-1, p["TARIKH MULA"].split('/')[0]) : null;
            const dTamat = p["EOT"] ? new Date(p["EOT"].split('/')[2], p["EOT"].split('/')[1]-1, p["EOT"].split('/')[0]) : 
                           (p["TARIKH SIAP"] ? new Date(p["TARIKH SIAP"].split('/')[2], p["TARIKH SIAP"].split('/')[1]-1, p["TARIKH SIAP"].split('/')[0]) : null);
            
            let timePercent = 0;
            if (dMula && dTamat) {
                const total = dTamat - dMula;
                const elapsed = today - dMula;
                if (total > 0) timePercent = (elapsed / total) * 100;
            }
            if (timePercent > 100) timePercent = 100;
            if (timePercent < 0) timePercent = 0;

            const gap = timePercent - finScore;
            
            let prob = "LOW";
            // Jika dah Overrun tarikh -> High Prob
            if (dTamat && today > dTamat) prob = "HIGH";
            // Jika Gap besar -> High Prob
            else if (gap > 30) prob = "HIGH";
            // Jika Gap sederhana -> Med Prob
            else if (gap > 15) prob = "MED";

            // Masukkan ke dalam Grid
            const key = `${impact}-${prob}`;
            if (grid[key]) {
                grid[key].push({
                    name: p.NAMA_PAPARAN,
                    kos: kos,
                    gap: gap,
                    status: p.LOGIK_SIAP,
                    pic: p.PEGAWAI_NAMA
                });
            }
        });

        return grid;
    }, [data]);

    // UI Helper: Warna Cell
    const getCellColor = (type) => {
        switch(type) {
            case "HIGH-HIGH": return "bg-red-600 text-white border-red-500 shadow-red-500/50"; // ZON BAHAYA
            case "HIGH-MED": 
            case "MED-HIGH": return "bg-orange-500 text-white border-orange-400 shadow-orange-500/50"; // ZON AMARAN
            case "MED-MED":
            case "LOW-HIGH": 
            case "HIGH-LOW": return "bg-yellow-400 text-yellow-900 border-yellow-300 shadow-yellow-500/30"; // ZON SEDERHANA
            default: return "bg-emerald-500 text-white border-emerald-400 shadow-emerald-500/30"; // ZON SELAMAT
        }
    };

    const getCellLabel = (type) => {
        if (type === "HIGH-HIGH") return "KRITIKAL";
        if (type.includes("HIGH") || type === "MED-MED") return "PERHATIAN";
        return "RUTIN";
    };

    const fmtMoney = (val) => "RM " + val.toLocaleString("en-MY", { compactDisplay: "short", notation: "compact" });

    return (
        <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-xl mb-8 flex flex-col md:flex-row gap-8">
            
            {/* KIRI: THE MATRIX GRID */}
            <div className="flex-1">
                <div className="flex items-center gap-3 mb-4">
                    <span className="p-2 bg-red-100 text-red-600 rounded-lg">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </span>
                    <div>
                        <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest">Matriks Risiko Projek</h3>
                        <p className="text-[10px] text-slate-400 font-medium">Analisis Impak (Kos) vs Prestasi</p>
                    </div>
                </div>

                <div className="relative pl-8 pb-8">
                    {/* Y-Axis Label */}
                    <div className="absolute left-0 top-0 bottom-8 w-6 flex items-center justify-center">
                        <span className="-rotate-90 text-[9px] font-black text-slate-400 uppercase tracking-widest whitespace-nowrap">Impak (Nilai)</span>
                    </div>

                    {/* THE GRID */}
                    <div className="grid grid-cols-3 gap-2 h-64">
                        {/* ROW 1: HIGH IMPACT */}
                        {["HIGH-LOW", "HIGH-MED", "HIGH-HIGH"].map(key => (
                            <div key={key} onClick={() => setSelectedCell({id: key, list: matrixData[key], color: getCellColor(key)})} 
                                 className={`relative rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all hover:scale-105 active:scale-95 group ${getCellColor(key)} ${selectedCell?.id === key ? 'ring-4 ring-offset-2 ring-slate-300 scale-105 z-10' : 'opacity-90 hover:opacity-100'}`}>
                                <span className="text-2xl font-black drop-shadow-md">{matrixData[key].length}</span>
                                {key === "HIGH-HIGH" && matrixData[key].length > 0 && <span className="absolute top-1 right-1 flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-white"></span></span>}
                            </div>
                        ))}
                        {/* ROW 2: MED IMPACT */}
                        {["MED-LOW", "MED-MED", "MED-HIGH"].map(key => (
                            <div key={key} onClick={() => setSelectedCell({id: key, list: matrixData[key], color: getCellColor(key)})}
                                 className={`rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all hover:scale-105 group ${getCellColor(key)} ${selectedCell?.id === key ? 'ring-4 ring-offset-2 ring-slate-300 scale-105 z-10' : 'opacity-90 hover:opacity-100'}`}>
                                <span className="text-xl font-black drop-shadow-sm">{matrixData[key].length}</span>
                            </div>
                        ))}
                        {/* ROW 3: LOW IMPACT */}
                        {["LOW-LOW", "LOW-MED", "LOW-HIGH"].map(key => (
                            <div key={key} onClick={() => setSelectedCell({id: key, list: matrixData[key], color: getCellColor(key)})}
                                 className={`rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all hover:scale-105 group ${getCellColor(key)} ${selectedCell?.id === key ? 'ring-4 ring-offset-2 ring-slate-300 scale-105 z-10' : 'opacity-90 hover:opacity-100'}`}>
                                <span className="text-lg font-bold drop-shadow-sm">{matrixData[key].length}</span>
                            </div>
                        ))}
                    </div>

                    {/* X-Axis Label */}
                    <div className="absolute left-8 right-0 bottom-0 h-6 flex items-center justify-center gap-12 text-[9px] font-black text-slate-400 uppercase tracking-widest pt-2">
                        <span className="flex-1 text-center">Stabil</span>
                        <span className="flex-1 text-center">Perlahan</span>
                        <span className="flex-1 text-center text-red-400">Masalah</span>
                    </div>
                </div>
            </div>

            {/* KANAN: DETAIL PANEL */}
            <div className="w-full md:w-80 bg-slate-50 rounded-2xl p-4 border border-slate-100 flex flex-col h-80">
                <div className="mb-3 pb-2 border-b border-slate-200">
                    <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Perincian Zon</h4>
                    {selectedCell ? (
                        <div className={`mt-1 text-xs font-black px-2 py-1 rounded w-fit uppercase ${selectedCell.color.replace('hover:opacity-100','').replace('opacity-90','')}`}>
                            {getCellLabel(selectedCell.id)} ({selectedCell.list.length})
                        </div>
                    ) : (
                        <div className="mt-1 text-xs font-bold text-slate-400 italic">Pilih kotak untuk lihat senarai</div>
                    )}
                </div>

                <div className="flex-1 overflow-y-auto custom-scroll pr-1 space-y-2">
                    {selectedCell && selectedCell.list.length > 0 ? (
                        selectedCell.list.map((p, i) => (
                            <div key={i} className="bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group">
                                <div className="text-[10px] font-bold text-slate-700 leading-tight group-hover:text-indigo-600 line-clamp-2 mb-1">{p.name}</div>
                                <div className="flex justify-between items-center">
                                    <span className="text-[9px] font-mono font-black text-slate-400 bg-slate-100 px-1.5 rounded">{fmtMoney(p.kos)}</span>
                                    {p.gap > 0 ? (
                                        <span className="text-[8px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded border border-red-100">-{Math.round(p.gap)}%</span>
                                    ) : (
                                        <span className="text-[8px] font-bold text-emerald-500 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">OK</span>
                                    )}
                                </div>
                                <div className="text-[8px] text-slate-400 mt-1 truncate">PIC: {p.pic}</div>
                            </div>
                        ))
                    ) : (
                        <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-50">
                            <svg className="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                            <span className="text-[10px] uppercase font-bold text-center">Klik pada grid<br/>untuk data</span>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

// --- 7. KOMPONEN: GAMIFICATION SECTION (FINAL: ANIMATED + SHIMMER + FORENSIK) ---

// A. Komponen Kecil: Animasi Nombor (Rolling Number)
const CountUp = ({ end, duration = 2000, prefix = "", suffix = "" }) => {
    const [count, setCount] = React.useState(0);

    React.useEffect(() => {
        let startTime = null;
        let animationFrameId; // Simpan ID animation frame

        const start = 0;
        
        const step = (timestamp) => {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            // Easing function (easeOutExpo) supaya gerak laju kemudian slow
            const easeValue = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
            
            setCount(Math.floor(easeValue * (end - start) + start));

            if (progress < 1) {
                animationFrameId = window.requestAnimationFrame(step);
            }
        };
        
        animationFrameId = window.requestAnimationFrame(step);

        // CLEANUP FUNCTION: Batalkan animation frame bila unmount
        return () => {
            if (animationFrameId) {
                window.cancelAnimationFrame(animationFrameId);
            }
        };
    }, [end, duration]);

    return <span>{prefix}{count.toLocaleString()}{suffix}</span>;
};

// --- 7. KOMPONEN: GAMIFICATION SECTION (ICON LAPTOP KECIL + LOGIK FORENSIK) ---

const GamificationSection = ({ data, selectedYear }) => {

    // A. Komponen Animasi Nombor
    const CountUp = ({ end, duration = 2000 }) => {
        const [count, setCount] = useState(0);

        useEffect(() => {
            let startTime = null;
            let animationFrameId; // Simpan ID
            const start = 0;

            const step = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const easeValue = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                setCount(Math.floor(easeValue * (end - start) + start));
                if (progress < 1) {
                    animationFrameId = window.requestAnimationFrame(step);
                }
            };
            
            animationFrameId = window.requestAnimationFrame(step);

            // Cleanup
            return () => {
                window.cancelAnimationFrame(animationFrameId);
            };
        }, [end, duration]);

        return <span>{count.toLocaleString()}</span>;
    };

    // B. Logik Utama
    const officerStats = useMemo(() => {
        if (!data || !Array.isArray(data)) return [];

        const stats = {};

        const cleanMoney = (val) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            return parseFloat(val.toString().replace(/,/g, '')) || 0;
        };

        const parseDateLocal = (d) => {
            if (!d) return null;
            const p = d.split('/');
            return p.length === 3 ? new Date(p[2], p[1]-1, p[0]) : null;
        };

        const getDelayDays = (actualStr, targetStr) => {
            const actual = parseDateLocal(actualStr);
            const target = parseDateLocal(targetStr);
            if (!actual || !target) return 0;
            const diffTime = actual.getTime() - target.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

        const targetYear = selectedYear ? String(selectedYear) : "All";

        data.forEach((r) => {
            const projectYear = r["TAHUN RANCANG"] ? String(r["TAHUN RANCANG"]).trim() : "";
            if (targetYear !== "All" && projectYear !== targetYear) return; 

            const cat = (r["KATEGORI PERKHIDMATAN"] || "").toUpperCase();
            const isTargetCategory = cat.includes("PEMBANGUNAN") || cat.includes("PENAMBAHBAIKAN") || cat.includes("BINA");
            if (!isTargetCategory) return;

            const rawNames = r["PEGAWAI BERTANGGUNGJAWAB"] || "";
            if (!rawNames || rawNames === "-") return;
            
            const names = rawNames.split(",").map(n => n.trim());

            names.forEach(name => {
                if (!stats[name]) {
                    stats[name] = { 
                        name: name,
                        totalPlanned: 0, 
                        totalStarted: 0,
                        weightedScoreSum: 0, 
                        totalValue: 0, 
                        healthVarianceSum: 0,
                        completedProjects: 0,
                        projects: [] 
                    };
                }

                stats[name].totalPlanned++;
                const projectCost = cleanMoney(r.KOS_AKHIR || r.JUMLAH);
                const effectiveCost = projectCost > 0 ? projectCost : 0;
                
                let hasStarted = false;
                let projectHealthPoints = 0; 
                let statusLabel = "Belum Mula"; 

                // LOGIK FORENSIK
                if (r["TARIKH MULA"] && r["TARIKH MULA"] !== "-" && r["TARIKH MULA"].trim() !== "") {
                    stats[name].totalStarted++;
                    hasStarted = true;
                    projectHealthPoints = 100; 

                    const sdlc = r.sdlc || {};
                    const today = new Date();
                    const dEnd = parseDateLocal(r["EOT"] || r["TARIKH SIAP"]);
                    const dActualFinish = parseDateLocal(r["TARIKH SELESAI"]);

                    if (dActualFinish) {
                        stats[name].completedProjects++;
                        const finishDelay = getDelayDays(r["TARIKH SELESAI"], r["EOT"] || r["TARIKH SIAP"]);
                        if (finishDelay > 0) {
                            projectHealthPoints -= 15; 
                            statusLabel = `SIAP LEWAT ${finishDelay} HARI`;
                            stats[name].healthVarianceSum += 50; 
                        } else {
                            statusLabel = "SIAP CEMERLANG";
                            stats[name].healthVarianceSum += 100; 
                        }
                    } else if (dEnd && today > dEnd) {
                        projectHealthPoints = 40; 
                        statusLabel = "OVERRUN";
                        stats[name].healthVarianceSum -= 50; 
                    } else {
                        statusLabel = "ON-TRACK";
                        let penalty = 0;

                        const targetURS = sdlc["TARIKH URS BARU"] || sdlc["TARIKH URS ASAL"];
                        if (targetURS) {
                            if (sdlc["TARIKH URS SEBENAR"]) {
                                if (getDelayDays(sdlc["TARIKH URS SEBENAR"], targetURS) > 0) {
                                    penalty += 10;
                                    statusLabel = "ISU: URS LEWAT";
                                }
                            } else {
                                const dTarget = parseDateLocal(targetURS);
                                if (dTarget && today > dTarget) {
                                    penalty += 20;
                                    statusLabel = "LEWAT URS";
                                }
                            }
                        }

                        const targetUAT = sdlc["TARIKH UAT BARU"] || sdlc["TARIKH UAT ASAL"];
                        if (targetUAT) {
                            if (sdlc["TARIKH UAT SEBENAR"]) {
                                if (getDelayDays(sdlc["TARIKH UAT SEBENAR"], targetUAT) > 0) {
                                    penalty += 10;
                                    if(!statusLabel.includes("URS")) statusLabel = "ISU: UAT LEWAT";
                                }
                            } else {
                                const dTarget = parseDateLocal(targetUAT);
                                if (dTarget && today > dTarget) {
                                    penalty += 20;
                                    statusLabel = "LEWAT UAT";
                                }
                            }
                        }

                        projectHealthPoints -= penalty;
                        if (projectHealthPoints < 0) projectHealthPoints = 0;
                        
                        if (projectHealthPoints >= 90) stats[name].healthVarianceSum += 100;
                        else if (projectHealthPoints >= 50) stats[name].healthVarianceSum += 50;
                        else stats[name].healthVarianceSum -= 20;
                    }
                }

                stats[name].weightedScoreSum += (projectHealthPoints * effectiveCost);
                stats[name].totalValue += effectiveCost;

                stats[name].projects.push({ 
                    title: r.NAMA_PAPARAN, 
                    started: hasStarted,
                    statusLabel: statusLabel,
                    healthPoints: projectHealthPoints, 
                    kos: cleanMoney(r.KOS_AKHIR || r.JUMLAH)
                });
            });
        });

        return Object.values(stats).map(officer => {
            let finalPercentage = 0;
            if (officer.totalValue > 0) {
                finalPercentage = (officer.weightedScoreSum / officer.totalValue); 
            }

            const avgHealth = officer.totalStarted > 0 ? (officer.healthVarianceSum / officer.totalStarted) : 0;
            let heartClass = "text-emerald-500 animate-heartbeat";
            let heartLabel = "SIHAT";
            
            if (officer.totalStarted === 0) {
                heartClass = "text-slate-300"; heartLabel = "MENUNGGU";
            } else if (avgHealth < 0) {
                heartClass = "text-red-600 animate-heartbeat-fast"; heartLabel = "KRITIKAL";
            } else if (avgHealth < 50) {
                heartClass = "text-amber-500 animate-heartbeat"; heartLabel = "LEWAT";
            }

            let tierTitle = "HARAPAN"; let tierSub = "PERLU PANTAUAN"; 
            let rankColor = "bg-slate-400"; 
            let badgeColor = "bg-slate-100 text-slate-600 border-slate-300";
            
            if (finalPercentage >= 90) {
                tierTitle = "CEMERLANG"; tierSub = "PENERAJU"; rankColor = "bg-emerald-600"; badgeColor = "bg-emerald-100 text-emerald-800 border-emerald-300 ring-1 ring-emerald-300";
            } else if (finalPercentage >= 75) {
                tierTitle = "BAIK"; tierSub = "KONSISTEN"; rankColor = "bg-indigo-600"; badgeColor = "bg-indigo-50 text-indigo-800 border-indigo-300 ring-1 ring-indigo-300";
            } else if (finalPercentage >= 60) {
                tierTitle = "MEMUASKAN"; tierSub = "USAHA LAGI"; rankColor = "bg-amber-500"; badgeColor = "bg-amber-50 text-amber-800 border-amber-300";
            }

            return { ...officer, percentage: Math.round(finalPercentage), avgHealth, heartClass, heartLabel, tierTitle, tierSub, rankColor, badgeColor };
        })
        .sort((a, b) => b.percentage - a.percentage); 

    }, [data, selectedYear]);

    const top3 = officerStats.slice(0, 3);
    const others = officerStats.slice(3);
    const formatMoney = (val) => val.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const getRankStyle = (index) => { 
        if (index === 0) return "bg-white border-t-8 border-emerald-500 shadow-[0_20px_50px_-12px_rgba(16,185,129,0.3)] scale-[1.02] z-10 ring-1 ring-emerald-100 relative overflow-hidden before:absolute before:inset-0 before:-translate-x-full before:animate-[shimmer_2s_infinite] before:bg-gradient-to-r before:from-transparent before:via-white/40 before:to-transparent before:z-0"; 
        if (index === 1) return "bg-white border-t-8 border-indigo-500 shadow-[0_20px_50px_-12px_rgba(99,102,241,0.3)]"; 
        if (index === 2) return "bg-white border-t-8 border-amber-400 shadow-[0_20px_50px_-12px_rgba(245,158,11,0.3)]"; 
        return "bg-slate-50 border border-slate-200"; 
    };
    
    // --- UBAH DI SINI: SIZE TUKAR KE 'text-3xl' (Lebih Kecil) ---
    const getMedal = (index) => { 
        return <span className="text-3xl filter drop-shadow-md cursor-default">ðŸ’»</span>; 
    };

    if (top3.length === 0) return null;

    return (
        <div className="space-y-8 mb-10 font-sans">
            <style>{`@keyframes shimmer { 100% { transform: translateX(100%); } }`}</style>

            {/* HEADER BANNER */}
            <div className="relative rounded-2xl p-6 bg-gradient-to-r from-slate-900 to-indigo-900 text-white shadow-xl overflow-hidden group">
                <div className="absolute right-0 top-0 h-full w-1/2 bg-white/5 skew-x-12 transform origin-bottom-left transition-transform duration-1000 group-hover:skew-x-0"></div>
                <div className="relative z-10 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-white/10 rounded-xl backdrop-blur-sm border border-white/20 shadow-inner">
                            <svg className="w-8 h-8 text-emerald-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        </div>
                        <div>
                            <h2 className="text-2xl font-black uppercase tracking-tight">Prestasi Pegawai Projek</h2>
                            <p className="text-sm text-indigo-200 font-medium">Analisis KPI Sebenar (Kualiti & Kuantiti) {selectedYear === "All" ? "" : selectedYear}</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* TOP 3 CARDS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                {top3.map((officer, index) => (
                    <div key={index} className={`relative group rounded-3xl p-6 transition-all duration-300 flex flex-col justify-between ${getRankStyle(index)}`}>
                        {/* Header */}
                        <div className="flex justify-between items-start mb-6 relative z-10">
                            <div className="flex items-center gap-4 w-full">
                                <div className={`w-16 h-16 rounded-2xl flex items-center justify-center text-2xl font-bold text-white shadow-md ${officer.rankColor} relative flex-shrink-0`}>
                                    {officer.name.charAt(0)}
                                    <div className="absolute -bottom-2 -right-2 bg-white rounded-full p-1 shadow border border-slate-100">
                                        <svg className={`w-4 h-4 ${officer.heartClass}`} fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    </div>
                                </div>
                                <div className="min-w-0 flex-1">
                                    <h3 className="font-black text-slate-800 text-sm leading-tight uppercase w-full break-words mb-1">
                                        {officer.name}
                                    </h3>
                                    <div className={`inline-block px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wide border ${officer.badgeColor}`}>
                                        {officer.tierTitle}
                                    </div>
                                </div>
                            </div>
                            {/* IKON LAPTOP (KECIL) */}
                            <div className="absolute top-6 right-6">{getMedal(index)}</div>
                        </div>

                        {/* SKOR */}
                        <div className="text-center py-5 border-t border-b border-slate-100 bg-slate-50/50 rounded-xl mb-5 group-hover:bg-slate-100 transition-colors relative z-10">
                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.25em] mb-1">Indeks Prestasi KPI</div>
                            <div className="flex items-center justify-center gap-1">
                                <span className="text-6xl font-black text-slate-800 tracking-tighter drop-shadow-sm group-hover:text-indigo-700 transition-colors leading-none">
                                    <CountUp end={officer.percentage} />
                                </span>
                                <span className="text-xl font-black text-slate-400 mt-4">%</span>
                            </div>
                            <div className="text-xs font-bold text-slate-500 mt-2 bg-white px-3 py-1 rounded-full border border-slate-200 inline-block shadow-sm">
                                {officer.totalStarted} Projek Aktif
                            </div>
                        </div>

                        {/* INFO BAWAH */}
                        <div className="flex items-center justify-between gap-2 mb-2 relative z-10">
                            <div className="p-2 w-full bg-slate-50 rounded-lg border border-slate-100 text-center">
                                <div className="text-[8px] font-bold text-slate-400 uppercase">Nilai Portfolio</div>
                                <div className="text-xs font-black text-slate-700">RM {formatMoney(officer.totalValue)}</div>
                            </div>
                        </div>

                        {/* DNA HOVER */}
                        <div className="absolute inset-0 bg-white/95 backdrop-blur-xl rounded-3xl p-5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20 flex flex-col border-2 border-indigo-100 shadow-2xl translate-y-4 group-hover:translate-y-0 pointer-events-none group-hover:pointer-events-auto">
                            <div className="flex items-center justify-between mb-3 pb-2 border-b border-slate-100">
                                <h4 className="font-black text-slate-800 text-[10px] uppercase tracking-widest">DNA PRESTASI</h4>
                                <div className="px-2 py-0.5 bg-indigo-50 rounded text-[9px] font-bold text-indigo-600">{officer.percentage} Markah</div>
                            </div>
                            <div className="space-y-2 overflow-y-auto custom-scroll flex-1">
                                {officer.projects.map((p, i) => (
                                    <div key={i} className="bg-slate-50 rounded-lg p-2.5 border border-slate-200">
                                        <div className="flex justify-between items-start">
                                            <div className="w-[65%]">
                                                <div className="font-bold text-slate-700 text-[9px] leading-tight line-clamp-2">{p.title}</div>
                                                <div className="text-[8px] text-slate-400 mt-0.5 font-mono">RM {formatMoney(p.kos)}</div>
                                            </div>
                                            <div className="text-right w-[35%]">
                                                <span className={`block text-[9px] font-black ${p.healthPoints >= 90 ? 'text-emerald-600' : p.healthPoints >= 50 ? 'text-amber-600' : 'text-red-600'}`}>
                                                    {p.healthPoints} Mata
                                                </span>
                                                <span className="text-[7px] text-slate-400 uppercase font-bold truncate block">{p.statusLabel}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* SENARAI OTHERS */}
            {others.length > 0 && (
                <div className="mt-6 bg-white/50 rounded-2xl p-4 border border-dashed border-slate-300">
                    <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3">Senarai Lain</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {others.map((off, idx) => (
                            <div key={idx} className="bg-white p-3 rounded-xl border border-slate-200 flex items-center justify-between shadow-sm">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">#{idx + 4}</div>
                                    <div className="min-w-0">
                                        <div className="text-[10px] font-black text-slate-700 uppercase truncate w-32">{off.name}</div>
                                        <div className="text-[9px] text-slate-400 mt-0.5">{off.totalStarted} / {off.totalPlanned} Projek</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs font-black text-indigo-600">{Math.round(off.percentage)}%</span>
                                    <svg className={`w-3 h-3 ${off.heartClass}`} fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- KOMPONEN BARU: SMART ASSISTANT (AI RINGKASAN) ---
const SmartAssistantWidget = ({ data, onAction }) => {
    const [insights, setInsights] = useState([]);
    const [currentInsightIndex, setCurrentInsightIndex] = useState(0);

    // 1. ENJIN AI (RULE-BASED ANALYSIS)
    useEffect(() => {
        const generateInsights = () => {
            const list = [];
            const today = new Date();
            today.setHours(0,0,0,0);

            // ANALISIS 1: PROJEK KRITIKAL (OVERRUN)
            const overrunProjects = data.filter(p => {
                if (p.LOGIK_SIAP === 'Siap (CPC)' || p.LOGIK_SIAP === 'Batal') return false;
                const dEnd = p["EOT"] ? parseDate(p["EOT"]) : (p["TARIKH SIAP"] ? parseDate(p["TARIKH SIAP"]) : null);
                return dEnd && today > dEnd;
            });

            if (overrunProjects.length > 0) {
                list.push({
                    type: "CRITICAL",
                    icon: "ðŸš¨",
                    title: "Amaran Kritikal",
                    message: `Terdapat ${overrunProjects.length} projek yang telah melepasi tarikh siap (Overrun). Sila semak status EOT atau CPC segera.`,
                    action: "Lihat Senarai Lewat"
                });
            }

            // ANALISIS 2: KEWANGAN (BAKI KOMITMEN TINGGI)
            const totalKos = data.reduce((acc, p) => acc + parseVal(p.KOS_AKHIR || 0), 0);
            const totalBayar = data.reduce((acc, p) => acc + parseVal(p.JUMLAH_BAYARAN || 0), 0);
            const baki = totalKos - totalBayar;
            const burnRate = totalKos > 0 ? (totalBayar / totalKos) * 100 : 0;

            if (burnRate < 50 && totalKos > 1000000) { // Contoh logic: Bajet besar tapi spend sikit
                list.push({
                    type: "FINANCE",
                    icon: "ðŸ’°",
                    title: "Prestasi Belanja Rendah",
                    message: `Kadar perbelanjaan keseluruhan baru mencapai ${Math.round(burnRate)}%. Baki komitmen RM ${(baki/1000000).toFixed(2)} Juta perlu dibelanjakan.`,
                    action: "Analisis Cashflow"
                });
            }

            // ANALISIS 3: TAMAT TEMPOH TERDEKAT (30 HARI)
            const expiringSoon = data.filter(p => {
                if (p.LOGIK_SIAP !== 'Dalam Jadual') return false;
                const dEnd = p["EOT"] ? parseDate(p["EOT"]) : (p["TARIKH SIAP"] ? parseDate(p["TARIKH SIAP"]) : null);
                if (!dEnd) return false;
                const diffTime = dEnd - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 30;
            });

            if (expiringSoon.length > 0) {
                list.push({
                    type: "WARNING",
                    icon: "â³",
                    title: "Tamat Tempoh Terdekat",
                    message: `${expiringSoon.length} projek akan tamat kontrak dalam masa 30 hari. Pastikan proses UAT/CPC sedang berjalan.`,
                    action: "Lihat Kalendar"
                });
            }

            // ANALISIS 4: EOT TINGGI
            const eotProjects = data.filter(p => p["EOT"] && p["EOT"] !== "");
            if (eotProjects.length > 5) { // Contoh threshold
                 list.push({
                    type: "INFO",
                    icon: "ðŸ“",
                    title: "Trend EOT",
                    message: `Sebanyak ${eotProjects.length} projek telah diluluskan EOT tahun ini. Semak punca kelewatan utama.`,
                    action: "Semak Laporan"
                });
            }

            // DEFAULT: JIKA SEMUA OK
            if (list.length === 0) {
                list.push({
                    type: "SUCCESS",
                    icon: "âœ…",
                    title: "Semua Terkawal",
                    message: "Tiada isu kritikal dikesan buat masa ini. Teruskan prestasi cemerlang!",
                    action: null
                });
            }

            setInsights(list);
        };

        generateInsights();
    }, [data]);

    // Helper Date Parser (Sama macam main component)
    const parseDate = (str) => {
        if (!str) return null;
        const p = str.split('/');
        return new Date(p[2], p[1] - 1, p[0]);
    };
    const parseVal = (val) => val ? parseFloat(val.toString().replace(/,/g, "")) : 0;

    // Auto Rotate Insights
    useEffect(() => {
        if (insights.length <= 1) return;
        const interval = setInterval(() => {
            setCurrentInsightIndex((prev) => (prev + 1) % insights.length);
        }, 5000); // Tukar setiap 5 saat
        return () => clearInterval(interval);
    }, [insights]);

    if (insights.length === 0) return null;

    const activeInsight = insights[currentInsightIndex];

    const getStyle = (type) => {
        switch(type) {
            case "CRITICAL": return "bg-red-50 border-red-200 text-red-800";
            case "WARNING": return "bg-amber-50 border-amber-200 text-amber-800";
            case "FINANCE": return "bg-blue-50 border-blue-200 text-blue-800";
            case "SUCCESS": return "bg-emerald-50 border-emerald-200 text-emerald-800";
            default: return "bg-slate-50 border-slate-200 text-slate-800";
        }
    };

    return (
        <div className="mb-8 animate-fade-in">
            {/* AI HEADER */}
            <div className="flex items-center gap-2 mb-2 px-1">
                <span className="relative flex h-3 w-3">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                </span>
                <span className="text-[10px] font-black text-indigo-500 uppercase tracking-widest">AI Smart Summary</span>
            </div>

            {/* MESSAGE CARD */}
            <div className={`relative p-4 rounded-2xl border-2 shadow-sm transition-all duration-500 flex items-start gap-4 ${getStyle(activeInsight.type)}`}>
                
                {/* ICON */}
                <div className="text-3xl filter drop-shadow-sm animate-bounce-slow">
                    {activeInsight.icon}
                </div>

                {/* TEXT CONTENT */}
                <div className="flex-1">
                    <h4 className="text-sm font-black uppercase tracking-tight mb-1">{activeInsight.title}</h4>
                    <p className="text-xs font-medium opacity-90 leading-relaxed">
                        {activeInsight.message}
                    </p>
                </div>

                {/* ACTION BUTTON (JIKA ADA) */}
                {activeInsight.action && (
                    <button
                    onClick={() => onAction && onAction(activeInsight.action)}
                    className="hidden sm:block px-4 py-2 bg-white/50 hover:bg-white border border-black/5 rounded-xl text-[10px] font-black uppercase tracking-wider transition-all shadow-sm hover:shadow-md whitespace-nowrap">
                        {activeInsight.action} â†’
                    </button>
                )}

                {/* PAGINATION DOTS */}
                <div className="absolute bottom-2 right-4 flex gap-1">
                    {insights.map((_, i) => (
                        <div 
                            key={i} 
                            className={`w-1.5 h-1.5 rounded-full transition-all ${i === currentInsightIndex ? 'bg-black/40 scale-125' : 'bg-black/10'}`}
                        ></div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- KOMPONEN BARU: MODAL PERINCIAN PROJEK (GLOBAL PORTAL) ---
const ProjectDetailModal = ({ project, onClose }) => {
    // Hooks
    const [activeTab, setActiveTab] = useState('kronologi');

    if (!project) return null;

    // Helper Format RM
    const fmtRM = (val) => "RM " + parseFloat(val || 0).toLocaleString("en-MY", { minimumFractionDigits: 2 });

    // --- FUNGSI CETAK (KEKAL SAMA) ---
    const handlePrintProfile = () => {
        const namaProjek = project.NAMA_PAPARAN || "Tiada Nama";
        const noSebutHarga = project["NO SEBUT HARGA"] || "TIADA RUJUKAN";
        const syarikat = project["SYARIKAT"] || "-";
        const kos = fmtRM(project.KOS_AKHIR || project.JUMLAH);
        const mula = project["TARIKH MULA"] || "-";
        const siap = project["EOT"] || project["TARIKH SIAP"] || "-";
        const status = project.LOGIK_SIAP || "Status Tidak Diketahui";
        
        const totalBayarVal = project.financials ? project.financials.reduce((acc, curr) => acc + (parseFloat(curr.JUMLAH)||0) + (parseFloat(curr.SST)||0), 0) : 0;
        const totalBayarStr = fmtRM(totalBayarVal);
        const bakiStr = fmtRM((parseFloat(project.KOS_AKHIR || 0) - totalBayarVal));
        const percentagePaid = (totalBayarVal / (parseFloat(project.KOS_AKHIR) || 1)) * 100;

        let paymentRows = "";
        if (project.financials && project.financials.length > 0) {
            paymentRows = project.financials.map(f => {
                const jum = fmtRM((parseFloat(f.JUMLAH)||0) + (parseFloat(f.SST)||0));
                return '<tr class="border-b border-slate-100"><td class="px-3 py-2 font-mono">' + (f["TARIKH PERAKUAN"] || "-") + '</td><td class="px-3 py-2 font-bold">' + (f["PERKARA"] || "-") + '</td><td class="px-3 py-2 text-right font-mono font-bold">' + jum + '</td></tr>';
            }).join('');
        } else {
            paymentRows = '<tr><td colspan="3" class="p-3 text-center italic text-slate-400">Tiada rekod bayaran.</td></tr>';
        }

        let noteRows = "";
        if (project.notes && project.notes.length > 0) {
            noteRows = project.notes.sort((a,b) => (b.TIMESTAMP||"").localeCompare(a.TIMESTAMP||"")).slice(0, 5).map(n => {
                return '<div class="flex gap-3 mb-3 pb-3 border-b border-slate-50 last:border-0"><div class="w-24 text-[10px] font-bold text-slate-400 font-mono pt-1">' + (n.TIMESTAMP || "-") + '</div><div class="flex-1"><div class="text-xs font-bold text-slate-800">' + (n.PERKARA || "Catatan") + '</div><div class="text-[10px] text-slate-600 mt-0.5 leading-relaxed">' + (n.CATATAN || "-") + '</div></div></div>';
            }).join('');
        } else {
            noteRows = '<div class="text-center italic text-xs text-slate-400">Tiada catatan direkodkan.</div>';
        }

        const printWindow = window.open('', '_blank');
        if (!printWindow) { alert("Sila benarkan 'Pop-up' di browser anda untuk mencetak."); return; }

        const htmlContent = '<html><head><title>Profil Projek: ' + noSebutHarga + '</title>' +
            '<script src="https://cdn.tailwindcss.com"><\/script>' +
            '<style>@import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"); body { font-family: "Plus Jakarta Sans", sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; } @page { size: A4; margin: 10mm; }</style>' +
            '</head><body class="bg-white p-8 text-slate-800">' +
            '<div class="border-b-2 border-slate-800 pb-4 mb-6 flex justify-between items-end"><div class="w-3/4"><div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Profil Projek BPM</div><h1 class="text-2xl font-black uppercase leading-tight">' + namaProjek + '</h1></div><div class="text-right w-1/4"><div class="text-sm font-bold bg-slate-100 px-3 py-1 rounded border border-slate-200 inline-block">' + noSebutHarga + '</div><div class="text-xs text-slate-500 mt-1 font-bold uppercase tracking-wider">' + status + '</div></div></div>' +
            '<div class="grid grid-cols-2 gap-8 mb-8"><div class="space-y-4"><h3 class="text-xs font-black text-slate-400 uppercase border-b border-slate-200 pb-1">Maklumat Kontrak</h3><div class="text-sm space-y-2"><div class="grid grid-cols-3"><span class="text-slate-500 font-bold">Pelaksana:</span><span class="col-span-2 font-bold">' + syarikat + '</span></div><div class="grid grid-cols-3"><span class="text-slate-500 font-bold">Kos Akhir:</span><span class="col-span-2 font-mono font-black text-slate-800">' + kos + '</span></div><div class="grid grid-cols-3"><span class="text-slate-500 font-bold">Mula:</span><span class="col-span-2 font-mono">' + mula + '</span></div><div class="grid grid-cols-3"><span class="text-slate-500 font-bold">Siap:</span><span class="col-span-2 font-mono">' + siap + '</span></div></div></div><div class="space-y-4"><h3 class="text-xs font-black text-slate-400 uppercase border-b border-slate-200 pb-1">Status Kewangan</h3><div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">Jumlah Bayaran</span><span class="text-sm font-black font-mono text-emerald-600">' + totalBayarStr + '</span></div><div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden mb-2"><div class="bg-emerald-500 h-full" style="width: ' + percentagePaid + '%"></div></div><div class="flex justify-between pt-2 border-t border-slate-200"><span class="text-xs font-bold text-slate-500">Baki Kontrak</span><span class="text-sm font-black font-mono text-slate-700">' + bakiStr + '</span></div></div></div></div>' +
            '<div class="mb-8"><h3 class="text-xs font-black text-slate-400 uppercase border-b border-slate-200 pb-2 mb-3">Rekod Pembayaran</h3><table class="w-full text-xs text-left border-collapse"><thead class="bg-slate-100 uppercase text-slate-500 font-bold"><tr><th class="px-3 py-2 rounded-l">Tarikh</th><th class="px-3 py-2">Perkara</th><th class="px-3 py-2 text-right rounded-r">Jumlah</th></tr></thead><tbody>' + paymentRows + '</tbody></table></div>' +
            '<div class="mb-8"><h3 class="text-xs font-black text-slate-400 uppercase border-b border-slate-200 pb-2 mb-3">Isu & Catatan Terkini</h3><div>' + noteRows + '</div></div>' +
            '<div class="fixed bottom-0 left-0 right-0 text-center border-t border-slate-200 pt-4"><p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Dicetak daripada BPM Smart Dashboard pada ' + new Date().toLocaleDateString() + '</p></div>' +
            '<script>window.onload = function() { setTimeout(function() { window.print(); }, 800); }<\/script>' +
            '</body></html>';

        printWindow.document.write(htmlContent);
        printWindow.document.close();
    };

    // --- TEKNIK REACT PORTAL ---
    // Ini akan menghantar JSX di bawah terus ke <div id="modal-root">
    return ReactDOM.createPortal(
        <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
            {/* Modal Container */}
            <div className="bg-white w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col border border-slate-200">
                
                {/* HEADER */}
                <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50/50">
                    <div>
                        <div className="flex items-center gap-2 mb-2">
                            <span className="text-[10px] font-black uppercase tracking-widest text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">
                                {project["NO SEBUT HARGA"] || "TIADA RUJUKAN"}
                            </span>
                            <span className="text-[10px] font-bold text-slate-400 uppercase bg-white px-2 py-0.5 rounded border border-slate-200">
                                {project.TAHUN_RANCANG || "2025"}
                            </span>
                        </div>
                        <h2 className="text-xl md:text-2xl font-black text-slate-800 leading-tight">{project.NAMA_PAPARAN}</h2>
                        <div className="flex items-center gap-2 mt-2 text-xs font-bold text-slate-500">
                            <span>ðŸ¢ {project["SYARIKAT"] || "Tiada Syarikat"}</span>
                            <span>â€¢</span>
                            <span>ðŸ’° {fmtRM(project.KOS_AKHIR)}</span>
                        </div>
                    </div>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 text-slate-400 hover:text-red-500 transition-colors">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                {/* TABS NAVIGATION */}
                <div className="flex border-b border-slate-100 px-6">
                    {['kronologi', 'kewangan', 'info'].map(tab => (
                        <button 
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-4 py-3 text-xs font-black uppercase tracking-wider border-b-2 transition-colors ${activeTab === tab ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                        >
                            {tab === 'kronologi' ? 'ðŸ“œ Kronologi & Catatan' : tab === 'kewangan' ? 'ðŸ’¸ Rekod Bayaran' : 'â„¹ï¸ Info Pasukan'}
                        </button>
                    ))}
                </div>

                {/* CONTENT AREA (Scrollable) */}
                <div className="flex-1 overflow-y-auto p-6 bg-slate-50/30">
                    
                    {/* TAB: KRONOLOGI */}
                    {activeTab === 'kronologi' && (
                        <div className="space-y-6">
                            {project.notes && project.notes.length > 0 ? (
                                project.notes.sort((a,b) => (b.TIMESTAMP || "").localeCompare(a.TIMESTAMP || "")).map((note, idx) => (
                                    <div key={idx} className="flex gap-4 group">
                                        <div className="flex flex-col items-center">
                                            <div className="w-2.5 h-2.5 rounded-full bg-indigo-400 ring-4 ring-indigo-50 mb-1"></div>
                                            <div className="w-0.5 flex-1 bg-slate-200 group-last:hidden"></div>
                                        </div>
                                        <div className="flex-1 pb-6">
                                            <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase">{note.TIMESTAMP}</span>
                                                    {note.PERKARA && <span className="text-[10px] font-black bg-slate-100 px-2 py-0.5 rounded text-slate-600">{note.PERKARA}</span>}
                                                </div>
                                                <p className="text-sm text-slate-700 whitespace-pre-line leading-relaxed">{note.CATATAN}</p>
                                                {note["RUJUKAN SURAT"] && (
                                                    <div className="mt-3 pt-2 border-t border-slate-50 flex items-center gap-2">
                                                        <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Rujukan:</span>
                                                        {note.SURAT_URL ? (
                                                            <a href={note.SURAT_URL} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-[10px] font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all group/link">
                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                                                                {note["RUJUKAN SURAT"]}
                                                            </a>
                                                        ) : (
                                                            <span className="text-[10px] font-mono font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">
                                                                {note["RUJUKAN SURAT"]}
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-10 text-slate-400 italic">Tiada catatan direkodkan.</div>
                            )}
                        </div>
                    )}

                    {/* TAB: KEWANGAN */}
                    {activeTab === 'kewangan' && (
                        <div>
                            <div className="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm mb-4">
                                <table className="w-full text-left">
                                    <thead className="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th className="px-4 py-3 text-[10px] font-black text-slate-500 uppercase">Tarikh</th>
                                            <th className="px-4 py-3 text-[10px] font-black text-slate-500 uppercase">Perkara</th>
                                            <th className="px-4 py-3 text-[10px] font-black text-slate-500 uppercase text-right">Jumlah (RM)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {project.financials && project.financials.length > 0 ? (
                                            project.financials.map((fin, idx) => (
                                                <tr key={idx} className="hover:bg-slate-50/50">
                                                    <td className="px-4 py-3 text-xs font-mono text-slate-500">{fin["TARIKH PERAKUAN"]}</td>
                                                    <td className="px-4 py-3 text-xs font-bold text-slate-700">{fin["PERKARA"]}</td>
                                                    <td className="px-4 py-3 text-xs font-mono font-bold text-emerald-600 text-right">
                                                        {(parseFloat(fin["JUMLAH"] || 0) + parseFloat(fin["SST"] || 0)).toLocaleString("en-MY", { minimumFractionDigits: 2 })}
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr><td colSpan="3" className="px-4 py-8 text-center text-xs text-slate-400 italic">Tiada rekod pembayaran.</td></tr>
                                        )}
                                    </tbody>
                                    <tfoot className="bg-slate-50 border-t border-slate-200">
                                        <tr>
                                            <td colSpan="2" className="px-4 py-3 text-xs font-black text-slate-600 text-right uppercase">Jumlah Bayaran Terkumpul</td>
                                            <td className="px-4 py-3 text-sm font-black text-indigo-600 text-right">
                                                {fmtRM(project.financials?.reduce((acc, curr) => acc + (parseFloat(curr.JUMLAH)||0) + (parseFloat(curr.SST)||0), 0))}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* TAB: INFO */}
                    {activeTab === 'info' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 border-b pb-2">Pegawai Bertanggungjawab</h4>
                                <div className="flex flex-col gap-2">
                                    {(project["PEGAWAI BERTANGGUNGJAWAB"] || "").split(',').map((name, i) => (
                                        <div key={i} className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-xs border border-slate-200">
                                                {name.trim().charAt(0)}
                                            </div>
                                            <span className="text-xs font-bold text-slate-700">{name.trim()}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 border-b pb-2">Butiran Kontrak</h4>
                                <div className="space-y-2">
                                    <div className="flex justify-between text-xs"><span className="text-slate-500">Tarikh Mula:</span> <span className="font-mono font-bold">{project["TARIKH MULA"]}</span></div>
                                    <div className="flex justify-between text-xs"><span className="text-slate-500">Tarikh Siap Asal:</span> <span className="font-mono font-bold">{project["TARIKH SIAP"]}</span></div>
                                    <div className="flex justify-between text-xs"><span className="text-slate-500">Tarikh Siap Semasa:</span> <span className="font-mono font-bold text-indigo-600">{project["TARIKH SIAP SEMASA_ISO"] ? new Date(project["TARIKH SIAP SEMASA_ISO"]).toLocaleDateString('en-GB') : "-"}</span></div>
                                    <div className="flex justify-between text-xs pt-2 border-t border-dashed mt-2"><span className="text-slate-500">Vot:</span> <span className="font-mono font-bold text-slate-700">{project.VOT_NAMA || project.VOT}</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                
                {/* FOOTER ACTIONS */}
                <div className="p-4 bg-slate-50 border-t border-slate-200 text-right flex justify-end gap-3">
                    
                    {/* BUTANG CETAK BARU */}
                    <button onClick={handlePrintProfile} className="flex items-center gap-2 px-5 py-2 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-700 hover:bg-slate-50 hover:text-blue-600 transition-colors shadow-sm">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        Cetak Profil
                    </button>

                    <button onClick={onClose} className="px-5 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 transition-colors shadow-sm">
                        Tutup
                    </button>
                </div>
            </div>
        </div>,
        document.getElementById('modal-root') // TARGET PORTAL DI SINI
    );
};

// --- 6. KOMPONEN: DEVELOPMENT PLANNING BOARD (LAYOUT GEMPAK: PIPELINE & ACTION) ---
const DevelopmentPlanningBoard = ({ data }) => {

    const currentYear = new Date().getFullYear().toString();
    const [selectedPlanYear, setSelectedPlanYear] = useState(currentYear);
    const [searchTerm, setSearchTerm] = useState("");
    const [selectedProject, setSelectedProject] = useState(null);

    // --- UTILITIES ---
    const getSmartYear = (project) => {
        if (!project) return "";
        const keys = Object.keys(project);
        const key = keys.find(k => k && k.toUpperCase().includes("TAHUN") && k.toUpperCase().includes("RANCANG"));
        return key ? project[key] : "";
    };

    const parseDate = (str) => {
        if (!str) return null;
        const p = str.split('/');
        if (p.length < 3) return null;
        return new Date(p[2], p[1] - 1, p[0]);
    };

    const calcDayDiff = (d1, d2) => {
        if (!d1 || !d2) return null;
        const diffTime = d2.getTime() - d1.getTime();
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    };

    const parseVal = (val) => val ? parseFloat(val.toString().replace(/,/g, "")) : 0;
    const fmtRM = (val) => "RM " + parseVal(val).toLocaleString("en-MY", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // --- DATA FILTERING ---
    const availableYears = useMemo(() => {
        const years = [...new Set(data.map(r => {
            const val = getSmartYear(r);
            return val ? val.toString().trim() : null;
        }).filter(Boolean))];
        return years.sort().reverse();
    }, [data]);

    const filteredDevProjects = useMemo(() => {
        return data.filter(r => {
            const rawYear = getSmartYear(r);
            const dataYear = rawYear ? rawYear.toString().trim() : "";
            const matchYear = dataYear === selectedPlanYear.toString();
            const cat = (r["KATEGORI PERKHIDMATAN"] || "").toUpperCase();
            
            const isDev = matchYear && (
                cat.includes("PEMBANGUNAN") || cat.includes("BINA") || cat.includes("SISTEM") || 
                cat.includes("PENAMBAHBAIKAN") || cat.includes("NAIK TARAF") || 
                cat.includes("MIGRASI") || cat.includes("INTEGRASI") || 
                cat.includes("CHANGE REQUEST") || cat.includes("CR")
            );

            if (!isDev) return false;

            if (searchTerm === "") return true;

            const term = searchTerm.toLowerCase();
            const textName = (r.NAMA_PAPARAN || "").toLowerCase();
            const textRef = (r["NO SEBUT HARGA"] || "").toLowerCase();
            const textComp = (r["SYARIKAT"] || "").toLowerCase(); // Carian nama syarikat juga!

            return textName.includes(term) || textRef.includes(term) || textComp.includes(term);
        });
    }, [data, selectedPlanYear, searchTerm]);

    const stats = useMemo(() => {
        const totalCount = filteredDevProjects.length;
        const totalValue = filteredDevProjects.reduce((acc, curr) => acc + (parseFloat(curr.KOS_AKHIR || 0) || 0), 0);
        return { totalCount, totalValue };
    }, [filteredDevProjects]);

    const buckets = {
        planning: filteredDevProjects.filter(r => (!r["TARIKH MULA"] || r["TARIKH MULA"] === "") && !r.LOGIK_SIAP.includes("Siap")),
        progress: filteredDevProjects.filter(r => (r["TARIKH MULA"] && r["TARIKH MULA"] !== "") && !r.LOGIK_SIAP.includes("Siap")),
        completed: filteredDevProjects.filter(r => r.LOGIK_SIAP.includes("Siap"))
    };

    // --- SUB-KOMPONEN: TIMELINE STEP ---
    const TimelineStep = ({ label, targetDate, actualDate, position, isRevised, extraInfo }) => {
        const tDate = parseDate(targetDate);
        const aDate = parseDate(actualDate);
        const today = new Date();

        let status = 'pending';
        let dotClass = 'bg-slate-200 border-slate-300';
        let labelClass = 'text-slate-400';
        let dateBg = 'bg-slate-50 text-slate-400 border-slate-100';
        
        let dayDiff = 0;
        let diffDisplay = null;

        if (aDate && tDate) dayDiff = calcDayDiff(tDate, aDate);
        else if (!aDate && tDate && tDate < today) dayDiff = calcDayDiff(tDate, today);

        if (aDate) {
            status = 'done';
            dotClass = 'bg-emerald-500 border-emerald-600 shadow-md shadow-emerald-200';
            labelClass = 'text-emerald-700 font-bold';
            dateBg = 'bg-emerald-50 text-emerald-700 font-bold border-emerald-100';
        } else if (tDate && tDate < today) {
            status = 'late';
            dotClass = 'bg-red-500 border-red-600 animate-pulse';
            labelClass = 'text-red-600 font-bold';
            dateBg = 'bg-red-50 text-red-600 font-bold border-red-100';
        } else if (tDate) {
            status = 'planned';
            dotClass = 'bg-indigo-500 border-indigo-600';
            labelClass = 'text-indigo-600 font-bold';
            dateBg = 'bg-indigo-50 text-indigo-600 font-bold border-indigo-100';
        }

        if (dayDiff > 0) diffDisplay = <span className="text-[9px] font-black text-red-600 bg-red-100 px-1.5 rounded ml-1">+{dayDiff} Hari</span>;
        else if (dayDiff < 0 && aDate) diffDisplay = <span className="text-[9px] font-black text-emerald-600 bg-emerald-100 px-1.5 rounded ml-1">{dayDiff} Hari</span>;

        return (
            <div className={`flex flex-col relative z-10 ${position} group/step`}>
                <div className={`w-4 h-4 rounded-full border-4 ${dotClass} mb-2 mx-auto transition-all duration-300 z-10 box-border`}></div>
                <div className="flex flex-col items-center">
                    <span className={`text-[11px] uppercase tracking-wider text-center leading-none mb-1.5 ${labelClass}`}>
                        {label} {isRevised && <span className="text-[8px] text-amber-600 bg-amber-100 px-1 rounded ml-0.5 border border-amber-200">PINDAAN</span>}
                    </span>
                    <div className={`px-2 py-1 rounded border text-[10px] font-mono shadow-sm flex items-center gap-1 ${dateBg}`}>
                        <span>{actualDate || targetDate || "-"}</span>
                    </div>
                    {diffDisplay && <div className="mt-1 transform origin-top">{diffDisplay}</div>}
                    {status !== 'done' && targetDate && <span className="text-[9px] text-slate-400 mt-0.5 italic">Sasaran: {targetDate}</span>}
                </div>
                {extraInfo && extraInfo.length > 0 && (
                    <div className="absolute top-14 w-full flex flex-col gap-1 items-center mt-1 opacity-90">
                        {extraInfo.map((info, idx) => (
                             info.date ? <span key={idx} className="text-[9px] font-bold uppercase bg-white text-slate-600 px-1.5 py-0.5 rounded border border-slate-200 shadow-sm whitespace-nowrap z-20">{info.label}: {info.date}</span> : null
                        ))}
                    </div>
                )}
            </div>
        );
    };

    const PlanningCard = ({ p }) => (
        <div className="bg-white p-3 rounded-lg border-l-4 border-slate-300 shadow-sm hover:shadow-md hover:border-slate-400 transition-all group h-full flex flex-col justify-between">
            <div>
                <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">{p["NO SEBUT HARGA"] || "DRAF"}</span>
                <h4 className="text-xs font-bold text-slate-700 leading-tight group-hover:text-slate-900 line-clamp-2" title={p.NAMA_PAPARAN}>{p.NAMA_PAPARAN}</h4>
            </div>
            <div className="mt-3 pt-2 border-t border-slate-100 flex justify-between items-end">
                 <span className="text-[9px] font-mono font-bold text-slate-500 bg-slate-50 px-1 rounded">{fmtRM(p["JUMLAH"])}</span>
                 <span className="text-[8px] font-black text-slate-300 uppercase">DALAM PERANCANGAN</span>
            </div>
        </div>
    );

    // --- KEMASKINI: PROJECT CARD DENGAN HEALTH INDICATOR ---
      const ProjectCard = ({ p, type, onClick }) => {
          
          // --- 1. DATA ASAS ---
          const tMula = p["TARIKH MULA"] || "-";
          const tSiapAsal = p["TARIKH SIAP"] || "-";
          const tEOT = p["EOT"] || null;
          const kosAkhir = p.KOS_AKHIR ? p.KOS_AKHIR : p["JUMLAH"];
          const voTambah = parseVal(p["VO TAMBAHAN"]);
          
          // --- 2. DATA TIMELINE & SDLC ---
          const sdlc = p.sdlc || {}; 
          
          const getTargetConfig = (dateBaru, dateAsal) => {
              if (dateBaru && dateBaru !== "-") return { date: dateBaru, type: "(BARU)" };
              return { date: dateAsal, type: "(ASAL)" };
          };

          const cfgURS = getTargetConfig(sdlc["TARIKH URS BARU"], sdlc["TARIKH URS ASAL"]);
          const cfgUAT = getTargetConfig(sdlc["TARIKH UAT BARU"] || sdlc["TARIK UAT BARU"], sdlc["TARIKH UAT ASAL"]);
          const cfgLive = getTargetConfig(sdlc["TARIKH GO LIVE BARU"], sdlc["TARIKH GO LIVE ASAL"]);

          const urs = { target: cfgURS.date, actual: sdlc["TARIKH URS SEBENAR"] };
          const uat = { target: cfgUAT.date, actual: sdlc["TARIKH UAT SEBENAR"] };
          const live = { target: cfgLive.date, actual: sdlc["TARIKH GO LIVE SEBENAR"] };

          const uatExtras = [];
          if (sdlc["TARIKH LATIHAN"]) uatExtras.push({ label: 'LATIHAN', date: sdlc["TARIKH LATIHAN"] });
          const liveExtras = [];
          if (sdlc["TARIKH FA"]) liveExtras.push({ label: 'FA', date: sdlc["TARIKH FA"] });

          // =================================================================================
          // 3. LOGIK VISUAL & PENGIRAAN
          // =================================================================================

          const parseDateObj = (d) => d ? new Date(d.split('/')[2], d.split('/')[1]-1, d.split('/')[0]) : null;
          const formatDate = (d) => d ? `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}` : "-";
          const today = new Date();
          today.setHours(0,0,0,0);
          
          const dMula = parseDateObj(tMula);
          const dContractEnd = parseDateObj(tEOT || tSiapAsal);
          const dActualFinish = parseDateObj(p["TARIKH SELESAI"]);

          // --- A. KIRA JUMLAH HARI & OVERRUN ---
          let totalProjectDays = 0;
          let dEffectiveEnd = dContractEnd; 
          let isOverrun = false;

          if (dMula && dContractEnd) {
              if (dActualFinish) {
                  if (dActualFinish.getTime() > dContractEnd.getTime()) {
                      dEffectiveEnd = dActualFinish;
                      isOverrun = true;
                  }
              } else if (today.getTime() > dContractEnd.getTime()) {
                  dEffectiveEnd = today;
                  isOverrun = true;
              }
              totalProjectDays = (dEffectiveEnd.getTime() - dMula.getTime());
          }

          const getPercent = (date) => {
              if (!date || !dMula || totalProjectDays <= 0) return 0;
              const elapsed = date.getTime() - dMula.getTime();
              let pct = (elapsed / totalProjectDays) * 100;
              return Math.min(Math.max(pct, 0), 100);
          };

          // --- B. LOGIK SOLID BAR (MASA BERJALAN) ---
          let solidBarWidth = 0;
          
          if (dActualFinish) solidBarWidth = 100;
          else if (isOverrun) solidBarWidth = 100;
          else if (totalProjectDays > 0 && dMula) {
              const daysElapsed = today.getTime() - dMula.getTime();
              solidBarWidth = Math.min(Math.round((daysElapsed / totalProjectDays) * 100), 100);
          }

        // --- C. LOGIK KESIHATAN PROJEK (VERSI: FOKUS TARIKH AKHIR) ---
        // Logik: Selagi belum tamat tempoh kontrak, projek dianggap "Sedang Berjalan".
        // Hanya trigger "Merah" jika hari ini melepasi tarikh siap (Overrun).
        
        const finScore = p.PROGRESS_MASA ? parseFloat(p.PROGRESS_MASA) : 0;
        
        let healthStatus = "SEDANG BERJALAN"; // Default status neutral (Biru)
        let healthColor = "bg-indigo-500"; 
        let statusBadge = null;

        // --- MULA PENILAIAN ---
        
        // 1. JIKA PROJEK DAH SIAP
        if (dActualFinish) {
            if (isOverrun) {
                healthStatus = "SIAP LEWAT";
                healthColor = "bg-amber-500"; // Kuning
            } else {
                healthStatus = "SIAP CEMERLANG";
                healthColor = "bg-emerald-500"; // Hijau
            }
        } 
        // 2. JIKA PROJEK BELUM SIAP
        else {
            if (isOverrun) {
                // KES 1: DAH LEBIH MASA (Barulah kita merahkan dia)
                healthStatus = "LEWAT (OVERRUN)";
                healthColor = "bg-red-600 animate-pulse";
                statusBadge = <span className="text-[9px] font-black text-white bg-red-600 px-2 py-0.5 rounded shadow-sm animate-pulse">KRITIKAL: TAMAT TEMPOH</span>;
            } 
            else {
                // KES 2: MASIH DALAM TEMPOH (Walaupun progress rendah, kita anggap sedang buat kerja)
                healthStatus = "DALAM JADUAL";
                healthColor = "bg-indigo-500"; // Kekal Biru (Tenang)
                
                // Pilihan Tambahan: Amaran Lembut jika masa dah tinggal sikit (Contoh: > 90% masa dah jalan)
                // Ini cuma peringatan mesra, bukan label "Sakit"
                if (solidBarWidth > 90) {
                     statusBadge = <span className="text-[9px] font-black text-white bg-amber-500 px-2 py-0.5 rounded shadow-sm">HAMPIR TAMAT</span>;
                }
            }
        }

          // --- D. DATA MARKER ---
          const dTargetURS = parseDateObj(urs.target);
          const dTargetUAT = parseDateObj(uat.target);
          const dActualURS = parseDateObj(urs.actual);
          const dActualUAT = parseDateObj(uat.actual);

          const getPhaseInfo = (actualDate, targetDate, label, targetType) => {
              const targetPos = getPercent(targetDate);
              const targetDateStr = formatDate(targetDate);
              const labelTarget = `SASARAN ${label} ${targetType}`;
              let marker = null;
              if (actualDate) {
                  const actualPos = getPercent(actualDate);
                  const isLate = actualDate.getTime() > targetDate.getTime();
                  const colorClass = isLate ? "bg-red-500 shadow-[0_0_6px_rgba(239,68,68,1)]" : "bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,1)]";
                  marker = { pos: actualPos, color: colorClass, isLate, dateStr: formatDate(actualDate) };
              }
              return { label, labelTarget, targetPos, targetDateStr, marker };
          };

          const infoURS = getPhaseInfo(dActualURS, dTargetURS, "URS", cfgURS.type);
          const infoUAT = getPhaseInfo(dActualUAT, dTargetUAT, "UAT", cfgUAT.type);

          let displayPercent = Math.round(solidBarWidth);
          if (displayPercent > 100) displayPercent = 100;

          // --- 4. KEWANGAN ---
          const totalKos = parseVal(kosAkhir); 
          const paidValue = (finScore / 100) * totalKos;
          let allowablePayment = 0;
          if (urs.actual) allowablePayment = 30; 
          if (uat.actual) allowablePayment = 90; 
          if (live.actual || p["TARIKH SELESAI"]) allowablePayment = 100;

          // Logic Bar Kewangan
          let financeStatus = "Terkawal";
          let financeColor = "text-emerald-600 bg-emerald-50 border-emerald-100";
          let barFinanceColor = "bg-amber-400"; 
          
          if (finScore > allowablePayment) {
              financeStatus = `TERLEBIH BAYAR`;
              financeColor = "text-red-600 bg-red-50 border-red-100 font-bold";
              barFinanceColor = "bg-red-500"; 
          } 

          // --- 5. EOT & VARIANCE LABEL ---
          let diffLabel = ""; let diffColor = ""; let diffBg = "";
          const dateActualEnd = parseDateObj(p["TARIKH SELESAI"] || (type === 'completed' ? p["TARIKH SIAP SEMASA_ISO"] : null)); 
          if (dContractEnd && dateActualEnd) {
              const dayDiff = Math.ceil((dateActualEnd.getTime() - dContractEnd.getTime()) / (1000 * 60 * 60 * 24));
              if (dayDiff > 0) { diffLabel = `Lewat ${dayDiff} Hari`; diffColor = "text-red-600"; diffBg = "bg-red-50 border-red-100"; }
              else if (dayDiff < 0) { diffLabel = `Awal ${Math.abs(dayDiff)} Hari`; diffColor = "text-emerald-600"; diffBg = "bg-emerald-50 border-emerald-100"; }
              else { diffLabel = "Tepat Masa"; diffColor = "text-blue-600"; diffBg = "bg-blue-50 border-blue-100"; }
          }

          // Components Helper (Marker etc) - Same as before
          const RenderTargetLine = ({ info }) => {
              if (!info || info.targetPos <= 0) return null;
              return (
                  <div className="group/target absolute top-0 bottom-0 w-1 bg-slate-400/80 z-20 hover:w-1.5 hover:bg-slate-600 transition-all cursor-help border-l border-white/40 pointer-events-auto" style={{ left: `${info.targetPos}%` }}>
                      <div className="hidden group-hover/target:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2.5 py-1.5 bg-slate-700 text-white text-[10px] rounded-md shadow-xl z-50 text-center font-bold tracking-wide border border-slate-500">
                          {info.labelTarget}<div className="font-mono text-amber-300 mt-0.5 text-[11px]">{info.targetDateStr}</div>
                          <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
                      </div>
                  </div>
              );
          };

          const RenderActualMarker = ({ info }) => {
              if (!info || !info.marker) return null;
              const m = info.marker;
              return (
                  <div className={`group/marker absolute top-0 bottom-0 w-1.5 z-30 border-x border-white cursor-help ${m.color} transition-all hover:w-2 hover:scale-110 pointer-events-auto`} style={{ left: `${m.pos}%` }}>
                      <div className="hidden group-hover/marker:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2.5 py-1.5 bg-slate-900 text-white text-[10px] rounded-md shadow-xl z-50 text-center border border-slate-600">
                          <div className="font-black text-amber-400 border-b border-white/20 pb-1 mb-1">{info.label} SEBENAR</div>
                          <div className="font-mono text-[11px] mb-0.5">{m.dateStr}</div>
                          <div className={m.isLate ? "text-red-400 font-bold uppercase tracking-wider" : "text-emerald-400 font-bold uppercase tracking-wider"}>{m.isLate ? "TERLEWAT" : "MENDAHULUI"}</div>
                          <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                      </div>
                  </div>
              );
          };

          const OriginalContractMarker = () => {
              if (!isOverrun || !dContractEnd) return null;
              const contractPos = getPercent(dContractEnd);
              return (
                  <div className="group/contract absolute top-0 bottom-0 w-4 -ml-2 z-20 cursor-help flex justify-center pointer-events-auto" style={{ left: `${contractPos}%` }}>
                      <div className="h-full border-l-2 border-dashed border-slate-400/60 group-hover/contract:border-slate-600 group-hover/contract:border-solid transition-all duration-300"></div>
                      <div className="hidden group-hover/contract:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-3 py-2 bg-slate-800 text-white text-[10px] rounded-md shadow-xl z-50 text-center border border-slate-600 animate-fade-in-up">
                          <div className="font-black text-amber-400 border-b border-white/20 pb-1 mb-1 tracking-wider uppercase">TAMAT KONTRAK ASAL</div>
                          <div className="font-mono text-[11px] font-bold text-white mb-0.5">{formatDate(dContractEnd)}</div>
                          <div className="text-[9px] text-slate-400 italic leading-tight">Projek sepatutnya<br/>siap di sini</div>
                          <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
                      </div>
                  </div>
              );
          };

          return (
              <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 relative group mb-4 cursor-pointer hover:border-indigo-300`}>
                  
                  {/* 1. HEALTH STRIP (LEFT) - Warna ikut kesihatan projek */}
                  <div className={`absolute top-0 left-0 w-1.5 h-full rounded-l-xl ${healthColor.split(' ')[0]}`}></div>
                  
                  <div className="p-3 pl-5 flex flex-col gap-3">
                      {/* HEADER */}
                      <div className="border-b border-slate-100 pb-3 mb-1">
                          <div className="flex justify-between items-center mb-2">
                              <div className="flex items-center gap-2">
                                  <div className="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-md border border-slate-200 group-hover:bg-white group-hover:border-indigo-200 transition-colors shadow-sm">
                                      <span className="text-slate-400"><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path></svg></span>
                                      <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest font-mono">{p["NO SEBUT HARGA"] || "DRAF"}</span>
                                  </div>
                                  {/* 2. BADGE HEALTH STATUS DI SINI */}
                                  {statusBadge}
                              </div>
                              
                              {tEOT && (<div className="flex items-center gap-1 pl-1 pr-2 py-0.5 bg-amber-50 border border-amber-100 rounded-full shadow-sm animate-pulse"><div className="bg-amber-500 rounded-full p-0.5 text-white"><svg className="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><span className="text-[8px] font-black text-amber-700 uppercase tracking-wider">EOT Aktif</span></div>)}
                          </div>
                          <div className="flex items-start gap-3 mt-1">
                              <div className="mt-0.5 shrink-0 w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-50 to-slate-50 border border-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm group-hover:scale-110 transition-transform duration-300">
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                              </div>
                              <h4 className="text-[13px] font-black text-slate-800 leading-snug group-hover:text-indigo-700 transition-colors line-clamp-3 pt-0.5">{p.NAMA_PAPARAN}</h4>
                          </div>
                      </div>

                      {/* VITAL MONITOR (Progress Bar Visual Besar) */}
                      {type !== 'planning' && (
                      <div className="mb-3 px-1">
                          {(() => {
                              let heartClass = "text-emerald-500 animate-heartbeat";
                              let containerClass = "from-emerald-50 to-white border-emerald-200";
                              
                              // Warna Monitor Jantung ikut status sakit
                              if (healthStatus.includes("SAKIT") || healthStatus.includes("KRITIKAL")) { 
                                  heartClass = "text-red-600 animate-heartbeat-fast"; 
                                  containerClass = "from-red-50 to-white border-red-300 shadow-red-100"; 
                              } else if (healthStatus.includes("BERISIKO")) {
                                  heartClass = "text-amber-500 animate-heartbeat"; 
                                  containerClass = "from-amber-50 to-white border-amber-200";
                              }

                              return (
                                  <div className={`relative overflow-hidden rounded-xl border-2 px-3 py-2.5 shadow-sm transition-all duration-300 group bg-gradient-to-r ${containerClass}`}>
                                      <div className="absolute inset-0 opacity-10 pointer-events-none flex items-center"><svg className="w-full h-12 text-slate-900" viewBox="0 0 300 50" preserveAspectRatio="none"><path d="M0,25 L30,25 L40,10 L50,40 L60,25 L100,25 L110,5 L120,45 L130,25 L300,25" fill="none" stroke="currentColor" strokeWidth="2"/></svg></div>
                                      <div className="relative z-10 flex items-center justify-between">
                                          <div className="flex items-center gap-3">
                                              <div className="relative w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-md border border-slate-100">
                                                  <svg className={`w-6 h-6 ${heartClass} drop-shadow-md`} fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                              </div>
                                              <div className="flex flex-col">
                                                  <span className={`text-[11px] font-black uppercase tracking-widest leading-none ${healthStatus.includes("SAKIT") ? "text-red-700" : "text-emerald-700"}`}>{healthStatus}</span>
                                                  <span className="text-[9px] font-bold text-slate-400 mt-1">Status Kesihatan</span>
                                              </div>
                                          </div>
                                          <div className="flex flex-col items-end">
                                              <div className={`text-3xl font-black leading-none tracking-tighter drop-shadow-sm ${healthStatus.includes("SAKIT") ? "text-red-700" : "text-emerald-700"}`}>{displayPercent}<span className="text-xs align-top ml-0.5 opacity-60">%</span></div>
                                              <span className="text-[7px] uppercase font-bold text-slate-400 tracking-wider">Masa Berjalan</span>
                                          </div>
                                      </div>
                                  </div>
                              );
                          })()}
                      </div>
                      )}

                      {/* INFO GRID */}
                      <div className="bg-slate-50 rounded-lg p-2.5 border border-slate-200 shadow-sm">
                          <div className="grid grid-cols-2 gap-3">
                              <div className="flex flex-col"><span className="flex items-center gap-1 text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5"><svg className="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Mula</span><span className="text-xs font-black text-slate-700 font-mono leading-none">{tMula}</span></div>
                              <div className="flex flex-col items-end text-right"><span className="flex items-center gap-1 text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Siap Asal<svg className="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span><span className={`text-xs font-black font-mono leading-none ${tEOT ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-700'}`}>{tSiapAsal}</span></div>
                              {tEOT && (<div className="col-span-2 bg-amber-50 border border-amber-200 rounded px-2 py-1 flex justify-between items-center -my-0.5"><div className="flex items-center gap-1"><svg className="w-3 h-3 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span className="text-[9px] font-black uppercase text-amber-600 tracking-wider">EOT Diluluskan</span></div><span className="text-[10px] font-black text-amber-700 font-mono bg-white px-1 rounded shadow-sm border border-amber-100">{tEOT}</span></div>)}
                              <div className="col-span-2 border-t border-slate-200"></div>
                              <div className="flex flex-col"><span className="flex items-center gap-1 text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-0.5"><svg className="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Siap Sebenar</span><span className="text-xs font-black text-slate-800 font-mono leading-none">{p["TARIKH SELESAI"] || "-"}</span></div>
                              <div className="flex flex-col items-end justify-center">{diffLabel ? <span className={`text-[9px] font-black px-1.5 py-0.5 rounded border shadow-sm ${diffBg} ${diffColor}`}>{diffLabel}</span> : <span className="text-[9px] font-bold text-slate-400 italic bg-slate-100 px-1.5 py-0.5 rounded">Sedang Berjalan</span>}</div>
                          </div>
                      </div>

                      {/* TIMELINE */}
                      <div className="relative py-2 mt-2 mb-5">
                          <div className="absolute top-[15px] left-[16%] right-[16%] h-1 bg-slate-200 -z-0 rounded-full"></div>
                          <div className="grid grid-cols-3 w-full relative">
                              <TimelineStep label="URS" targetDate={urs.target} actualDate={urs.actual} position="items-center" />
                              <TimelineStep label="UAT" targetDate={uat.target} actualDate={uat.actual} isRevised={uat.isRevised} extraInfo={uatExtras} position="items-center" />
                              <TimelineStep label="GO LIVE" targetDate={live.target} actualDate={live.actual} isRevised={live.isRevised} extraInfo={liveExtras} position="items-center" />
                          </div>
                      </div>

                      {/* --- PROGRESS BARS --- */}
                      <div className="space-y-4 mt-2 mb-2">
                          <div className="flex flex-col gap-1.5">
                              <div className="flex justify-between items-end">
                                  <div className="flex items-center gap-2">
                                      <span className="text-xs font-black text-slate-700 uppercase tracking-wider">Kemajuan Fizikal</span>
                                      <span className={`text-[10px] font-bold px-2 py-0.5 rounded bg-slate-100 border border-slate-200 ${healthStatus.includes("SAKIT") ? "text-red-600" : "text-indigo-600"}`}>{healthStatus}</span>
                                  </div>
                                  <div className="text-right"><span className="text-sm font-black text-blue-700">{displayPercent}%</span><span className="text-[10px] text-slate-500 ml-1 font-mono font-bold">(Masa)</span></div>
                              </div>

                              <div className="relative w-full h-4">
                                  <div className="absolute inset-0 w-full h-full bg-slate-100 rounded-full overflow-hidden border border-slate-200 shadow-inner">
                                      {/* 3. GHOST BAR (Bertukar Merah jika SAKIT) */}
                                      <div className={`absolute top-0 left-0 h-full w-full border-r transition-colors duration-500 ${isOverrun || healthStatus.includes("SAKIT") ? "bg-red-100/50 border-red-200" : "bg-blue-100/50 border-blue-200"}`}></div>
                                      
                                      {/* Solid Bar (Masa) - Warna ikut Kesihatan */}
                                      <div className={`absolute top-0 left-0 h-full rounded-full shadow-sm transition-all duration-1000 ${healthColor}`} style={{ width: `${solidBarWidth}%` }}>
                                          <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/20 to-transparent"></div>
                                      </div>
                                  </div>

                                  <div className="absolute inset-0 w-full h-full pointer-events-none">
                                      <OriginalContractMarker />
                                      <RenderTargetLine info={infoURS} />
                                      <RenderTargetLine info={infoUAT} />
                                      <RenderActualMarker info={infoURS} />
                                      <RenderActualMarker info={infoUAT} />
                                  </div>
                              </div>
                          </div>

                          {/* Bar Kewangan */}
                          <div className="flex flex-col gap-1.5 opacity-90 hover:opacity-100 transition-opacity">
                              <div className="flex justify-between items-end">
                                  <div className="flex items-center gap-2">
                                      <span className="text-xs font-black text-amber-600 uppercase tracking-wider">Bayaran</span>
                                      <span className={`text-[10px] font-bold px-2 py-0.5 rounded border ${financeColor}`}>{financeStatus}</span>
                                  </div>
                                  <div className="text-right">
                                      <span className="text-sm font-black text-amber-700">{finScore}%</span>
                                      <span className="text-[10px] text-slate-500 ml-1 font-mono font-bold">({fmtRM(paidValue)})</span>
                                  </div>
                              </div>
                              <div className="relative w-full h-4 bg-slate-100 rounded-full overflow-hidden border border-slate-200 shadow-inner">
                                  <div className={`absolute top-0 left-0 h-full rounded-full transition-all duration-1000 shadow-sm ${barFinanceColor}`} style={{ width: `${finScore}%` }}>
                                      <div className="w-full h-full opacity-20" style={{ backgroundImage: 'linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent)', backgroundSize: '1rem 1rem' }}></div>
                                  </div>
                                  <div className="absolute top-0 bottom-0 w-0.5 bg-emerald-500 z-10" style={{ left: `${allowablePayment}%` }}></div>
                              </div>
                              <div className="flex justify-between text-[9px] text-slate-400 italic px-1">
                                  <span>* Had bayaran ikut milestone siap</span>
                              </div>
                          </div>
                      </div>

                      {/* FOOTER */}
                      <div className="mt-3 pt-1">
                          <div className="bg-gradient-to-r from-slate-50 to-white border border-slate-200 rounded-lg p-2.5 shadow-sm flex items-center justify-between hover:border-indigo-300 transition-colors duration-300 group/footer">
                              <div className="flex flex-col gap-1">
                                  <span className="flex items-center gap-1.5 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                      <svg className="w-3.5 h-3.5 text-slate-400 group-hover/footer:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Nilai & Pelaksana
                                  </span>
                                  <div className="flex items-center gap-1.5 pl-5">
                                      <svg className="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                                      <span className="text-[10px] font-bold text-slate-600 uppercase truncate max-w-[150px] md:max-w-[200px]" title={p["SYARIKAT"]}>{p["SYARIKAT"] || "Tiada Maklumat Syarikat"}</span>
                                  </div>
                              </div>
                              <div className="text-right">
                                  <div className="text-lg font-black text-slate-800 leading-none tracking-tight group-hover/footer:text-indigo-700 transition-colors">{fmtRM(kosAkhir)}</div>
                                  {voTambah > 0 ? (<span className="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-1 rounded border border-emerald-100 mt-1 inline-block">+VO: {fmtRM(voTambah)}</span>) : (<span className="text-[9px] text-slate-400 block mt-0.5">Tiada VO</span>)}
                              </div>
                          </div>
                      </div>

                  </div>
              </div>
          );
      };

    return (
        <div className="flex flex-col h-full animate-fade-in pb-10 font-sans">
            
            {/* 1. GAMIFICATION SECTION (Letak Sini) */}
            <GamificationSection data={data} selectedYear={selectedPlanYear} />

            {/* HEADER & FILTER & STATS */}
            <div className="flex flex-col gap-4 mb-6 px-1">
                
                {/* Tajuk & Dropdown Tahun */}
                <div className="flex justify-between items-end">
                    <div>
                        <h3 className="text-xl font-black text-slate-800 uppercase tracking-tighter flex items-center gap-2">
                            <span className="p-2 rounded-lg bg-indigo-600 text-white shadow-lg shadow-indigo-200">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            </span>
                            Perancangan Pembangunan
                        </h3>
                        <div className="flex items-center gap-3 mt-2">
                            {/* Stat Badge: Bilangan Projek */}
                            <span className="text-[10px] font-bold bg-white border border-slate-200 px-2 py-1 rounded-md shadow-sm text-slate-500">
                                {stats.totalCount} Projek
                            </span>
                            {/* Stat Badge: Nilai Keseluruhan */}
                            <span className="text-[10px] font-black bg-emerald-50 border border-emerald-100 px-2 py-1 rounded-md shadow-sm text-emerald-600">
                                Nilai: {fmtRM(stats.totalValue)}
                            </span>
                        </div>
                    </div>

                    <div className="flex items-center gap-2">
                        {/* SEARCH BAR BARU */}
                        <div className="relative group">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg className="h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input
                                type="text"
                                className="block w-full pl-9 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 sm:text-xs font-bold transition-all shadow-sm w-[200px] focus:w-[250px]"
                                placeholder="Cari Projek / Syarikat..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            {searchTerm && (
                                <button onClick={() => setSearchTerm("")} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-300 hover:text-red-500 cursor-pointer">
                                    <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>
                                </button>
                            )}
                        </div>

                        {/* TAHUN FILTER (YANG LAMA) */}
                        <div className="relative bg-white rounded-lg p-0 flex items-center border border-slate-200 shadow-sm hover:border-indigo-400 transition-colors">
                            <select value={selectedPlanYear} onChange={(e) => setSelectedPlanYear(e.target.value)} className="bg-transparent text-slate-800 font-black text-xs py-2 pl-3 pr-8 outline-none cursor-pointer appearance-none min-w-[70px]">
                                {!availableYears.includes(currentYear) && <option value={currentYear}>{currentYear}</option>}
                                {!availableYears.includes("2026") && <option value="2026">2026</option>}
                                {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                            <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none"><svg className="w-3 h-3 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>
                </div>
            </div>

            {/* --- LAYOUT BARU: STACKED --- */}
            <div className="space-y-8">
                
                {/* 1. SEKSYEN ATAS: PERANCANGAN (Pipeline) */}
                <div className="bg-slate-50/50 rounded-2xl p-4 border border-dashed border-slate-300">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="w-1.5 h-6 bg-slate-400 rounded-full"></div>
                        <h4 className="text-sm font-black text-slate-600 uppercase tracking-widest">Fasa Perancangan (Pipeline)</h4>
                        <span className="bg-slate-200 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold">{buckets.planning.length}</span>
                    </div>
                    {/* Grid Kotak-Kotak Kecil untuk Perancangan */}
                    {buckets.planning.length > 0 ? (
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                            {buckets.planning.map((p, i) => <PlanningCard key={i} p={p} />)}
                        </div>
                    ) : (
                        <EmptyState msg="Tiada projek dalam perancangan." />
                    )}
                </div>

                {/* 2. SEKSYEN BAWAH: PELAKSANAAN & SIAP (Split View 50-50) */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    
                    {/* KOLUM KIRI: SEDANG JALAN */}
                    <div className="flex flex-col gap-4">
                        <div className="flex items-center justify-between pb-2 border-b-2 border-indigo-500 sticky top-0 bg-gray-50/95 backdrop-blur z-20 pt-2">
                             <div className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                                <span className="text-sm font-black uppercase text-indigo-700 tracking-widest">Sedang Dilaksana</span>
                             </div>
                             <span className="bg-indigo-100 text-indigo-700 px-2.5 py-1 rounded-md text-[11px] font-black shadow-sm">{buckets.progress.length}</span>
                        </div>
                        <div className="space-y-4">
                            {buckets.progress.map((p, i) => <ProjectCard key={i} p={p} type="progress" onClick={() => setSelectedProject(p)} />)}
                            {buckets.progress.length === 0 && <EmptyState msg="Tiada projek aktif." />}
                        </div>
                    </div>

                    {/* KOLUM KANAN: SIAP (CPC) */}
                    <div className="flex flex-col gap-4">
                        <div className="flex items-center justify-between pb-2 border-b-2 border-emerald-500 sticky top-0 bg-gray-50/95 backdrop-blur z-20 pt-2">
                             <div className="flex items-center gap-2">
                                <span className="text-sm font-black uppercase text-emerald-700 tracking-widest">Telah Siap (CPC)</span>
                             </div>
                             <span className="bg-emerald-100 text-emerald-700 px-2.5 py-1 rounded-md text-[11px] font-black shadow-sm">{buckets.completed.length}</span>
                        </div>
                        <div className="space-y-4">
                            {buckets.completed.map((p, i) => <ProjectCard key={i} p={p} type="completed" onClick={() => setSelectedProject(p)} />)}
                            {buckets.completed.length === 0 && <EmptyState msg="Tiada projek siap." />}
                        </div>
                    </div>

                </div>
            </div>
            {/* RENDER MODAL JIKA ADA PROJEK DIPILIH */}
            {selectedProject && (
                <ProjectDetailModal 
                    project={selectedProject} 
                    onClose={() => setSelectedProject(null)} 
                />
            )}
        </div>
    );
};

// Helper UI untuk Empty State
const EmptyState = ({ msg }) => (
    <div className="flex flex-col items-center justify-center h-24 border-2 border-dashed border-slate-200 rounded-lg bg-slate-50/50">
        <span className="text-xl opacity-30 mb-1">ðŸ“‚</span>
        <span className="text-[10px] font-bold uppercase text-slate-400">{msg}</span>
    </div>
);

  const Dashboard = () => {
    const [data, setData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [staffData, setStaffData] = useState([]);
    const [jawatanData, setJawatanData] = useState([]);
    const [activeTab, setActiveTab] = useState(() => localStorage.getItem("bpm_activeTab") || "planning");
    const [printing, setPrinting] = useState(false);
    const [darkMode, setDarkMode] = useState(() => localStorage.getItem("bpm_darkMode") === "true");

    const currentYear = new Date().getFullYear().toString();

    // Filter States
    const [selectedStatuses, setSelectedStatuses] = useState([]);
    const [selectedVots, setSelectedVots] = useState([]);
    const [selectedYear, setSelectedYear] = useState(currentYear);
    const [selectedSeksyen, setSelectedSeksyen] = useState("All");
    const [searchTerm, setSearchTerm] = useState("");
    const [isFilterOpen, setIsFilterOpen] = useState(false);
    const [selectedBahagian, setSelectedBahagian] = useState("All");

    const [selectedActualYear, setSelectedActualYear] = useState("All");
    const [selectedCategories, setSelectedCategories] = useState([]);
    const [selectedPegawai, setSelectedPegawai] = useState("All");

    // --- FUNGSI BARU: EXECUTIVE SUMMARY (WHATSAPP COPY) ---
    const handleCopySummary = () => {
        // 1. KIRA STATISTIK PANTAS
        const total = filtered.length;
        const kritikal = filtered.filter(p => p.LOGIK_SIAP.includes("Lewat") || p.LOGIK_SIAP.includes("Overdue")).length;
        const siap = filtered.filter(p => p.LOGIK_SIAP.includes("Siap")).length;
        const onTrack = total - kritikal - siap;
        
        // Kewangan
        const totalKos = filtered.reduce((acc, p) => acc + parseCurrency(p.KOS_AKHIR || 0), 0);
        const totalBayar = filtered.reduce((acc, p) => acc + parseCurrency(p.JUMLAH_BAYARAN || 0), 0);
        const peratusBayar = totalKos > 0 ? ((totalBayar / totalKos) * 100).toFixed(1) : 0;

        // 2. CARI ISU UTAMA (TOP 3 LEWAT)
        const topIssues = filtered
            .filter(p => p.LOGIK_SIAP.includes("Lewat") || p.LOGIK_SIAP.includes("Overdue"))
            .sort((a,b) => parseCurrency(b.KOS_AKHIR) - parseCurrency(a.KOS_AKHIR)) // Susun ikut nilai projek paling mahal
            .slice(0, 3)
            .map((p, i) => {
                const isu = p.INFO_LEWAT ? `- ${p.INFO_LEWAT}` : "";
                return `${i+1}. ${p.NAMA_PAPARAN} (RM${(parseCurrency(p.KOS_AKHIR)/1000000).toFixed(1)}m) ${isu}`;
            });

        // 3. FORMAT TEXT (WHATSAPP STYLE)
        const todayStr = new Date().toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        let text = `ðŸ“Š *Laporan Ringkas Projek BPM (${todayStr})*\n\n`;
        text += `ðŸ”¢ *Status Keseluruhan (${total} Projek)*\n`;
        text += `ðŸ”´ Kritikal/Lewat: ${kritikal}\n`;
        text += `ðŸŸ¢ Mengikut Jadual: ${onTrack}\n`;
        text += `ðŸ”µ Siap (CPC): ${siap}\n\n`;
        
        if (topIssues.length > 0) {
            text += `ðŸš¨ *Isu Utama (Top 3):*\n`;
            text += topIssues.join('\n') + `\n\n`;
        } else {
            text += `âœ… *Tiada Isu Kritikal Direkodkan.*\n\n`;
        }

        text += `ðŸ’° *Prestasi Kewangan:*\n`;
        text += `Belanja: ${peratusBayar}% (RM ${(totalBayar/1000000).toFixed(2)}m / ${(totalKos/1000000).toFixed(2)}m)\n\n`;
        text += `_Dijana oleh BPM Smart Dashboard_`;

        // 4. COPY TO CLIPBOARD
        navigator.clipboard.writeText(text).then(() => {
            alert("âœ… Ringkasan berjaya disalin! Boleh 'Paste' di WhatsApp.");
        }).catch(err => {
            console.error('Gagal menyalin: ', err);
            alert("âŒ Gagal menyalin. Sila cuba lagi.");
        });
    };

    useEffect(() => {
      setLoading(true);
      Promise.all([
        new Promise(r => google.script.run.withSuccessHandler(res => r(JSON.parse(res))).getIntegratedData()),
        new Promise(r => google.script.run.withSuccessHandler(res => r(JSON.parse(res))).withFailureHandler(() => r([])).getKakitanganData()),
        new Promise(r => google.script.run.withSuccessHandler(res => r(JSON.parse(res))).withFailureHandler(() => r([])).getJawatanData())
      ]).then(([projekRes, staffRes, jawatanRes]) => {
        setData(projekRes);
        setStaffData(staffRes);
        setJawatanData(jawatanRes);
        setLoading(false);
      });
    }, []);

    useEffect(() => {
        localStorage.setItem("bpm_activeTab", activeTab);
    }, [activeTab]);

    useEffect(() => {
        localStorage.setItem("bpm_darkMode", darkMode);
        // Update class body/html jika perlu untuk global dark mode
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
    }, [darkMode]);

    const cleanData = useMemo(() => data.filter((r) => r.NAMA_PAPARAN && r.NAMA_PAPARAN.trim() !== ""), [data]);

    const uniqueYears = useMemo(() => [...new Set(cleanData.map((r) => r.TAHUN_MULA).filter(Boolean))].sort().reverse(), [cleanData]);
    const uniqueActualYears = useMemo(() => {
      return [...new Set(cleanData.map((r) => {
        const tSelesai = r["TARIKH SELESAI"]; 
        if (!tSelesai || tSelesai === "-") return null;

        const parts = tSelesai.split("/");
        if (parts.length === 3) return parts[2];
        return null;
      }).filter(Boolean))].sort().reverse();
    }, [cleanData]);

    const uniquePegawai = useMemo(() => {
      const allNames = cleanData.flatMap((r) => {
        if (!r.PEGAWAI_NAMA || r.PEGAWAI_NAMA === "-" || r.PEGAWAI_NAMA === "Unknown") return [];
        // Pecahkan nama kalau ada koma (split by comma)
        return r.PEGAWAI_NAMA.split(',').map(n => n.trim());
      });
      // Buang duplicate lepas dah pecahkan
      return [...new Set(allNames)].sort();
    }, [cleanData]);

    const uniqueCategories = useMemo(() => [...new Set(cleanData.map((r) => r["KATEGORI PERKHIDMATAN"]).filter(Boolean))].sort(), [cleanData]);
    const uniqueSeksyen = useMemo(() => [...new Set(cleanData.map((r) => r.SEKSYEN_NAMA).filter(Boolean))].sort(), [cleanData]);
    const uniqueVots = useMemo(() => [...new Set(cleanData.map((r) => r.VOT_NAMA).filter((v) => v && v !== "-"))].sort(), [cleanData]);
    const allStatuses = ["Siap (CPC)", "Siap (Lewat)", "Dalam Jadual", "Lewat (Overdue)", "Batal", "Belum Mula"];
    const uniqueBahagian = useMemo(() => [...new Set(cleanData.map((r) => r.BAHAGIAN_NAMA).filter(Boolean))].sort(), [cleanData]);

    const filtered = useMemo(() => {
      return cleanData.filter((r) => {
        const searchString = `${r.NAMA_PAPARAN} ${r["NO SEBUT HARGA"]} ${r.SYARIKAT_NAMA} ${r.VOT_NAMA}`.toLowerCase();
        const matchSearch = searchTerm === "" || searchString.includes(searchTerm.toLowerCase());
        const matchYear = selectedYear === "All" || String(r.TAHUN_MULA) === String(selectedYear);

        let matchActualYear = true;
        if (selectedActualYear !== "All") {
          // Pastikan ada tarikh selesai, dan tahunnya sama dengan pilihan
          const tSelesai = r["TARIKH SELESAI"]; // Contoh: "26/12/2025"
          if (!tSelesai || tSelesai === "-") {
            matchActualYear = false; // Tak siap lagi, so tak match tahun siap
          } else {
            matchActualYear = tSelesai.endsWith(selectedActualYear); // Check hujung string (Tahun)
          }
        }

        const matchCat = selectedCategories.length === 0 || selectedCategories.includes(r["KATEGORI PERKHIDMATAN"]);
        
        let matchPegawai = true;
        if (selectedPegawai !== "All") {
          if (!r.PEGAWAI_NAMA) {
            matchPegawai = false;
          } else {
            const pegawaiInProject = r.PEGAWAI_NAMA.split(',').map(p => p.trim());
            matchPegawai = pegawaiInProject.includes(selectedPegawai);
          }
        }

        const matchSeksyen = selectedSeksyen === "All" || r.SEKSYEN_NAMA === selectedSeksyen;
        const matchStatus = selectedStatuses.length === 0 || selectedStatuses.includes(r.LOGIK_SIAP);
        const matchVot = selectedVots.length === 0 || selectedVots.includes(r.VOT_NAMA);
        const matchBahagian = selectedBahagian === "All" || r.BAHAGIAN_NAMA === selectedBahagian;
        return matchSearch && matchYear && matchActualYear && matchCat && matchPegawai && matchSeksyen && matchStatus && matchVot && matchBahagian;
        });
      }, [cleanData, searchTerm, selectedYear, selectedActualYear, selectedCategories, selectedPegawai, selectedSeksyen, selectedStatuses, selectedVots, selectedBahagian]);

    // --- STATS CALCULATION (FIXED: USE PARSECURRENCY) ---
    const stats = useMemo(() => ({
      total: filtered.length,
      siap: filtered.filter((r) => r.LOGIK_SIAP === "Siap (CPC)").length,
      lewat: filtered.filter((r) => r.LOGIK_SIAP === "Lewat (Overdue)").length,
      kos: filtered.filter((r) => r.LOGIK_SIAP !== "Batal").reduce((acc, curr) => acc + parseCurrency(curr.KOS_AKHIR), 0),
    }),
      [filtered]
    );

    const advancedStats = useMemo(() => {
      const current = new Date();
      const total = filtered.length;

      // A. LOGIK BARU: IMPAK VO BERSIH (FIXED: USE PARSECURRENCY)
      const totalVOImpact = filtered.reduce((acc, r) => {
        const valVOAdd = parseCurrency(r["VO TAMBAHAN"]);
        const valVOLess = parseCurrency(r["VO PENGURANGAN"]);
        const valSSTAdj = parseCurrency(r["PELARASAN SST"]);

        const totalIncrease = valVOAdd + valSSTAdj;
        const sstRate = 0.08;
        const totalDecrease = valVOLess + valVOLess * sstRate;

        return acc + (totalIncrease - totalDecrease);
      }, 0);

      const eotCount = filtered.filter((r) => r["EOT"] && r["EOT"].toString().trim() !== "").length;
      const expiringCount = filtered.filter((r) => {
        if (r.LOGIK_SIAP !== "Dalam Jadual" && r.LOGIK_SIAP !== "Lewat (Overdue)") return false;
        if (!r.TARIKH_SIAP_SEMASA_ISO) return false;
        const diffTime = new Date(r.TARIKH_SIAP_SEMASA_ISO) - current;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays >= 0 && diffDays <= 30;
      }).length;

      const totalKos = filtered.reduce((acc, r) => acc + parseCurrency(r.KOS_AKHIR), 0);
      const totalBayar = filtered.reduce((acc, r) => acc + parseCurrency(r.JUMLAH_BAYARAN), 0);
      const bakiKomitmen = totalKos - totalBayar;

      const pendingList = filtered.filter((r) => r.LOGIK_SIAP === "Siap (CPC)" && r.PROGRESS_MASA < 100);
      const pendingFinalPaymentDetails = pendingList.map((r) => ({
        nama: r.NAMA_PAPARAN,
        baki: parseCurrency(r.KOS_AKHIR) - parseCurrency(r.JUMLAH_BAYARAN),
      }));
      const pendingFinalPayment = pendingList.length;

      const totalProgress = filtered.reduce((acc, r) => acc + (r.PROGRESS_MASA || 0), 0);
      const scheduleHealth = total > 0 ? Math.round(totalProgress / total) : 0;
      const efficiencyCount = filtered.filter((r) => r.LOGIK_SIAP === "Siap (CPC)" && (!r["EOT"] || r["EOT"] === "")).length;

      const totalOriginalCost = filtered.reduce((acc, r) => acc + parseCurrency(r["JUMLAH"]), 0);
      const varianceRate = totalOriginalCost > 0 ? ((totalVOImpact / totalOriginalCost) * 100).toFixed(1) : 0;

      return { totalVOImpact, eotCount, expiringCount, totalKos, totalBayar, bakiKomitmen, pendingFinalPayment, pendingFinalPaymentDetails, scheduleHealth, efficiencyCount, varianceRate };
    }, [filtered]);

    const toggleSelection = (setFunc, list, item) => setFunc((prev) => prev.includes(item) ? prev.filter((i) => i !== item) : [...prev, item]);
    const formatRM = (v) => "RM " + (v || 0).toLocaleString("en-MY", { minimumFractionDigits: 2 });

    // PRINT FUNCTION
    const handlePrint = () => {
      setPrinting(true);
      google.script.run
        .withSuccessHandler((html) => {
          setPrinting(false);
          const win = window.open("", "_blank", "width=900,height=700");
          if (win) { win.document.write(html); win.document.close(); }
          else { alert("Sila benarkan popup."); }
        })
        .getPrintHtml(JSON.stringify(filtered));
    };

    if (loading)
      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center overflow-hidden">
          {/* Background Latar Belakang dengan Blur & Gradient */}
          <div className="absolute inset-0 bg-slate-50/40 backdrop-blur-xl"></div>

          {/* Dekorasi Cahaya Bergerak */}
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-blue-400/20 rounded-full blur-[120px] animate-pulse"></div>
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-indigo-500/10 rounded-full blur-[80px] delay-700 animate-pulse"></div>

          <div className="relative flex flex-col items-center">
            {/* Container Spinner Berlapis */}
            <div className="relative w-24 h-24 mb-8">
              {/* Lingkaran Luar (Pusing Perlahan) */}
              <div className="absolute inset-0 border-[3px] border-transparent border-t-blue-500 border-l-blue-500 rounded-full animate-[spin-slow_2s_linear_infinite]"></div>

              {/* Lingkaran Tengah (Pusing Laju Sebaliknya) */}
              <div className="absolute inset-2 border-[3px] border-transparent border-t-indigo-400 border-r-indigo-400 rounded-full animate-[spin-reverse_1.5s_linear_infinite] opacity-70"></div>

              {/* Lingkaran Dalam (Pulse) */}
              <div className="absolute inset-6 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center">
                <svg
                  className="w-6 h-6 text-white animate-pulse"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
              </div>
            </div>

            {/* Teks Loading Moden */}
            <div className="flex flex-col items-center gap-2">
              <h2 className="text-xl font-black text-slate-800 tracking-tighter uppercase italic">
                BPM <span className="text-blue-600">Smart</span> Dashboard
              </h2>
              <div className="flex items-center gap-2">
                <div className="flex space-x-1">
                  <div className="w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                  <div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                  <div className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></div>
                </div>
                <p className="text-[11px] font-extrabold text-slate-500 uppercase tracking-[0.3em] pl-1">
                  Sila Tunggu Sebentar
                </p>
              </div>
            </div>
          </div>
        </div>
      );

    // Kemaskini StatCard dengan Glowing Border & UI Gempak
    const StatCard = ({
      title,
      val,
      sub,
      icon,
      colorClass,
      onClick,
      isActive,
      desc,
      detailList,
    }) => {
      // Helper untuk extract warna asas dari string colorClass (cth: "bg-blue-500..." -> "blue-500")
      // Ini supaya border glow ikut warna ikon
      const baseColor = colorClass.split(" ")[0].replace("bg-", "");

      return (
        <div
          onClick={onClick}
          className="group relative h-full transition-all duration-300 cursor-pointer"
        >
          {/* --- 1. THE GLOWING BORDER (Rahsia UI Gempak) --- */}
          {/* Layer ini duduk di belakang. Bila hover, dia opacity-100 dan blur */}
          <div
            className={`absolute -inset-[2px] rounded-[26px] bg-gradient-to-br from-white/50 to-${baseColor} 
                opacity-0 blur-md transition-all duration-500 
                group-hover:opacity-100 group-hover:blur-lg group-hover:duration-200
                ${isActive ? "opacity-100 blur-md scale-100" : ""}
              `}
          ></div>

          {/* --- 2. KAD UTAMA (GLASS) --- */}
          <div
            className={`relative h-full p-6 rounded-[24px] overflow-hidden transition-all duration-500 border border-white/60
                ${isActive
                ? "bg-white/90 backdrop-blur-2xl shadow-2xl scale-[1.02]"
                : "bg-white/60 backdrop-blur-xl shadow-lg group-hover:-translate-y-1 group-hover:bg-white/80 group-hover:shadow-2xl"
              }
              `}
          >
            {/* Hiasan Latar (Blob) */}
            <div
              className={`absolute -right-10 -top-10 w-32 h-32 rounded-full opacity-10 blur-3xl transition-transform duration-700 group-hover:scale-150 group-hover:opacity-20 ${colorClass}`}
            ></div>

            {/* HEADER: Icon & Title */}
            <div className="flex items-center justify-between mb-5 relative z-10">
              {/* Icon Container dengan Glass Effect Tebal */}
              <div
                className={`w-12 h-12 flex items-center justify-center rounded-2xl shadow-inner border border-white/50 ${colorClass} bg-opacity-10 transition-transform duration-500 group-hover:rotate-12 group-hover:scale-110`}
              >
                {icon}
              </div>

              <div className="flex flex-col items-end">
                <span className="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] leading-none mb-1.5 text-right">
                  {title}
                </span>
                {/* Progress Bar Hiasan */}
                <div className="h-1.5 w-12 rounded-full bg-slate-100 overflow-hidden shadow-inner">
                  <div
                    className={`h-full ${colorClass.split(" ")[0]
                      } opacity-40 group-hover:w-full group-hover:opacity-100 transition-all duration-1000 w-[40%]`}
                  ></div>
                </div>
              </div>
            </div>

            {/* CONTENT: Value & Sub */}
            <div className="relative z-10 mt-auto">
              <div className="text-2xl sm:text-3xl font-black text-slate-800 tracking-tighter mb-1 whitespace-nowrap group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-slate-800 group-hover:to-blue-600 transition-all">
                {val}
              </div>

              <div className="flex items-center gap-2 mt-2">
                <span className={`flex h-2 w-2 relative`}>
                  <span
                    className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${colorClass.split(" ")[0]
                      }`}
                  ></span>
                  <span
                    className={`relative inline-flex rounded-full h-2 w-2 ${colorClass.split(" ")[0]
                      }`}
                  ></span>
                </span>
                <span className="text-[10px] text-slate-500 font-extrabold tracking-widest uppercase">
                  {sub}
                </span>
              </div>
            </div>
          </div>

          {/* --- 3. TOOLTIP POPUP (MODEN) --- */}
          {(desc || (detailList && detailList.length > 0)) && (
            <div className="absolute top-[95%] left-0 right-0 z-50 opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 group-hover:top-[105%] transition-all duration-500 ease-out pointer-events-none group-hover:pointer-events-auto">
              <div className="bg-slate-900/90 backdrop-blur-2xl p-4 rounded-2xl shadow-[0_20px_40px_-10px_rgba(0,0,0,0.5)] border border-white/10 relative overflow-hidden mx-1 ring-1 ring-white/5">
                {/* Hiasan Glow dalam Tooltip */}
                <div
                  className={`absolute top-0 left-1/2 -translate-x-1/2 w-1/2 h-1 ${colorClass.split(" ")[0]
                    } blur-[2px]`}
                ></div>

                <div className="relative z-10">
                  <div className="flex items-center justify-between mb-3 pb-2 border-b border-white/10">
                    <div className="flex items-center gap-2">
                      <div
                        className={`w-1.5 h-1.5 rounded-full ${colorClass.split(" ")[0]
                          } shadow-[0_0_10px_currentColor]`}
                      ></div>
                      <h4 className="text-[9px] font-black text-slate-300 uppercase tracking-[0.25em]">
                        {detailList && detailList.length > 0
                          ? "Perincian"
                          : "Info"}
                      </h4>
                    </div>
                    {detailList && (
                      <span className="text-[8px] font-bold px-1.5 py-0.5 rounded bg-white/10 text-white border border-white/5">
                        {detailList.length} Item
                      </span>
                    )}
                  </div>

                  {detailList && detailList.length > 0 ? (
                    <div className="max-h-[160px] overflow-y-auto custom-scroll pr-2 space-y-2.5">
                      {detailList.map((item, idx) => (
                        <div
                          key={idx}
                          className="flex justify-between items-center text-[10px] group/item p-1.5 hover:bg-white/5 rounded-lg transition-colors border border-transparent hover:border-white/5"
                        >
                          <span className="text-slate-400 font-bold leading-tight group-hover/item:text-slate-200 transition-colors w-[65%] truncate">
                            {item.nama}
                          </span>
                          <span className="font-mono font-black text-amber-400 bg-amber-500/10 px-2 py-0.5 rounded text-[9px] border border-amber-500/20">
                            RM{" "}
                            {item.baki.toLocaleString("en-MY", {
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 0,
                            })}
                          </span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-slate-300 text-[10px] leading-relaxed font-semibold tracking-wide">
                      {desc}
                    </p>
                  )}
                </div>
              </div>

              {/* Arrow Connector */}
              <div className="absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-slate-900/90 rotate-45 border-t border-l border-white/10"></div>
            </div>
          )}
        </div>
      );
    };

    // --- 4. FAIR GAMIFICATION ENGINE (MAPPING PENUH: STAFF + JAWATAN) ---
    const FairGamificationEngine = ({ data, staffData, jawatanData, selectedYear }) => {
      
      const getFairGrade = (percentage, totalScore, totalValue, totalProjects) => {
    

          const isHighImpact = totalValue > 300000 && totalProjects >= 2;
          
          const isMediumImpact = (totalValue > 100000 && totalValue <= 300000) && totalProjects >= 2;

          const isLowImpact = (totalValue >= 50000 && totalValue <= 100000) && totalProjects >= 2;

          const isNoImpact = totalValue < 50000 && totalProjects >= 2;

          // TIER 1: PLATINUM 
          if (percentage >= 85 && isHighImpact) {
              return { 
                title: "PLATINUM", 
                subTitle: "EMERALD",
                color: "bg-slate-900", 
                badge: "bg-emerald-100 text-emerald-800 border-emerald-300 ring-1 ring-emerald-300", 
                icon: "â‡ï¸" 
              };
          }

          // TIER 2: GOLD
          if ((percentage >= 90 && !isLowImpact) || (percentage >= 75 && (isMediumImpact || isHighImpact))) {
              return { 
                title: "GOLD", 
                subTitle: "SAPPHIRE",
                color: "bg-amber-500", // Background Kad Emas
                badge: "bg-blue-100 text-blue-800 border-blue-300 ring-1 ring-blue-300", 
                icon: "ðŸ”·" // Sapphire (Mid Tier Oneworld)
              };
          }

          // TIER 3: SILVER
          if (percentage >= 65 || isLowImpact) {
              return { 
                title: "SILVER", 
                subTitle: "RUBY",
                color: "bg-slate-400",
                badge: "bg-red-100 text-red-800 border-red-300 ring-1 ring-red-300", 
                icon: "â™¦ï¸"
              };
          }

          // TIER 4: BRONZE
          if (percentage >= 50 || isNoImpact) {
              return {
                title: "BLUE", 
                subTitle: "MEMBER",
                color: "bg-blue-600", 
                badge: "bg-blue-50 text-blue-700 border-blue-200", 
                icon: "âœˆï¸"
              };
          }

          return { title: "MEMBER", color: "bg-gray-300", badge: "bg-gray-100 text-gray-500", icon: "ðŸ”¹" };
      };

      const officerStats = React.useMemo(() => {
        const stats = {};
        const roleDefinitionMap = {};
        if (jawatanData && Array.isArray(jawatanData)) {
          jawatanData.forEach(j => {
            if (j["SINGKATAN"] && j["JAWATAN"]) roleDefinitionMap[j["SINGKATAN"].trim().toUpperCase()] = j["JAWATAN"].trim().toUpperCase();
          });
        }
        const staffMap = {};
        if (staffData && Array.isArray(staffData)) {
          staffData.forEach(s => {
            if (s["NAMA PENUH"] && s["JAWATAN"]) {
              const nama = s["NAMA PENUH"].trim();
              const singkatan = s["JAWATAN"].trim().toUpperCase();
              staffMap[nama] = roleDefinitionMap[singkatan] || singkatan;
            }
          });
        }

        data.forEach((r) => {
          if (selectedYear !== "All") {
            if (String(r.TAHUN_MULA) !== String(selectedYear)) return;
          }
          const kategori = (r["KATEGORI PERKHIDMATAN"] || "").toUpperCase();
          const isDevProject = kategori.includes("PEMBANGUNAN") || kategori.includes("PENAMBAHBAIKAN") || kategori.includes("BINA");

          if (!isDevProject) return;

          const rawNames = r["PEGAWAI BERTANGGUNGJAWAB"] || r.PEGAWAI_NAMA || "";
          if (!rawNames || rawNames === "-" || rawNames === "Unknown") return;

          const names = rawNames.split(",").map((n) => n.trim());

          names.forEach((name) => {
            if (!name) return;

            const userRole = staffMap[name] || "UNKNOWN";
            let roleMultiplier = 1.0;
            let isOfficer = false;

            const officerKeywords = ["PENGARAH", "PEGAWAI", "KETUA"];
            const supportKeywords = ["PENOLONG", "PEMBANTU", "JURUTEKNIK", "OPERASI"];
            const hasOfficerKey = officerKeywords.some(kw => userRole.includes(kw));
            const hasSupportKey = supportKeywords.some(kw => userRole.includes(kw));

            if (hasOfficerKey && !hasSupportKey) {
              roleMultiplier = 1.5;
              isOfficer = true;
            }
            const highRankShort = ["P(BPM)", "TP(BPM)", "KS(", "PTM", "PEE", "KP"];
            if (roleMultiplier === 1.0) {
              if (highRankShort.some(k => userRole.includes(k))) {
                roleMultiplier = 1.5;
                isOfficer = true;
              }
            }

            if (!stats[name]) {
              stats[name] = { name: name, role: userRole, isOfficer: isOfficer, totalProjects: 0, completedProjects: 0, totalValue: 0, totalActualScore: 0, totalMaxScore: 0, projects: [], title: "BLUE" };
            }

            // FIXED: USE PARSECURRENCY
            const kosAkhir = parseCurrency(r.KOS_AKHIR || r.JUMLAH);
            const kosAsal = parseCurrency(r.JUMLAH);

            let basePoints = 0;
            if (r.LOGIK_SIAP === 'Siap (CPC)') basePoints = 100;
            else if (r.LOGIK_SIAP === 'Dalam Jadual') basePoints = 90;
            else if (r.LOGIK_SIAP.includes('Lewat')) basePoints = 50;
            else basePoints = 20;

            let eotPenalty = 0;
            if (r.EOT && r.EOT !== "-" && r.EOT.trim() !== "") eotPenalty = 15;

            let voScore = 0;
            let voType = "NEUTRAL";
            const voTambah = parseCurrency(r["VO TAMBAHAN"]);
            const voKurang = parseCurrency(r["VO PENGURANGAN"]);
            const pelarasanSST = parseCurrency(r["PELARASAN SST"]);
            const netCostImpact = (voTambah + pelarasanSST) - voKurang;

            if (kosAsal > 0) {
              const percentChange = (netCostImpact / kosAsal) * 100;
              if (netCostImpact > 0) { voScore = -(Math.min(30, percentChange)); voType = "PENALTY"; }
              else if (netCostImpact < 0) { voScore = Math.min(30, Math.abs(percentChange)); voType = "BONUS"; }
            }

            let tierMultiplier = 1;
            let tierLabel = "KECIL";
            let tierColor = "bg-gray-100 text-gray-600";

            if (kosAkhir <= 50000) { tierMultiplier = 1; tierLabel = "KECIL"; }
            else if (kosAkhir <= 500000) { tierMultiplier = 3; tierLabel = "MED"; tierColor = "bg-blue-100 text-blue-700"; }
            else { tierMultiplier = 6; tierLabel = "MEGA"; tierColor = "bg-purple-100 text-purple-700"; }

            const maxPotentialScore = 100 * tierMultiplier * roleMultiplier;
            let projectScoreRaw = (basePoints - eotPenalty + voScore);
            projectScoreRaw = Math.max(0, projectScoreRaw);
            const finalScore = (projectScoreRaw * tierMultiplier) * roleMultiplier;

            stats[name].totalProjects++;
            stats[name].totalValue += kosAkhir;
            stats[name].totalActualScore += finalScore;
            stats[name].totalMaxScore += maxPotentialScore;

            if (r.LOGIK_SIAP && r.LOGIK_SIAP.includes("Siap")) {
              stats[name].completedProjects += 1;
            }

            stats[name].projects.push({
              title: r.NAMA_PAPARAN,
              score: finalScore,
              kos: kosAkhir,
              maxScore: maxPotentialScore, 
              status: r.LOGIK_SIAP,
              tierLabel: tierLabel,
              tierColor: tierColor,
              voType: voType,
              math: { base: basePoints, eot: eotPenalty, vo: Math.round(voScore), tier: tierMultiplier, role: roleMultiplier }
            });
          });
        });

        return Object.values(stats)
          .map((officer) => {

            // Kira percentage biasa (untuk paparan bar "Kecekapan Keseluruhan")
            const percentage = officer.totalMaxScore > 0 
                ? ((officer.totalActualScore / officer.totalProjects) / (officer.totalMaxScore / officer.totalProjects)) * 100 
                : 0;
            
            // --- GUNA LOGIK BARU DI SINI ---
            // Kita pass: % kecekapan, Total Skor Terkumpul, Total Nilai Projek, Bilangan Projek
            const enrichInfo = getFairGrade(
                percentage, 
                officer.totalActualScore, 
                officer.totalValue, 
                officer.totalProjects
            );

            const kpiIndex = officer.totalProjects > 0 ? (officer.totalActualScore / officer.totalProjects) : 0;

            return { 
              ...officer, 
              kpiIndex, 
              kpiPercentage: percentage,  
              enrichTitle: enrichInfo.title,
              enrichSubTitle: enrichInfo.subTitle, 
              rankColor: enrichInfo.color,
              badgeColor: enrichInfo.badge,
              icon: enrichInfo.icon 
            };
          })
          // SORTING:
          // PENTING: Sort ikut Total Actual Score (Points), bukan percentage.
          // Ini memastikan orang yang kumpul point banyak (261) duduk atas orang point sikit (100)
          .sort((a, b) => b.totalActualScore - a.totalActualScore);

      }, [data, selectedYear, staffData, jawatanData]);

      const top3 = officerStats.slice(0, 3);
      const others = officerStats.slice(3);
      const formatMoney = (val) => val.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      // (Render logic remains same, skipping for brevity but assuming user has full component)
      // NOTE: Sila pastikan anda salin bahagian Render UI FairGamificationEngine dari kod asal jika perlu, 
      // kerana saya fokus pada logik 'parseCurrency' di atas. Untuk menjimat ruang saya paparkan versi ringkas.
      if (Object.keys(officerStats).length === 0) return (<div className="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-10 text-center mb-10 shadow-sm animate-fade-in"><h3 className="text-xl text-slate-500 font-bold uppercase">Tiada Rekod Pembangunan</h3><p className="text-sm text-slate-400 mt-2">Tiada data Pembangunan untuk tahun {selectedYear}.</p></div>);

      const getRankStyle = (index) => { if (index === 0) return "bg-white border-t-8 border-yellow-400 shadow-[0_20px_50px_-12px_rgba(250,204,21,0.3)] scale-[1.02] z-10 ring-1 ring-yellow-100"; if (index === 1) return "bg-white border-t-8 border-slate-400 shadow-[0_20px_50px_-12px_rgba(148,163,184,0.3)]"; if (index === 2) return "bg-white border-t-8 border-orange-400 shadow-[0_20px_50px_-12px_rgba(251,146,60,0.3)]"; return "bg-slate-50 border border-slate-200 hover:shadow-lg hover:bg-white transition-all"; };
      const getMedal = (index) => { if (index === 0) return <span className="text-5xl filter drop-shadow-md cursor-default">ðŸ‘‘</span>; if (index === 1) return <span className="text-5xl filter drop-shadow-md cursor-default">ðŸ¥ˆ</span>; if (index === 2) return <span className="text-5xl filter drop-shadow-md cursor-default">ðŸ¥‰</span>; return <span className="text-2xl font-black text-slate-300">#{index + 1}</span>; }

      return (
        <div className="space-y-8 mb-16 animate-fade-in font-sans">

          {/* HEADER: ROYAL BANNER */}
          <div className="relative rounded-2xl p-6 bg-gradient-to-r from-slate-900 to-blue-900 text-white shadow-xl overflow-hidden">
            <div className="absolute right-0 top-0 h-full w-1/2 bg-white/5 skew-x-12 transform origin-bottom-left"></div>
            <div className="relative z-10 flex flex-col md:flex-row justify-between items-center gap-4">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-white/10 rounded-xl backdrop-blur-sm border border-white/20 shadow-inner">
                  <svg className="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                </div>
                <div>
                  <h2 className="text-2xl font-black uppercase tracking-tight">Prestasi Pembangunan Sistem</h2>
                  <p className="text-sm text-blue-200 font-medium">Analisis KPI Tahun {selectedYear === "All" ? "Keseluruhan" : selectedYear}</p>
                </div>
              </div>

              <div className="flex flex-col items-end">
                <span className="text-[10px] font-bold text-blue-300 uppercase tracking-widest mb-1">Status Sistem</span>
                <span className="px-3 py-1 bg-green-500/20 rounded-lg text-xs font-bold text-green-300 border border-green-500/30 backdrop-blur-md">
                  Mod Akauntabiliti Pegawai Aktif
                </span>
              </div>
            </div>
          </div>

          {/* GRID KAD PRESTASI (TOP 3 SAHAJA) */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 mb-8">
            {top3.map((officer, index) => {
              return (
                <div key={index} className={`relative group rounded-3xl p-6 transition-all duration-300 flex flex-col justify-between ${getRankStyle(index)}`}>

                  {/* HEADER KAD - NAMA PENUH DI SINI */}
                  <div className="flex justify-between items-start mb-6">
                    <div className="flex items-center gap-4">
                      <div className={`w-16 h-16 rounded-2xl flex items-center justify-center text-2xl font-bold text-white shadow-md ${officer.rankColor} relative flex-shrink-0`}>
                        {officer.name.charAt(0)}
                        {officer.isOfficer && (
                          <div className="absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 rounded-full p-1 shadow-sm border border-white">
                            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                          </div>
                        )}
                      </div>
                      <div>
                        {/* UBAH SINI: Buang line-clamp-1 supaya nama penuh keluar */}
                        <h3 className="font-black text-slate-800 text-sm leading-tight uppercase w-full">
                          {officer.name}
                        </h3>
                        <div className="flex flex-col mt-1">
                          <span className={`inline-block w-fit px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wide ${officer.  badgeColor}`}>{officer.enrichTitle}/{officer.enrichSubTitle} - {officer.icon}</span>
                          {/* UBAH SINI: Nama Jawatan Penuh */}
                          <span className="text-[9px] text-slate-400 font-bold mt-0.5 leading-tight">{officer.role}</span>
                        </div>
                      </div>
                    </div>
                    <div className="transform transition-transform group-hover:scale-125 duration-300">{getMedal(index)}</div>
                  </div>

                  {/* SKOR GERGASI */}
                  <div className="text-center py-5 border-t border-b border-slate-100 bg-slate-50/50 rounded-xl mb-5 group-hover:bg-slate-100 transition-colors">
                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.25em] mb-1">Skor Prestasi</div>
                    <div className="text-7xl font-black text-slate-800 tracking-tighter drop-shadow-sm group-hover:text-blue-600 transition-colors leading-none">{Math.round(officer.kpiIndex)}</div>
                    <div className="text-[10px] text-slate-400 font-bold mt-2 flex items-center justify-center gap-1">
                      Mata Purata
                      {officer.isOfficer && <span className="text-yellow-600 bg-yellow-50 px-1 rounded text-[8px] border border-yellow-100">+50% Bonus P&P</span>}
                    </div>
                    <div className="text-[10px] text-slate-400 font-bold mt-2 flex items-center justify-center gap-1">
                      <span className="text-slate-600 bg-slate-200 px-1.5 rounded text-[9px]">{officer.kpiPercentage.toFixed(0)}%</span>
                      Kecekapan Keseluruhan
                    </div>
                  </div>

                  {/* METRIK SOKONGAN */}
                  <div className="grid grid-cols-2 gap-4 mb-5">
                    <div className="p-2">
                      <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Nilai Projek</div>
                      <div className="text-xs font-black text-slate-700 truncate">RM {formatMoney(officer.totalValue)}</div>
                    </div>
                    <div className="p-2 text-right">
                      <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1">Bil. Projek</div>
                      <div className="text-xs font-black text-slate-700">{officer.totalProjects} Sistem</div>
                    </div>
                  </div>

                  {/* PROGRESS BAR */}
                  <div className="relative mb-2">
                    <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1.5">
                      <span>Kadar Siap</span>
                      <span>{Math.round((officer.completedProjects / officer.totalProjects) * 100)}%</span>
                    </div>
                    <div className="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                      <div className={`h-full ${officer.rankColor} rounded-full shadow-sm`} style={{ width: `${(officer.completedProjects / officer.totalProjects) * 100}%` }}></div>
                    </div>
                  </div>

                  {/* HOVER DETAILS DENGAN TOOLTIPS */}
                  <div className="absolute inset-0 bg-white/95 backdrop-blur-xl rounded-3xl p-5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20 flex flex-col border-2 border-slate-200 shadow-2xl translate-y-4 group-hover:translate-y-0">
                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-slate-100">
                      <h4 className="font-black text-slate-800 text-[10px] uppercase tracking-widest">DNA SKOR {selectedYear}</h4>
                      <div className="px-2 py-0.5 bg-slate-100 rounded text-[9px] font-bold text-slate-500">{officer.projects.length} Projek</div>
                    </div>
                    <div className="space-y-3 overflow-y-auto custom-scroll flex-1 pr-1">
                      {officer.projects.sort((a, b) => b.score - a.score).map((p, i) => (
                        <div key={i} className="bg-slate-50 rounded-xl p-3 border border-slate-200 hover:border-blue-300 transition-colors">
                          <div className="flex justify-between items-start mb-2">
                            <div className="w-[75%]">
                              <div className="font-bold text-slate-800 text-[10px] leading-tight">{p.title}</div>
                              <div className="text-[9px] text-slate-400 font-mono mt-0.5">RM {formatMoney(p.kos)}</div>
                            </div>
                            <span className={`px-1.5 py-0.5 rounded-[4px] text-[8px] font-black uppercase tracking-wider ${p.tierColor}`}>{p.tierLabel}</span>
                          </div>
                          {/* KOTAK PENGIRAAN DENGAN TOOLTIPS */}
                          <div className="bg-white rounded-lg border border-slate-100 p-2 shadow-sm">
                            <div className="flex items-center justify-between border-b border-dashed border-slate-200 pb-2 mb-2">

                              {/* TOOLTIP 1: STATUS */}
                              <div className="text-center px-2 border-r border-slate-100 relative group/tip">
                                <div className="text-[10px] font-black text-slate-700">{p.math.base}</div>
                                <div className="text-[6px] uppercase font-bold text-slate-400 border-b border-dotted border-slate-300 cursor-help">Status</div>
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover/tip:block bg-slate-800 text-white text-[8px] p-2 rounded w-24 z-50 shadow-xl">
                                  <div className="font-bold border-b border-white/20 pb-1 mb-1 text-yellow-300">Mata Asas</div>
                                  Siap (CPC): 100<br />Dalam Jadual: 90<br />Lewat: 50<br />Lain-lain: 20
                                </div>
                              </div>

                              {/* TOOLTIP 2: EOT */}
                              <div className="text-center px-2 border-r border-slate-100 relative group/tip">
                                <div className={`text-[10px] font-black ${p.math.eot > 0 ? 'text-red-500' : 'text-slate-300'}`}>-{p.math.eot}</div>
                                <div className="text-[6px] uppercase font-bold text-slate-400 border-b border-dotted border-slate-300 cursor-help">EOT</div>
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover/tip:block bg-slate-800 text-white text-[8px] p-2 rounded w-24 z-50 shadow-xl">
                                  <div className="font-bold border-b border-white/20 pb-1 mb-1 text-red-300">Penalti EOT</div>
                                  Tolak 15 mata jika projek mempunyai Lanjutan Masa (EOT).
                                </div>
                              </div>

                              {/* TOOLTIP 3: VO */}
                              <div className="text-center px-2 relative group/tip">
                                <div className={`text-[10px] font-black ${p.math.vo >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>
                                  {p.math.vo > 0 ? `+${p.math.vo}` : p.math.vo}
                                </div>
                                <div className="text-[6px] uppercase font-bold text-slate-400 border-b border-dotted border-slate-300 cursor-help">VO</div>
                                <div className="absolute bottom-full right-0 mb-1 hidden group-hover/tip:block bg-slate-800 text-white text-[8px] p-2 rounded w-32 z-50 shadow-xl text-left">
                                  <div className="font-bold border-b border-white/20 pb-1 mb-1 text-emerald-300">Impak Kos (VO)</div>
                                  <span className="text-green-300">Jimat:</span> Tambah mata<br />
                                  <span className="text-red-300">Lebih:</span> Tolak mata<br />
                                  (Max +/- 30 mata berdasarkan % perubahan)
                                </div>
                              </div>

                            </div>
                            {/* BARIS BAWAH: GANDAAN & TOTAL SCORE (VERSI PADAT) */}
                            <div className="flex items-center justify-between pt-2 border-t border-dashed border-slate-100 mt-2">

                              {/* TOOLTIP 4: GANDAAN (MINI SIZE) */}
                              <div className="flex items-center gap-1 relative group/tip cursor-help">
                                <span className="text-[8px] font-bold text-slate-400 border-b border-dotted border-slate-300">Gandaan:</span>

                                {/* Tier Badge */}
                                <span className="text-[9px] font-black text-purple-600 bg-purple-50 px-1 rounded border border-purple-100">
                                  x{p.math.tier}
                                </span>

                                <span className="text-[8px] text-slate-300">x</span>

                                {/* Role Badge */}
                                <span className="text-[9px] font-black text-orange-600 bg-orange-50 px-1 rounded border border-orange-100">
                                  x{p.math.role}
                                </span>

                                {/* --- TOOLTIP KECIL & PADAT (W-28 SAHAJA) --- */}
                                <div className="absolute bottom-full left-0 mb-1 hidden group-hover/tip:block bg-slate-900/95 backdrop-blur-sm text-white text-[8px] p-2 rounded-lg w-28 z-50 shadow-xl border border-white/10 pointer-events-none">
                                  <div className="space-y-1.5">
                                    {/* Info Skala */}
                                    <div>
                                      <span className="text-purple-300 font-bold block mb-0.5 border-b border-white/10 pb-0.5">Skala (Nilai)</span>
                                      <div className="flex justify-between opacity-80"><span>&lt; RM50k</span><span>x1</span></div>
                                      <div className="flex justify-between opacity-80"><span>&lt; RM500k</span><span>x3</span></div>
                                      <div className="flex justify-between opacity-80"><span>&gt; RM500k</span><span>x6</span></div>
                                    </div>
                                    {/* Info Peranan */}
                                    <div>
                                      <span className="text-orange-300 font-bold block mb-0.5 border-b border-white/10 pb-0.5">Peranan</span>
                                      <div className="flex justify-between opacity-80"><span>Staf</span><span>x1</span></div>
                                      <div className="flex justify-between opacity-80"><span>Ketua</span><span>x1.5</span></div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {/* TOTAL SCORE */}
                              <span className="text-xs font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 shadow-sm">
                                = {Math.round(p.score)}
                              </span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* SENARAI RANKING SETERUSNYA (LIST VIEW) */}
          {others.length > 0 && (
            <div className="glass-card p-6 border-0 bg-white/40">
              <h3 className="text-xs font-black uppercase text-slate-500 tracking-[0.2em] mb-4 flex items-center gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
                Senarai Keseluruhan
              </h3>
              <div className="flex flex-col gap-3">
                {others.map((officer, index) => (
                  <div key={index + 3} className="flex flex-col md:flex-row items-center justify-between p-4 bg-white/60 hover:bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all duration-300 group">

                    {/* INFO PEGAWAI */}
                    <div className="flex items-center gap-4 w-full md:w-1/3">
                      <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 text-slate-500 font-black text-xs">
                        #{index + 4}
                      </div>
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm ${officer.rankColor}`}>
                          {officer.name.charAt(0)}
                        </div>
                        <div className="min-w-0">
                          <div className="font-bold text-slate-800 text-xs uppercase truncate">{officer.name}</div>
                          <div className="text-[9px] text-slate-400 font-bold uppercase">{officer.role}</div>
                        </div>
                      </div>
                    </div>

                    {/* BADGE LEVEL */}
                    <div className="flex items-center gap-2 w-full md:w-1/4 justify-start md:justify-center mt-2 md:mt-0">
                      <span className={`px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-wide border ${officer.badgeColor}`}>
                        {officer.icon} {officer.level}
                      </span>
                    </div>

                    {/* STATISTIK RINGKAS */}
                    <div className="flex items-center gap-6 w-full md:w-1/3 justify-between md:justify-end mt-2 md:mt-0">
                      <div className="text-right">
                        <div className="text-[8px] font-bold text-slate-400 uppercase">Projek</div>
                        <div className="text-xs font-black text-slate-700">{officer.totalProjects}</div>
                      </div>
                      <div className="text-right">
                        <div className="text-[8px] font-bold text-slate-400 uppercase">Nilai</div>
                        <div className="text-xs font-black text-slate-700">RM {formatMoney(officer.totalValue)}</div>
                      </div>
                      <div className="text-right pl-4 border-l border-slate-200">
                        <div className="text-[8px] font-bold text-slate-400 uppercase">Mata</div>
                        <div className="text-xl font-black text-blue-600 leading-none">{Math.round(officer.kpiIndex)}</div>
                      </div>
                    </div>

                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // --- 5. KOMPONEN BARU: ENJIN GAMIFIKASI KHAS PENYELENGGARAAN (VERSI PRO: HEARTBEAT LOGIC) ---
    const MaintenanceGamificationEngine = ({ data, staffData, jawatanData, selectedYear }) => {

      // 1. HELPER: Parse Currency
      const parseCurrency = (value) => {
        if (typeof value === "number") return value;
        if (!value) return 0;
        return parseFloat(value.toString().replace(/[^0-9.-]+/g, "")) || 0;
      };

      const officerStats = React.useMemo(() => {
        // 2. Init variables dalam useMemo
        const stats = {}; 
        const today = new Date();

        // 3. Mapping Helpers
        const roleDefinitionMap = {};
        if (jawatanData && Array.isArray(jawatanData)) {
          jawatanData.forEach(j => {
            if (j["SINGKATAN"] && j["JAWATAN"]) 
              roleDefinitionMap[j["SINGKATAN"].trim().toUpperCase()] = j["JAWATAN"].trim().toUpperCase();
          });
        }

        const staffMap = {};
        if (staffData && Array.isArray(staffData)) {
          staffData.forEach(s => {
            if (s["NAMA PENUH"] && s["JAWATAN"]) {
              const nama = s["NAMA PENUH"].trim();
              const singkatan = s["JAWATAN"].trim().toUpperCase();
              staffMap[nama] = roleDefinitionMap[singkatan] || singkatan;
            }
          });
        }

        // --- MULA LOOP DATA ---
        data.forEach((r) => {
          // Filter Tahun
          if (selectedYear !== "All" && String(r.TAHUN_MULA) !== String(selectedYear)) return;
          
          // Filter Kategori
          const kategori = (r["KATEGORI PERKHIDMATAN"] || "").toUpperCase();
          if (!kategori.includes("PENYELENGGARAAN")) return; 

          // Filter Nama
          const rawNames = r["PEGAWAI BERTANGGUNGJAWAB"] || r.PEGAWAI_NAMA || "";
          if (!rawNames || rawNames === "-" || rawNames === "Unknown") return;
          
          const names = rawNames.split(",").map((n) => n.trim());

          names.forEach((name) => {
            if (!name) return;

            // Logic Role
            const userRole = staffMap[name] || "UNKNOWN";
            let roleMultiplier = 1.0;
            let isOfficer = false;

            if (userRole.includes("PEGAWAI") && !userRole.includes("PENOLONG")) { 
                roleMultiplier = 1.5; isOfficer = true; 
            }
            if (roleMultiplier === 1.0 && ["PTM", "KP", "P(BPM)"].some(k => userRole.includes(k))) { 
                roleMultiplier = 1.5; isOfficer = true; 
            }

            // Init User Stats
            if (!stats[name]) {
              stats[name] = { 
                name, 
                role: userRole, 
                isOfficer, 
                totalProjects: 0, 
                completedProjects: 0, 
                totalValue: 0, 
                totalScore: 0, 
                totalPaymentProgress: 0,
                avgHealth: 0,       
                totalRankPoints: 0, 
                projects: [], 
                level: "Junior" 
              };
            }

            // --- CALCULATION LOGIC ---

            // 1. Progress Masa
            const dateStart = r.TARIKH_MULA_ISO ? new Date(r.TARIKH_MULA_ISO) : null;
            const dateEnd = r.TARIKH_SIAP_SEMASA_ISO ? new Date(r.TARIKH_SIAP_SEMASA_ISO) : null;
            
            let timeProgress = 0;
            if (dateStart && dateEnd) {
              const totalDuration = dateEnd.getTime() - dateStart.getTime();
              const elapsed = today.getTime() - dateStart.getTime();
              if (totalDuration > 0) {
                timeProgress = (elapsed / totalDuration) * 100;
              }
            }
            if (timeProgress > 100) timeProgress = 100;
            if (timeProgress < 0) timeProgress = 0;

            // 2. Progress Kewangan & Kos
            const financialProgress = parseFloat(r.PROGRESS_MASA || r.PERATUS_SIAP || 0);
            const kosAkhir = parseCurrency(r.KOS_AKHIR || r.JUMLAH);

            // 3. Logic Kesihatan (Gap)
            const gap = timeProgress - financialProgress;
            
            let healthScore = 100;
            let statusNote = "Sihat";

            if (r.LOGIK_SIAP === 'Siap (CPC)' || financialProgress >= 100) {
                healthScore = 100;
                statusNote = "Selesai";
            } 
            else if (r.LOGIK_SIAP && r.LOGIK_SIAP.includes('Lewat')) {
                healthScore = 50; 
                statusNote = "Lewat Jadual";
            }
            else {
                if (gap > 40) { healthScore = 40; statusNote = "Kritikal (>40%)"; } 
                else if (gap > 25) { healthScore = 70; statusNote = "Perlahan (>25%)"; } 
                else if (gap > 15) { healthScore = 85; statusNote = "Kena Kejar (>15%)"; } 
                else { healthScore = 100; statusNote = "Cemerlang"; }
            }

            // 4. Logic Gamification (Ranking Points)
            let tierMultiplier = 1;
            let tierLabel = "RUTIN";
            let tierColor = "bg-slate-100 text-slate-600";

            if (kosAkhir > 500000) { 
                tierMultiplier = 3; tierLabel = "KRITIKAL"; tierColor = "bg-pink-100 text-pink-700";
            } else if (kosAkhir > 100000) { 
                tierMultiplier = 2; tierLabel = "UTAMA"; tierColor = "bg-indigo-100 text-indigo-700";
            }

            const rankPoints = healthScore * tierMultiplier; 

            // Update Accumulators
            stats[name].totalProjects += 1;
            stats[name].totalValue += kosAkhir;
            stats[name].avgHealth += healthScore;
            stats[name].totalRankPoints += rankPoints;
            stats[name].totalPaymentProgress += financialProgress; // Update accumulator payment

            if (healthScore >= 80) stats[name].completedProjects += 1; 

            stats[name].projects.push({
              title: r.NAMA_PAPARAN,
              score: rankPoints, 
              health: healthScore, 
              kos: kosAkhir,
              progress: financialProgress,
              timeProgress: Math.round(timeProgress),
              gap: Math.round(gap),
              statusNote: statusNote,
              status: r.LOGIK_SIAP,
              tierLabel, 
              tierColor,
              math: { base: healthScore, tier: tierMultiplier } // Simpan untuk tooltip
            });

          }); // End names loop
        }); // End data loop

        // Final Mapping & Sorting
        return Object.values(stats)
          .map((officer) => {
            // KPI Sebenar = Purata Kesihatan (0-100)
            const realHealthIndex = officer.totalProjects > 0 
                ? Math.round(officer.avgHealth / officer.totalProjects) 
                : 0;
            
            // Purata Bayaran (Untuk UI Bar)
            const avgPayment = officer.totalProjects > 0 
                ? Math.round(officer.totalPaymentProgress / officer.totalProjects) 
                : 0;

            // Sorting Points = Total Health * Size Multiplier
            const totalPoints = officer.totalRankPoints;

            // Tentukan Badge Level
            let level = "IT SUPPORT";
            let rankColor = "bg-cyan-500";
            let badgeColor = "bg-cyan-50 text-cyan-700 border border-cyan-100";
            let icon = "ðŸ”§";

            if (totalPoints > 800) { 
                level = "MASTER GUARDIAN"; rankColor = "bg-purple-600"; badgeColor = "bg-purple-50 text-purple-700"; icon = "ðŸ‘‘"; 
            } 
            else if (totalPoints > 500) { 
                level = "SENIOR SPECIALIST"; rankColor = "bg-pink-600"; badgeColor = "bg-pink-50 text-pink-700"; icon = "ðŸ›¡ï¸"; 
            } 
            else if (totalPoints > 300) { 
                level = "SYSTEM ADMIN"; rankColor = "bg-teal-600"; badgeColor = "bg-teal-50 text-teal-700"; icon = "ðŸ”Œ"; 
            }

            return { 
                ...officer, 
                kpiIndex: realHealthIndex, 
                avgPayment: avgPayment, // Tambah field ini
                sortingPoints: totalPoints, 
                level, 
                rankColor, 
                badgeColor, 
                icon 
            };
          })
          .sort((a, b) => b.sortingPoints - a.sortingPoints); 

      }, [data, selectedYear, staffData, jawatanData]);

      const top3 = officerStats.slice(0, 3);
      const others = officerStats.slice(3);
      const formatMoney = (val) => val.toLocaleString('ms-MY', { minimumFractionDigits: 2 });
      // (Helper UI dan Render UI skip, anggap sama macam kod asal, cuma guna data yang dah selamat dari parseCurrency)
      if (officerStats.length === 0) return (<div className="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-10 text-center mb-10 shadow-sm animate-fade-in"><h3 className="text-xl text-slate-500 font-bold uppercase">Tiada Rekod Penyelenggaraan</h3><p className="text-sm text-slate-400 mt-2">Tiada data penyelenggaraan aktif untuk tahun {selectedYear}.</p></div>);

      const getRankStyle = (index) => { if (index === 0) return "bg-white border-t-8 border-yellow-400 shadow-[0_20px_50px_-12px_rgba(250,204,21,0.3)] scale-[1.02] z-10 ring-1 ring-yellow-100"; if (index === 1) return "bg-white border-t-8 border-slate-400 shadow-[0_20px_50px_-12px_rgba(148,163,184,0.3)]"; if (index === 2) return "bg-white border-t-8 border-orange-400 shadow-[0_20px_50px_-12px_rgba(251,146,60,0.3)]"; return ""; };
      const getMedal = (index) => { if (index === 0) return <span className="text-5xl filter drop-shadow-md cursor-default">ðŸ‘‘</span>; if (index === 1) return <span className="text-5xl filter drop-shadow-md cursor-default">ðŸ¥ˆ</span>; if (index === 2) return <span className="text-5xl filter drop-shadow-md cursor-default">ðŸ¥‰</span>; return null; }

      return (
        <div className="space-y-8 mb-16 animate-fade-in font-sans">

          {/* HEADER: MAINTENANCE THEME (Deep Pink/Purple) - DENGAN TOOLTIP FORMULA */}
          <div className="relative rounded-2xl shadow-xl mb-8">

            {/* 2. Layer Latar Belakang (Absolut): Di sini kita letak overflow-hidden untuk potong hiasan skew */}
            <div className="absolute inset-0 rounded-2xl bg-gradient-to-r from-slate-900 via-purple-900 to-pink-800 overflow-hidden">
              <div className="absolute right-0 top-0 h-full w-1/2 bg-white/5 skew-x-12 transform origin-bottom-left"></div>
            </div>

            {/* 3. Layer Kandungan (Relative): Duduk atas background, TIADA overflow supaya popup boleh keluar */}
            <div className="relative p-6 text-white z-10">
              <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="flex items-center gap-4">

                  {/* Ikon Utama */}
                  <div className="p-3 bg-white/10 rounded-xl backdrop-blur-sm border border-white/20 shadow-inner">
                    <svg className="w-8 h-8 text-pink-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                  </div>

                  {/* Tajuk & Tooltip Trigger */}
                  <div className="flex flex-col">
                    <div className="flex items-center gap-2">
                      <h2 className="text-2xl font-black uppercase tracking-tight">Kesihatan Penyelenggaraan</h2>

                      {/* --- IKON INFO (TRIGGER TOOLTIP) --- */}
                      <div className="relative group/info cursor-help">
                        <svg className="w-5 h-5 text-pink-300/70 hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>

                        {/* --- ISI KANDUNGAN TOOLTIP (POSITION: KANAN) --- */}
                        {/* left-full = tolak ke kanan, ml-4 = jarak sikit, top-1/2 = tengah vertical */}
                        <div className="absolute left-full top-1/2 -translate-y-1/2 ml-4 hidden group-hover/info:block w-72 bg-slate-900/95 backdrop-blur-xl border border-white/10 p-4 rounded-xl shadow-2xl z-[100] text-left animate-fade-in">

                          {/* Arrow (Menunjuk ke Kiri) */}
                          <div className="absolute top-1/2 -translate-y-1/2 -left-1.5 w-3 h-3 bg-slate-900 border-b border-l border-white/10 rotate-45"></div>

                          <div className="space-y-3">
                            <div className="border-b border-white/10 pb-2 mb-1">
                              <span className="text-[10px] font-black text-pink-400 uppercase tracking-widest block">Mekanisme Pemarkahan</span>
                              <span className="text-[9px] text-slate-400 italic">Formula: (Mata Asas - Penalti) x Gandaan</span>
                            </div>

                            {/* Seksyen 1: Denyut Nadi */}
                            <div>
                              <div className="flex items-center gap-1.5 text-[9px] font-bold text-slate-200 mb-1">
                                <span className="w-1 h-1 rounded-full bg-blue-400"></span>
                                Mata Asas (Jurang Masa vs Bayaran)
                              </div>
                              <div className="text-[8px] space-y-1 text-slate-400 pl-2.5 border-l border-white/10">
                                <div className="flex justify-between"><span>Jurang â‰¤ 15% (Seiring)</span><span className="text-emerald-400 font-bold">100 Mata</span></div>
                                <div className="flex justify-between"><span>Jurang 15% - 30% (Perlahan)</span><span className="text-orange-400 font-bold">80 Mata</span></div>
                                <div className="flex justify-between"><span>Jurang > 30% (Tericir)</span><span className="text-red-400 font-bold">60 Mata</span></div>
                                <div className="flex justify-between"><span>Lewat Jadual/Overdue</span><span className="text-red-500 font-bold">40 Mata</span></div>
                              </div>
                            </div>

                            {/* Seksyen 2: Gandaan */}
                            <div>
                              <div className="flex items-center gap-1.5 text-[9px] font-bold text-slate-200 mb-1">
                                <span className="w-1 h-1 rounded-full bg-purple-400"></span>
                                Gandaan Skala (Nilai Kontrak)
                              </div>
                              <div className="text-[8px] space-y-1 text-slate-400 pl-2.5 border-l border-white/10">
                                <div className="flex justify-between"><span>Kritikal (&gt;RM500k)</span><span className="text-pink-400 font-bold">x5</span></div>
                                <div className="flex justify-between"><span>Utama (&gt;RM100k)</span><span className="text-purple-400 font-bold">x3</span></div>
                                <div className="flex justify-between"><span>Rutin (&lt;RM100k)</span><span className="text-slate-300 font-bold">x1</span></div>
                              </div>
                            </div>

                            {/* Seksyen 3: Peranan */}
                            <div>
                              <div className="flex items-center gap-1.5 text-[9px] font-bold text-slate-200 mb-1">
                                <span className="w-1 h-1 rounded-full bg-orange-400"></span>
                                Gandaan Peranan
                              </div>
                              <div className="flex justify-between text-[8px] text-slate-400 pl-2.5">
                                <span>Pegawai/Ketua: <strong className="text-orange-400">x1.5</strong></span>
                                <span>Pelaksana: <strong className="text-slate-300">x1.0</strong></span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <p className="text-sm text-pink-200 font-medium">Analisis Prestasi & Pematuhan Kontrak bagi Tahun {selectedYear === "All" ? "Keseluruhan" : selectedYear}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* GRID KAD PRESTASI (TOP 3) */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 mb-8">
            {top3.map((officer, index) => {
              return (
                <div key={index} className={`relative group rounded-3xl p-6 transition-all duration-300 flex flex-col justify-between ${getRankStyle(index)}`}>

                  {/* HEADER KAD */}
                  <div className="flex justify-between items-start mb-6">
                    <div className="flex items-center gap-4">
                      <div className={`w-16 h-16 rounded-2xl flex items-center justify-center text-2xl font-bold text-white shadow-md ${officer.rankColor} relative flex-shrink-0`}>
                        {officer.name.charAt(0)}
                        {officer.isOfficer && (
                          <div className="absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 rounded-full p-1 shadow-sm border border-white">
                            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                          </div>
                        )}
                      </div>
                      <div>
                        <h3 className="font-black text-slate-800 text-sm leading-tight uppercase w-full">{officer.name}</h3>
                        <div className="flex flex-col mt-1">
                          <span className={`inline-block w-fit px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wide ${officer.badgeColor}`}>{officer.level}</span>
                          <span className="text-[9px] text-slate-400 font-bold mt-0.5 leading-tight">{officer.role}</span>
                        </div>
                      </div>
                    </div>
                    <div className="transform transition-transform group-hover:scale-125 duration-300">{getMedal(index)}</div>
                  </div>

                  {/* SKOR */}
                  <div className="text-center py-5 border-t border-b border-slate-100 bg-slate-50/50 rounded-xl mb-5 group-hover:bg-slate-100 transition-colors">
                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.25em] mb-1">Indeks Kesihatan (KPI)</div>
                    <div className="text-7xl font-black text-slate-800 tracking-tighter drop-shadow-sm group-hover:text-pink-600 transition-colors leading-none">{Math.round(officer.kpiIndex)}</div>
                    <div className="text-[10px] text-slate-400 font-bold mt-2">Mata Kualiti Servis</div>
                  </div>

                  {/* INFO BAYARAN */}
                  <div className="bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100">
                    <div className="flex justify-between items-center mb-2 pb-2 border-b border-dashed border-slate-200">
                      <span className="text-[9px] font-bold text-slate-400 uppercase">Nilai Servis</span>
                      <span className="text-xs font-black text-slate-700">RM {formatMoney(officer.totalValue)}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-[9px] font-bold text-slate-400 uppercase">Tuntutan Bayaran</span>
                      <span className={`text-xs font-black px-2 py-0.5 rounded ${officer.avgPayment > 80 ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}`}>
                        {officer.avgPayment}%
                      </span>
                    </div>
                  </div>

                  {/* HOVER DETAILS (CANGGIH: ADA HEALTH STATUS) */}
                  <div className="absolute inset-0 bg-white/95 backdrop-blur-xl rounded-3xl p-5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20 flex flex-col border-2 border-slate-200 shadow-2xl translate-y-4 group-hover:translate-y-0">
                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-slate-100">
                      <h4 className="font-black text-slate-800 text-[10px] uppercase tracking-widest">ANALISIS PROJEK</h4>
                      <div className="px-2 py-0.5 bg-slate-100 rounded text-[9px] font-bold text-slate-500">{officer.projects.length} Kontrak</div>
                    </div>
                    <div className="space-y-3 overflow-y-auto custom-scroll flex-1 pr-1">
                      {officer.projects.slice().sort((a, b) => b.score - a.score).map((p, i) => (
                        <div key={i} className="bg-slate-50 rounded-xl p-3 border border-slate-200 hover:border-pink-300 transition-colors">
                          {/* Tajuk & Nilai */}
                          <div className="flex justify-between items-start mb-2">
                            <div className="w-[75%]">
                              <div className="font-bold text-slate-800 text-[10px] leading-tight">{p.title}</div>
                              <div className="text-[9px] text-slate-400 font-mono mt-0.5">RM {formatMoney(p.kos)}</div>
                            </div>
                            <span className={`px-1.5 py-0.5 rounded-[4px] text-[8px] font-black uppercase tracking-wider ${p.tierColor}`}>{p.tierLabel}</span>
                          </div>

                          {/* Health Indicator Bar */}
                          <div className="mb-2 bg-slate-100 rounded p-1.5 border border-slate-200">
                            <div className="flex justify-between text-[8px] font-bold text-slate-500 mb-1">
                              <span>Masa: {p.timeProgress}%</span>
                              <span>Bayar: {p.progress}%</span>
                            </div>
                            <div className="h-1.5 w-full bg-slate-300 rounded-full overflow-hidden relative">
                              {/* Bar Masa (Kelabu) */}
                              <div className="absolute top-0 left-0 h-full bg-slate-400 opacity-30" style={{ width: `${p.timeProgress}%` }}></div>
                              {/* Bar Bayaran (Warna ikut kesihatan) */}
                              <div className={`absolute top-0 left-0 h-full rounded-full ${p.gap > 30 ? 'bg-red-500' : p.gap > 15 ? 'bg-orange-500' : 'bg-emerald-500'}`} style={{ width: `${p.progress}%` }}></div>
                            </div>
                            <div className="mt-1 text-[8px] font-bold text-right italic" style={{ color: p.gap > 30 ? '#ef4444' : p.gap > 15 ? '#f97316' : '#10b981' }}>
                              {p.statusNote}
                            </div>
                          </div>

                          {/* Score Footer */}
                          <div className="flex items-center justify-between pt-2 border-t border-dashed border-slate-100">
                            <span className="text-[8px] text-slate-400 font-bold">Mata Asas: {p.math.base}</span>
                            <span className="text-xs font-black text-pink-600 bg-pink-50 px-2 py-0.5 rounded border border-pink-100 shadow-sm">= {Math.round(p.score)}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* SENARAI RANKING SETERUSNYA (#4 KE BAWAH) - DENGAN HOVER YANG KEMAS & BERSIH */}
          {others.length > 0 && (
            <div className="glass-card p-6 border-0 bg-white/40 mt-8">
              <h3 className="text-xs font-black uppercase text-slate-500 tracking-[0.2em] mb-4 flex items-center gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
                Senarai Pegawai Seterusnya
              </h3>
              <div className="flex flex-col gap-3">
                {others.map((officer, index) => (
                  <div key={index + 3} className="relative group/row">

                    {/* 1. KAD UTAMA (Kekal macam tuan nak) */}
                    <div className="flex flex-col md:flex-row items-center justify-between p-4 bg-white/60 hover:bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all duration-300 relative z-10 cursor-default">

                      {/* Info Pegawai */}
                      <div className="flex items-center gap-4 w-full md:w-1/3">
                        <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 text-slate-500 font-black text-xs">#{index + 4}</div>
                        <div className="flex items-center gap-3">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm ${officer.rankColor}`}>{officer.name.charAt(0)}</div>
                          <div className="min-w-0">
                            <div className="font-bold text-slate-800 text-xs uppercase truncate">{officer.name}</div>
                            <div className="text-[9px] text-slate-400 font-bold uppercase">{officer.role}</div>
                          </div>
                        </div>
                      </div>

                      {/* Info Bayaran */}
                      <div className="flex flex-col w-full md:w-1/4 justify-center px-4 border-l border-r border-slate-100 mt-2 md:mt-0">
                        <div className="flex justify-between text-[8px] font-bold text-slate-400 mb-1">
                          <span>Purata Bayaran</span>
                          <span className={officer.avgPayment < 50 ? 'text-red-500' : 'text-emerald-600'}>{officer.avgPayment}%</span>
                        </div>
                        <div className="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
                          <div className={`h-full ${officer.avgPayment < 50 ? 'bg-red-500' : 'bg-emerald-500'}`} style={{ width: `${officer.avgPayment}%` }}></div>
                        </div>
                      </div>

                      {/* Skor Akhir */}
                      <div className="flex items-center gap-6 w-full md:w-1/3 justify-between md:justify-end mt-2 md:mt-0">
                        <div className="text-right pl-4">
                          <div className="text-[8px] font-bold text-slate-400 uppercase">Mata</div>
                          <div className="text-xl font-black text-pink-600 leading-none">{Math.round(officer.kpiIndex)}</div>
                        </div>
                      </div>
                    </div>

                    {/* 2. HOVER DETAIL (VERSI KEMAS) */}
                    <div className="hidden group-hover/row:block absolute left-0 right-0 top-[90%] z-50 pt-2 animate-fade-in pointer-events-none group-hover/row:pointer-events-auto">
                      <div className="bg-white rounded-xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.1)] border border-slate-200 p-4 relative">

                        {/* Arrow kecil ke atas */}
                        <div className="absolute -top-1.5 left-10 w-3 h-3 bg-white border-t border-l border-slate-200 rotate-45"></div>

                        {/* Header Kecil */}
                        <div className="flex items-center justify-between border-b border-slate-100 pb-2 mb-2">
                          <span className="text-[9px] font-black uppercase text-slate-400 tracking-widest">Senarai Projek ({officer.projects.length})</span>
                          <span className="text-[8px] font-bold text-slate-300 italic">Formula: (Asas - Penalti) x Gandaan</span>
                        </div>

                        {/* Senarai Projek (Simple List) */}
                        <div className="space-y-2 max-h-64 overflow-y-auto custom-scroll">
                          {officer.projects.map((p, i) => (
                            <div key={i} className="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-pink-200 transition-colors">

                              {/* Kiri: Nama & Status */}
                              <div className="w-3/4 pr-2">
                                <div className="text-[9px] font-bold text-slate-700 line-clamp-1" title={p.title}>{p.title}</div>
                                <div className="flex items-center gap-2 mt-1">
                                  <span className={`text-[8px] font-black px-1.5 rounded ${p.tierColor}`}>{p.tierLabel}</span>
                                  <span className="text-[8px] text-slate-400 font-mono">RM {formatMoney(p.kos)}</span>
                                  {/* Status Pendek */}
                                  <span className={`text-[8px] font-bold ${p.statusNote.includes('Masalah') || p.statusNote.includes('Tericir') ? 'text-red-500' : 'text-emerald-500'}`}>
                                    â€¢ {p.statusNote}
                                  </span>
                                </div>
                              </div>

                              {/* Kanan: Kalkulator Ringkas */}
                              <div className="w-1/4 text-right border-l border-slate-200 pl-2">
                                <div className="text-[8px] text-slate-400 font-mono flex justify-end gap-1">
                                  <span title="Markah Asas">{p.math.base}</span>
                                  <span>x</span>
                                  <span title="Gandaan Tier" className="font-bold text-slate-600">{p.math.tier}</span>
                                </div>
                                <div className="text-[10px] font-black text-pink-600">
                                  {Math.round(p.score)}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>

                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const statusStyles = {
      "Siap (CPC)":
        "bg-emerald-100 text-emerald-800 border-emerald-200 hover:bg-emerald-200",
      "Siap (Lewat)":
        "bg-orange-100 text-orange-800 border-orange-200 hover:bg-orange-200", // Warna oren untuk amaran lembut
      "Lewat (Overdue)":
        "bg-red-100 text-red-800 border-red-200 hover:bg-red-200",
      Batal: "bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200",
      "Dalam Jadual":
        "bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100",
      "Belum Mula":
        "bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100",
    };

    const handleExportExcel = () => {
      const ws = XLSX.utils.json_to_sheet(
        cleanData.map((r) => ({
          Projek: r.NAMA_PAPARAN,
          Status: r.LOGIK_SIAP,
          Kos: r.KOS_AKHIR,
          Bayaran: r.JUMLAH_BAYARAN,
          Pelaksana: r.SYARIKAT_NAMA,
          Mula: r["TARIKH MULA"],
          Siap: r["TARIKH SIAP"],
        }))
      );
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Laporan BPM");
      XLSX.writeFile(wb, "Laporan_Projek_BPM.xlsx");
    };

    const handleRefresh = () => {
      setLoading(true); // Tunjukkan loading screen atau spinner
      try {
        google.script.run
          .withSuccessHandler((res) => {
            setData(JSON.parse(res));
            setLoading(false);
          })
          .getData();
      } catch (e) {
        setLoading(false);
        alert("Ralat semasa menyegarkan data.");
      }
    };

    // FUNGSI BARU: Handle butang AI
    const handleAiAction = (actionType) => {
        if (actionType === "Lihat Senarai Lewat") {
            // 1. Reset carian supaya tak ganggu
            setSearchTerm("");
            
            // 2. Set Filter Status kepada 'Lewat (Overdue)'
            setSelectedStatuses(["Lewat (Overdue)"]);
            
            // 3. Tukar ke Tab Senarai
            setActiveTab("list");
            
            // 4. Scroll ke jadual (sama macam chart drill-down)
            setTimeout(() => {
                const listSection = document.querySelector(".group\\/table");
                if (listSection) listSection.scrollIntoView({ behavior: "smooth", block: "start" });
            }, 100);
        }
        else if (actionType === "Analisis Cashflow") {
            // Scroll ke widget cashflow (id chartCashFlow)
            const el = document.getElementById("chartCashFlow");
            if(el) el.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        else if (actionType === "Lihat Kalendar") {
            // Scroll ke Kalendar (anda mungkin perlu tambah id="masterCalendar" pada div MasterCalendarWidget)
            // Untuk sekarang kita scroll ke atas tab Stats
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };

    // Fungsi Helper untuk handle klik carta
    const handleChartFilter = (status) => {
        // 1. Set Filter Status
        setSelectedStatuses([status]); 
        
        // 2. Tukar ke Tab Senarai (sebab chart di tab Stats)
        setActiveTab("list");
        
        // 3. Auto Scroll ke table (tunggu sikit untuk render)
        setTimeout(() => {
            // Kita scroll ke 'Senarai Terperinci' header
            const listSection = document.querySelector(".group\\/table"); 
            if(listSection) listSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    };

    return (
      <div className={`min-h-screen bg-slate-50 transition-colors duration-500 selection:bg-blue-500 selection:text-white ${darkMode ? 'dark-mode' : ''}`}>

        {/* --- 1. HEADER: COMPACT PREMIUM (NO SCROLL NEEDED) --- */}
        <div className="relative w-full py-4 px-6 z-10 bg-slate-50 border-b border-slate-200 shadow-[0_1px_10px_-3px_rgba(0,0,0,0.05)]">

          {/* A. HIASAN LATAR (Kekal tapi lebih halus) */}
          <div className="absolute inset-0 opacity-[0.3]"
            style={{ backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px' }}>
          </div>
          <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[60%] h-full bg-blue-500/5 blur-[50px] rounded-full pointer-events-none"></div>
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-700 via-indigo-600 to-blue-700"></div>

          {/* B. KANDUNGAN HEADER (Lebih Rapat & Kemas) */}
          <div className="max-w-7xl mx-auto flex items-center justify-between relative z-10">

            {/* KIRI: Spacer Kecil */}
            <div className="w-10 hidden sm:block"></div>

            {/* TENGAH: TAJUK SISTEM (Saiz Dioptimumkan) */}
            <div className="flex flex-col items-center justify-center w-full text-center group cursor-default">

              {/* Surtitle: Kecil & Rapat */}
              <div className="flex items-center gap-2 mb-0.5">
                <div className="h-[1px] w-4 bg-slate-300"></div>
                <span className="text-[9px] font-bold text-slate-400 tracking-[0.3em] uppercase">
                  Bahagian Pengurusan Maklumat
                </span>
                <div className="h-[1px] w-4 bg-slate-300"></div>
              </div>

              {/* Main Title: Besar tapi tak melampau (3xl-4xl) */}
              <h1 className="text-3xl sm:text-4xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-slate-800 to-slate-600 drop-shadow-sm mb-1 transition-transform duration-300 group-hover:scale-[1.01]">
                SMART DASHBOARD
              </h1>

              {/* Subtitle Badge: Nipis & Compact */}
              <div className="inline-flex items-center gap-2 px-3 py-0.5 rounded-full bg-white/60 border border-slate-200 shadow-sm backdrop-blur-sm">
                <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                <p className="text-[8px] font-extrabold text-slate-500 uppercase tracking-[0.2em] leading-relaxed">
                  Sistem Pantauan Projek & Kontrak
                </p>
              </div>
            </div>

            {/* KANAN: Butang Refresh (Lebih Kecil) */}
            <div className="ml-auto hidden sm:block w-10 flex justify-end">
              <button
                onClick={handleRefresh}
                disabled={loading}
                className="group/btn p-2 rounded-xl bg-white hover:bg-blue-50 text-slate-400 hover:text-blue-600 border border-slate-200 hover:border-blue-200 shadow-sm transition-all active:scale-95"
                title="Segarkan Data"
              >
                <svg
                  className={`w-4 h-4 ${loading ? 'animate-spin text-blue-600' : 'transition-transform duration-700 group-hover/btn:rotate-180 ease-out'}`}
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        {/* 2. MAIN CONTENT AREA */}
        <div className="max-w-7xl mx-auto p-6 md:p-8 space-y-8 fade-in pb-32 pt-8">
          {/* TICKER ALERT (Akan berada di bawah header) */}
          {!loading && <CriticalTicker data={data} />}

          {/* TAB STATS (Kekal) */}
          <div className="flex justify-center mb-10">
            <div className="glass-card p-1.5 flex gap-2 backdrop-blur-2xl bg-white/30 rounded-3xl border border-white/50 shadow-xl">

              {/* TAB 4: PERANCANGAN (PLANNING) */}
              <button
                onClick={() => setActiveTab("planning")}
                className={`px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all
                    duration-500 flex items-center gap-2 ${activeTab === "planning"
                    ? "bg-slate-800 text-white shadow-lg shadow-slate-400 scale-105" 
                    : "text-slate-500 hover:bg-white/50 hover:text-slate-800"
                  }`}
              >
                 <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
                Pembangunan
              </button>

              {/* TAB 1: GAMIFICATION (BARU) */}
              <button
                onClick={() => setActiveTab("gamification")}
                className={`px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all duration-500 flex items-center gap-2 whitespace-nowrap
                    ${activeTab === "gamification"
                    ? "bg-purple-600 text-white shadow-lg shadow-purple-200 scale-105"
                    : "text-slate-500 hover:bg-white/50 hover:text-purple-600"
                  }`}
              >
                {/* Ikon Medal/Trophy */}
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                Prestasi Pegawai
              </button>

              {/* TAB 2: STATISTIK */}
              <button
                onClick={() => setActiveTab("stats")}
                className={`px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all
                    duration-500 flex items-center gap-2 ${activeTab === "stats"
                    ? "bg-blue-600 text-white shadow-lg shadow-blue-200 scale-105"
                    : "text-slate-500 hover:bg-white/50 hover:text-blue-600"
                  }`}
              >
                <Icons.Chart size={16} /> Analisis Statistik
              </button>

              {/* TAB 3: SENARAI LIST (WARNA EMERALD/HIJAU) */}
              <button
                onClick={() => setActiveTab("list")}
                className={`px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all
                    duration-500 flex items-center gap-2 ${activeTab === "list"
                    ? "bg-emerald-600 text-white shadow-lg shadow-emerald-200 scale-105" // Tukar Blue ke Emerald
                    : "text-slate-500 hover:bg-white/50 hover:text-emerald-600" // Tukar Blue ke Emerald
                  }`}
              >
                <svg
                  className="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M4 6h16M4 12h16M4 18h7"
                  />
                </svg>
                Senarai Terperinci
              </button>
            </div>
          </div>

          {/* PART 4: PLANNING BOARD VIEW */}
          {activeTab === "planning" && (
            <div className="fade-in">
               {!loading && <DevelopmentPlanningBoard data={cleanData} />}
            </div>
          )}

          {/* PART 1: GAMIFICATION */}
          {activeTab === "gamification" && (
            <div className="fade-in space-y-8">
              {!loading && (
                <FairGamificationEngine
                  data={cleanData}
                  staffData={staffData}
                  jawatanData={jawatanData}
                  selectedYear={selectedYear}
                />
              )}

              {!loading && (
                <MaintenanceGamificationEngine
                  data={cleanData}
                  staffData={staffData}
                  jawatanData={jawatanData}
                  selectedYear={selectedYear}
                />
              )}
            </div>
          )}

          {/* PART 1: DASHBOARD STATS */}
          {activeTab === "stats" && (
            <div className="fade-in space-y-8">

              {/* --- 1. AI SMART ASSISTANT --- */}
              {!loading && (
                  <SmartAssistantWidget 
                      data={filtered} 
                      onAction={handleAiAction} // <--- PASTIKAN PROPS INI DITAMBAH
                  />
              )}

              {/* ROW 1: STATUS UTAMA */}
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                <StatCard
                  title="Jumlah Projek"
                  val={stats.total}
                  sub="Rekod Aktif"
                  icon={<Icons.Chart />}
                  colorClass="bg-blue-500 text-blue-600"
                  desc="Jumlah keseluruhan projek yang didaftarkan dalam sistem (tidak termasuk rekod kosong)."
                />
                <StatCard
                  title="Kos Keseluruhan"
                  val={formatRM(stats.kos)}
                  sub="Komitmen Kontrak"
                  icon={<Icons.Money />}
                  colorClass="bg-emerald-500 text-emerald-600"
                  desc="Jumlah nilai kontrak semasa termasuk SST dan pelarasan VO bagi semua projek aktif."
                />
                <StatCard
                  title="Lewat/Overdue"
                  val={stats.lewat}
                  sub="Perlu Tindakan"
                  icon={<Icons.Alert />}
                  colorClass="bg-red-500 text-red-600"
                  desc="Bilangan projek yang telah melepasi tarikh siap (termasuk EOT) tetapi status belum 'Completed'."
                />
                <StatCard
                  title="Siap (CPC)"
                  val={stats.siap}
                  sub="Projek Selesai"
                  icon={<Icons.Check />}
                  colorClass="bg-indigo-500 text-indigo-600"
                  desc="Projek yang telah berjaya disiapkan dan telah menerima Perakuan Siap Kerja (CPC)."
                />
              </div>

              {/* ROW 2: ADVANCED ANALYTICS */}
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <StatCard
                  title="Impak VO (Bersih)"
                  val={formatRM(advancedStats.totalVOImpact)}
                  sub={
                    advancedStats.totalVOImpact > 0
                      ? "â†— Kos Melebihi Asal"
                      : "â†˜ Penjimatan Kos"
                  }
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                      />
                    </svg>
                  }
                  colorClass={
                    advancedStats.totalVOImpact > 0
                      ? "bg-amber-500 text-amber-600"
                      : "bg-teal-500 text-teal-600"
                  }
                  desc="Perbezaan bersih antara kos tambahan (VO + Pelarasan SST) dan penjimatan (VO Kurangan + 8% SST). Angka positif bermaksud kos akhir melebihi harga kontrak asal."
                />
                <StatCard
                  title="Kelulusan EOT"
                  val={advancedStats.eotCount}
                  sub="Projek Dilanjutkan Masa"
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  }
                  colorClass="bg-purple-500 text-purple-600"
                  desc="Bilangan projek yang diberikan kelulusan Pelanjutan Masa (Extension of Time) daripada tarikh asal."
                />
                <StatCard
                  title="Tamat < 30 Hari"
                  val={advancedStats.expiringCount}
                  sub="Perlu Pantau Rapi"
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                      />
                    </svg>
                  }
                  colorClass="bg-rose-500 text-rose-600"
                  desc="Projek kritikal yang akan mencapai tarikh siap dalam tempoh 30 hari dari sekarang."
                />
                <StatCard
                  title="Baki Komitmen"
                  val={formatRM(advancedStats.bakiKomitmen)}
                  sub="Belum Dibayar"
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
                      />
                    </svg>
                  }
                  colorClass="bg-cyan-500 text-cyan-600"
                  desc="Jumlah baki nilai kontrak yang masih belum dibayar kepada kontraktor (Kos Akhir - Jumlah Bayaran)."
                />
              </div>

              {/* ROW 3: ANALISIS STRATEGIK */}
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <StatCard
                  title="Kesihatan Jadual"
                  val={`${advancedStats.scheduleHealth}%`}
                  // Tukar sub-label supaya orang tahu ini purata progress
                  sub="Purata Kemajuan"
                  icon={<Icons.Check />}
                  colorClass={
                    // Kalau progress tinggi (>80%) hijau, sederhana (>50%) biru, rendah (<50%) kuning
                    advancedStats.scheduleHealth >= 80 ? "bg-emerald-500 text-emerald-600" :
                      advancedStats.scheduleHealth >= 50 ? "bg-blue-500 text-blue-600" :
                        "bg-amber-500 text-amber-600"
                  }
                  desc="Peratus purata kemajuan bayaran bagi semua projek yang dipaparkan. Projek yang belum bermula (0%) akan menurunkan skor ini."
                />
                <StatCard
                  title="Tunggakan Bayaran"
                  val={advancedStats.pendingFinalPayment}
                  sub="Siap CPC, Bayaran < 100%"
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  }
                  colorClass="bg-orange-500 text-orange-600"
                  // Masukkan data terperinci di sini
                  detailList={advancedStats.pendingFinalPaymentDetails}
                  desc="Projek yang sudah siap fizikal (CPC) tetapi kemajuan bayaran masih belum mencapai 100%."
                />
                <StatCard
                  title="Efisiensi Projek"
                  val={advancedStats.efficiencyCount}
                  sub="Siap Tanpa Perlu EOT"
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      />
                    </svg>
                  }
                  colorClass="bg-blue-500 text-blue-600"
                  desc="Bilangan projek yang berjaya disiapkan sepenuhnya dalam tempoh kontrak asal tanpa memerlukan sebarang pelanjutan masa (EOT)."
                />
                <StatCard
                  title="Varians Kos"
                  val={`${advancedStats.varianceRate}%`}
                  sub={
                    advancedStats.totalVOImpact >= 0
                      ? "â†— Lari Dari Bajet"
                      : "â†˜ Jimat Dari Bajet"
                  }
                  icon={
                    <svg
                      className="w-8 h-8"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"
                      />
                    </svg>
                  }
                  colorClass={
                    advancedStats.totalVOImpact > 0
                      ? "bg-red-500 text-red-600"
                      : "bg-emerald-500 text-emerald-600"
                  }
                  desc="Peratusan perubahan harga kontrak muktamad berbanding harga asal. Varians positif menunjukkan kos projek meningkat disebabkan perubahan skop kerja."
                />
              </div>
              
              {/* --- 3. TAMBAH S-CURVE DI SINI --- */}
              {!loading && <SCurveWidget data={filtered} selectedYear={selectedYear} />}

              {/* --- TAMBAH WIDGET BARU DI SINI --- */}
              {!loading && <CashFlowWidget data={filtered} />}

              {/* 1. KALENDAR */}
              {!loading && <MasterCalendarWidget data={cleanData} />} 
                  
              {/* 2. RISK HEATMAP (BARU) */}
              {!loading && <RiskHeatmapWidget data={filtered} />}

              {!loading && (
                  <ChartSection 
                      data={filtered} 
                      darkMode={darkMode} 
                      onStatusClick={handleChartFilter} // <--- HANTAR FUNGSI TADI KE SINI
                  />
              )}
            </div>
          )}

          {activeTab === "list" && (
            <div className="fade-in space-y-8">
              {/* SENARAI TERPERINCI - GEMPAK VERSION */}
              <div className="glass-card overflow-hidden shadow-2xl border-0 ring-1 ring-white/20 relative group/table">
                {/* Background Glow Effect - hiasan di belakang table */}
                <div className="absolute -top-24 -left-24 w-96 h-96 bg-blue-500/10 rounded-full blur-[100px] pointer-events-none"></div>

                <div className="px-8 py-6 border-b border-white/10 bg-white/40 backdrop-blur-2xl flex justify-between items-center sticky top-0 z-20">
                  <div className="flex items-center gap-4">
                    <div className="w-2 h-8 bg-blue-600 rounded-full shadow-[0_0_15px_rgba(37,99,235,0.5)]"></div>
                    <div>
                      <span className="font-black text-gray-900 text-xl tracking-tighter uppercase italic">
                        Senarai Terperinci
                      </span>
                      <div className="flex items-center gap-2 mt-0.5">
                        <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">
                          {filtered.length} Rekod Dikesan
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="overflow-x-auto custom-scroll max-h-[700px] bg-white/20">
                  <table className="w-full text-sm text-left border-collapse table-fixed">
                    <thead className="sticky top-0 z-10">
                      <tr className="bg-slate-900/[0.03] backdrop-blur-xl text-slate-500 text-[10px] uppercase tracking-[0.15em] font-black border-b border-slate-200/60">
                        <th className="px-8 py-5 w-[30%]">Maklumat Projek</th>
                        <th className="px-4 py-5 w-[18%]">Pihak Terlibat</th>
                        <th className="px-4 py-5 w-[20%]">
                          Garis Masa (Timeline)
                        </th>
                        <th className="px-4 py-5 w-[18%]">Prestasi Kewangan</th>
                        <th className="px-8 py-5 w-[14%] text-right">
                          Nilai Kontrak
                        </th>
                        <th className="px-6 py-5 w-[140px] text-center">
                          Status
                        </th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200/40">
                      {filtered.length === 0 ? (
                        <tr>
                          <td colSpan="6" className="p-24 text-center">
                            <div className="flex flex-col items-center opacity-30">
                              <svg
                                className="w-16 h-16 mb-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                  strokeWidth="1"
                                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                                />
                              </svg>
                              <p className="text-lg font-black uppercase tracking-widest italic">
                                Tiada Data Dijumpai
                              </p>
                            </div>
                          </td>
                        </tr>
                      ) : (
                        filtered.map((r, i) => (
                          <tr
                            key={i}
                            className="hover:bg-white/60 transition-all duration-300 group/row relative"
                          >
                            {/* COL 1: PROJEK */}
                            <td className="px-8 py-6 align-top relative">
                              <div className="flex flex-col gap-3">
                                <div className="font-black text-slate-800 text-[14px] leading-tight group-hover/row:text-blue-600 transition-colors">
                                  {r.NAMA_PAPARAN}
                                </div>
                                <div className="flex flex-wrap gap-1.5 items-center">
                                  <span className="text-[9px] font-black text-slate-500 bg-slate-100/80 px-2 py-1 rounded-md border border-slate-200 uppercase tracking-tighter">
                                    {r["NO SEBUT HARGA"] || "N/A"}
                                  </span>
                                  <span className="text-[9px] font-black text-blue-700 bg-blue-100/50 px-2 py-1 rounded-md border border-blue-200/50 uppercase tracking-tighter">
                                    {r["KATEGORI PERKHIDMATAN"]}
                                  </span>
                                </div>
                                {r.VOT_NAMA && r.VOT_NAMA !== "-" && (
                                  <div className="flex items-center gap-2 mt-1">
                                    <div className="w-1 h-4 bg-purple-500 rounded-full"></div>
                                    <span className="text-[10px] font-mono font-black text-purple-700 bg-purple-100/50 px-2 py-0.5 rounded border border-purple-200">
                                      VOT: {r.VOT_NAMA}
                                    </span>
                                  </div>
                                )}
                              </div>
                            </td>

                            {/* COL 2: PELAKSANA */}
                            <td className="px-4 py-6 align-top">
                              <div className="space-y-4">
                                <div className="relative pl-3">
                                  <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-blue-600 rounded-full"></div>
                                  <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                    Kontraktor
                                  </div>
                                  <div className="font-bold text-slate-900 text-xs leading-tight">
                                    {r.SYARIKAT_NAMA}
                                  </div>
                                </div>
                                <div className="relative pl-3">
                                  <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-slate-300 rounded-full"></div>
                                  <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                    Penyelia
                                  </div>
                                  <div className="text-[11px] font-bold text-slate-700">
                                    {r.PEGAWAI_NAMA}
                                  </div>
                                  <div className="text-[10px] text-slate-500 font-medium">
                                    {r.BAHAGIAN_NAMA}
                                  </div>
                                </div>
                              </div>
                            </td>

                            {/* COL 3: GARIS MASA */}
                            <td className="px-4 py-6 align-top">
                              <div className="bg-slate-900/5 rounded-2xl p-3 border border-slate-200/60 space-y-2.5 shadow-inner">
                                <div className="flex justify-between items-center text-[10px]">
                                  <span className="text-slate-500 font-black uppercase">
                                    Start
                                  </span>
                                  <span className="font-mono font-black text-slate-800 bg-white px-2 py-0.5 rounded shadow-sm">
                                    {r["TARIKH MULA"] || "-"}
                                  </span>
                                </div>
                                <div className="flex justify-between items-center text-[10px]">
                                  <span className="text-slate-500 font-black uppercase">
                                    Target
                                  </span>
                                  <span className="font-mono font-black text-slate-800 bg-white px-2 py-0.5 rounded shadow-sm">
                                    {r["TARIKH SIAP"] || "-"}
                                  </span>
                                </div>

                                {r["TARIKH SELESAI"] && (
                                  <div className="flex justify-between items-center text-[10px] border-t border-slate-200 pt-2">
                                    <span className="text-emerald-600 font-black uppercase">
                                      Actual
                                    </span>
                                    <span className="font-mono font-black text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100 shadow-sm">
                                      {r["TARIKH SELESAI"]}
                                    </span>
                                  </div>
                                )}

                                {/* TARIKH EOT (DITAMPILKAN SEMULA) */}
                                {r["EOT"] && (
                                  <div className="flex justify-between items-center text-[10px] bg-amber-50/50 p-1.5 rounded-lg border border-amber-200/50">
                                    <span className="text-amber-600 font-black uppercase tracking-tighter">
                                      EOT
                                    </span>
                                    <span className="font-mono font-black text-amber-700 bg-white px-1.5 rounded shadow-sm">
                                      {r["EOT"]}
                                    </span>
                                  </div>
                                )}

                                {r.INFO_LEWAT && (
                                  <div className="mt-1 text-[9px] bg-red-600 text-white px-2 py-1 rounded-lg font-black text-center shadow-lg shadow-red-200/50 italic tracking-tight">
                                    {r.INFO_LEWAT}
                                  </div>
                                )}
                              </div>

                              {r.TEMPOH_DATA && r.TEMPOH_DATA.length > 0 && (
                                <div className="mt-3 px-1 grid grid-cols-1 gap-1">
                                  {r.TEMPOH_DATA.map((t, idx) => (
                                    <div
                                      key={idx}
                                      className={`flex justify-between text-[9px] items-center ${t.label === "Keseluruhan"
                                        ? "font-black text-slate-900 border-t border-slate-200 pt-1 mt-1"
                                        : "text-slate-400 font-bold italic"
                                        }`}
                                    >
                                      <span>{t.label}</span>
                                      <span className="font-mono">{t.val}</span>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </td>

                            {/* COL 4: KEWANGAN */}
                            <td className="px-4 py-6 align-top">
                              <div className="mb-3">
                                <div className="flex justify-between text-[10px] mb-1.5">
                                  <span className="font-black text-slate-500 uppercase">
                                    Paid Progress
                                  </span>
                                  <span className="font-black text-slate-900">
                                    {r.PROGRESS_MASA}%
                                  </span>
                                </div>
                                <div className="w-full bg-slate-200/50 rounded-full h-2.5 overflow-hidden shadow-inner p-0.5 border border-slate-200">
                                  <div
                                    className={`h-full rounded-full transition-all duration-1000 ease-out relative ${r.LOGIK_SIAP === "Lewat (Overdue)"
                                      ? "bg-red-500"
                                      : "bg-gradient-to-r from-blue-500 via-indigo-500 to-emerald-500"
                                      }`}
                                    style={{ width: `${r.PROGRESS_MASA}%` }}
                                  >
                                    {/* Shimmer Effect */}
                                    <div className="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite] skew-x-[-20deg]"></div>
                                  </div>
                                </div>
                              </div>

                              <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-3 shadow-lg flex flex-col items-end">
                                <span className="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">
                                  Total Payment
                                </span>
                                <span className="text-[13px] font-mono font-black text-white whitespace-nowrap">
                                  {r.LOGIK_SIAP === "Batal"
                                    ? "-"
                                    : formatRM(r.JUMLAH_BAYARAN)}
                                </span>
                              </div>
                            </td>

                            {/* COL 5: KOMITMEN - KEMAS & FIXED WIDTH VERSION */}
                            <td className="px-3 py-6 align-top text-right">
                              <div className="flex flex-col items-end w-full">
                                {/* NILAI UTAMA (KOS AKHIR) */}
                                <div className="group/price mb-2">
                                  <div
                                    className={`font-black font-mono text-[13px] sm:text-[14px] tracking-tighter whitespace-nowrap px-2 py-1 rounded-md transition-all duration-300
                                                ${r.LOGIK_SIAP === "Batal"
                                        ? "line-through text-slate-300"
                                        : "text-slate-900 bg-slate-100/80 group-hover/price:bg-slate-800 group-hover/price:text-white shadow-sm"
                                      }`}
                                  >
                                    {formatRM(r.KOS_AKHIR)}
                                  </div>
                                </div>

                                {/* PECAHAN KOS - DISUSUN RAPAT */}
                                {r.LOGIK_SIAP !== "Batal" && (
                                  <div className="w-full space-y-1 border-t border-slate-100 pt-2 opacity-90">
                                    {/* Baris Base */}
                                    <div className="flex justify-end items-center gap-2">
                                      <span className="text-[7px] font-black text-slate-400 uppercase tracking-tighter">
                                        Base:
                                      </span>
                                      <span className="font-mono text-[9px] font-bold text-slate-500 whitespace-nowrap">
                                        {formatRM(r.KOS_PECAHAN.kontrak)}
                                      </span>
                                    </div>

                                    {/* Baris Tax */}
                                    <div className="flex justify-end items-center gap-2">
                                      <span className="text-[7px] font-black text-slate-400 uppercase tracking-tighter">
                                        Tax:
                                      </span>
                                      <span className="font-mono text-[9px] font-bold text-slate-500 whitespace-nowrap">
                                        {formatRM(r.KOS_PECAHAN.sst)}
                                      </span>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </td>

                            {/* COL 6: STATUS BADGE */}
                            <td className="px-6 py-6 align-top text-center">
                              <div
                                className={`inline-flex flex-col items-center justify-center px-4 py-2 rounded-2xl border-2 shadow-xl w-full min-h-[60px] transition-all duration-300 group-hover/row:scale-105
                                        ${statusStyles[r.LOGIK_SIAP] ||
                                  "bg-slate-50 border-slate-200 text-slate-600"
                                  }`}
                              >
                                <span className="text-[10px] font-black uppercase tracking-[0.1em] mb-1">
                                  {r.LOGIK_SIAP}
                                </span>

                                <div className="flex items-center gap-1.5">
                                  {r.LOGIK_SIAP === "Siap (CPC)"}
                                  {r.LOGIK_SIAP === "Siap (Lewat)"}
                                  {r.LOGIK_SIAP === "Lewat (Overdue)" && (
                                    <div className="flex items-center gap-1">
                                      <span className="w-1.5 h-1.5 rounded-full bg-red-600 animate-ping"></span>
                                      <span className="text-[8px] font-black text-red-700 animate-pulse">
                                        CRITICAL
                                      </span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* --- 1. GLOBAL FLOATING FILTER BUTTON (FAB) --- */}
        {/* --- FLOATING COMMAND CENTER (SPEED DIAL) --- */}
        <div className="fixed bottom-8 right-8 z-[90] flex flex-col items-center gap-3 group/dock">

          {/* KANAN: Dark Mode Toggle (Kekal di sini sebab ia setting global) */}
          <button
            onClick={() => setDarkMode(!darkMode)}
            className="group/print relative flex items-center justify-center w-12 h-12 rounded-full bg-slate-800 text-white shadow-xl shadow-slate-900/30 border border-slate-700 transition-all duration-300 hover:scale-110 hover:bg-slate-700 active:scale-90"
          >
            {darkMode ? "â˜€ï¸" : "ðŸŒ™"}

            {/* Tooltip Kiri */}
            <span className="absolute right-14 bg-slate-900 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg opacity-0 -translate-x-2 group-hover/print:opacity-100 group-hover/print:translate-x-0 transition-all duration-300 whitespace-nowrap tracking-widest uppercase shadow-lg">
              Mode
            </span>
          </button>

          {/* 1. BUTANG CETAK (Kecil) */}
          <button
            onClick={handlePrint}
            disabled={printing}
            className="group/print relative flex items-center justify-center w-12 h-12 rounded-full bg-slate-800 text-white shadow-xl shadow-slate-900/30 border border-slate-700 transition-all duration-300 hover:scale-110 hover:bg-slate-700 active:scale-90"
          >
            {printing ? (
              <span className="animate-spin text-xs">âŸ³</span>
            ) : (
              /* Guna SVG terus di sini tanpa class 'mr-2' supaya center */
              <svg
                className="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
                ></path>
              </svg>
            )}

            {/* Tooltip Kiri */}
            <span className="absolute right-14 bg-slate-900 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg opacity-0 -translate-x-2 group-hover/print:opacity-100 group-hover/print:translate-x-0 transition-all duration-300 whitespace-nowrap tracking-widest uppercase shadow-lg">
              Cetak Laporan
            </span>
          </button>

          {/* 3. BUTANG BARU: WHATSAPP SUMMARY */}
          <button
            onClick={handleCopySummary}
            className="group/wa relative flex items-center justify-center w-12 h-12 rounded-full bg-green-500 text-white shadow-xl shadow-green-500/30 border border-green-400 transition-all duration-300 hover:scale-110 hover:bg-green-600 active:scale-90"
          >
            {/* Ikon Clipboard / Chat */}
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m2 4h2a2 2 0 012 2v10a2 2 0 01-2 2h-2a2 2 0 01-2-2v-10a2 2 0 012-2z"></path></svg>

            {/* Tooltip Kiri */}
            <span className="absolute right-14 bg-green-700 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg opacity-0 -translate-x-2 group-hover/wa:opacity-100 group-hover/wa:translate-x-0 transition-all duration-300 whitespace-nowrap tracking-widest uppercase shadow-lg">
              Salin Ringkasan
            </span>
          </button>

          {/* 2. BUTANG EXCEL (Kecil) */}
          <button
            onClick={handleExportExcel}
            className="group/excel relative flex items-center justify-center w-12 h-12 rounded-full bg-emerald-600 text-white shadow-xl shadow-emerald-600/30 border border-emerald-500 transition-all duration-300 hover:scale-110 hover:bg-emerald-500 active:scale-90"
          >
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>

            {/* Tooltip Kiri */}
            <span className="absolute right-14 bg-emerald-800 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg opacity-0 -translate-x-2 group-hover/excel:opacity-100 group-hover/excel:translate-x-0 transition-all duration-300 whitespace-nowrap tracking-widest uppercase shadow-lg">
              Export Excel
            </span>
          </button>

          {/* 3. BUTANG FILTER UTAMA (Besar & Gempak) */}
          <div className="relative group/main">
            {/* Pulse Glow */}
            <div className="absolute inset-0 rounded-full bg-blue-500 blur-lg opacity-40 group-hover/main:opacity-70 group-hover/main:scale-125 transition-all duration-500 animate-pulse"></div>

            <button
              onClick={() => setIsFilterOpen(true)}
              className="relative flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 text-white shadow-2xl border border-white/20 transition-all duration-300 transform group-hover/main:scale-110 group-hover/main:rotate-90 active:scale-95"
            >
              <svg
                className="w-7 h-7 drop-shadow-md"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                ></path>
              </svg>
            </button>

            {/* Label Filter (Sentiasa Tunjuk atau Hover) */}
            <span className="absolute right-20 top-1/2 -translate-y-1/2 bg-blue-900/90 backdrop-blur-md text-white text-[10px] font-black px-4 py-2 rounded-xl opacity-0 -translate-x-4 group-hover/main:translate-x-0 group-hover/main:opacity-100 transition-all duration-300 whitespace-nowrap tracking-widest uppercase border border-white/10 shadow-xl pointer-events-none">
              Konfigurasi Data
            </span>
          </div>
        </div>

        {/* --- 2. MODAL PANEL TAPISAN (PREMIUM GLASS + VO FILTER) --- */}
        <div
          className={`fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6 transition-all duration-500 ${isFilterOpen
            ? "opacity-100 visible"
            : "opacity-0 invisible pointer-events-none"
            }`}
        >
          {/* Backdrop Gelap */}
          <div
            onClick={() => setIsFilterOpen(false)}
            className="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-all duration-500"
          ></div>

          {/* Panel Kaca Terapung */}
          <div
            className={`relative w-full max-w-5xl max-h-[90vh] overflow-hidden bg-white/80 backdrop-blur-2xl border border-white/60 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.3)] rounded-[32px] flex flex-col transform transition-all duration-500 ease-out ${isFilterOpen ? "scale-100 translate-y-0" : "scale-90 translate-y-10"
              }`}
          >
            {/* A. HEADER (Sticky) */}
            <div className="px-8 py-6 border-b border-slate-200/60 bg-white/40 flex justify-between items-center backdrop-blur-sm z-20">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-blue-100 rounded-2xl text-blue-600">
                  <svg
                    className="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                    ></path>
                  </svg>
                </div>
                <div>
                  <h2 className="text-2xl font-black text-slate-800 tracking-tighter uppercase italic">
                    Smart{" "}
                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
                      Filter
                    </span>
                  </h2>
                  <p className="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">
                    Parameter Analisis Data
                  </p>
                </div>
              </div>
              <button
                onClick={() => setIsFilterOpen(false)}
                className="group p-2 rounded-full hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors"
              >
                <svg
                  className="w-6 h-6 transition-transform group-hover:rotate-90"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>

            {/* B. SCROLLABLE CONTENT */}
            <div className="overflow-y-auto custom-scroll p-8 space-y-8 bg-gradient-to-b from-white/30 to-white/10">
              {/* 1. CARIAN GLOBAL */}
              <div className="relative group/search">
                <div className="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                  <svg
                    className="h-6 w-6 text-slate-400 group-focus-within/search:text-blue-500 transition-colors"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                </div>
                <input
                  type="text"
                  placeholder="Taip carian global (Nama Projek, Syarikat, No. Sebut Harga...)"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="block w-full pl-14 pr-6 py-5 border-2 border-slate-200 rounded-2xl bg-white/60 text-base font-bold text-slate-800 placeholder:text-slate-400 focus:border-blue-500 focus:bg-white focus:ring-4 focus:ring-blue-500/10 outline-none transition-all shadow-sm hover:border-blue-300"
                />
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                {/* LAJUR KIRI: STATUS & VOT (YANG BARU) */}
                <div className="lg:col-span-7 space-y-8">
                  {/* FILTER STATUS */}
                  <div className="bg-white/50 p-6 rounded-3xl border border-white/60 shadow-sm">
                    <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">
                      <span className="w-2 h-2 rounded-full bg-blue-500"></span>{" "}
                      Status Projek
                    </label>
                    <div className="flex flex-wrap gap-3">
                      {allStatuses.map((s) => {
                        const isActive = selectedStatuses.includes(s);
                        return (
                          <button
                            key={s}
                            onClick={() =>
                              toggleSelection(
                                setSelectedStatuses,
                                selectedStatuses,
                                s
                              )
                            }
                            className={`group relative px-5 py-2.5 rounded-xl border-2 transition-all duration-300 overflow-hidden
                                    ${isActive
                                ? "border-blue-600 bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105"
                                : "border-slate-200 bg-white text-slate-600 hover:border-blue-300 hover:text-blue-600"
                              }`}
                          >
                            <div className="relative z-10 flex items-center gap-2">
                              {isActive && (
                                <svg
                                  className="w-3 h-3"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth="3"
                                    d="M5 13l4 4L19 7"
                                  ></path>
                                </svg>
                              )}
                              <span className="text-[11px] font-black uppercase tracking-wide">
                                {s}
                              </span>
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* FILTER VOT (KOD PERUNTUKAN) - VERSI GEMPAK & SEARCHABLE */}
                  <div className="bg-white/50 p-6 rounded-3xl border border-white/60 shadow-sm relative overflow-hidden">
                    <div className="flex justify-between items-center mb-4">
                      <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <span className="w-2 h-2 rounded-full bg-purple-500"></span>{" "}
                        Kod Vot / Peruntukan
                      </label>
                      {/* Mini Search untuk VOT */}
                      <div className="relative w-48">
                        <input
                          type="text"
                          placeholder="Cari Kod Vot..."
                          className="w-full pl-7 pr-3 py-1.5 text-[10px] font-bold bg-white border border-slate-200 rounded-lg focus:border-purple-500 outline-none transition-all"
                          onChange={(e) => {
                            // Kita guna DOM manipulation ringkas untuk filter visual sahaja (UI Trick)
                            const val = e.target.value.toLowerCase();
                            document
                              .querySelectorAll(".vot-item")
                              .forEach((el) => {
                                el.style.display = el.textContent
                                  .toLowerCase()
                                  .includes(val)
                                  ? "flex"
                                  : "none";
                              });
                          }}
                        />
                        <svg
                          className="w-3 h-3 absolute left-2 top-2 text-slate-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                          ></path>
                        </svg>
                      </div>
                    </div>

                    {/* Senarai Vot (Scrollable Chips) */}
                    <div className="flex flex-wrap gap-2 max-h-[180px] overflow-y-auto custom-scroll p-1">
                      {uniqueVots.map((v) => {
                        const isActive = selectedVots.includes(v);
                        return (
                          <button
                            key={v}
                            onClick={() =>
                              toggleSelection(setSelectedVots, selectedVots, v)
                            }
                            className={`vot-item flex items-center gap-2 px-3 py-1.5 rounded-lg border text-[10px] font-mono font-bold transition-all
                                      ${isActive
                                ? "bg-purple-600 border-purple-600 text-white shadow-md"
                                : "bg-white border-slate-200 text-slate-500 hover:border-purple-300 hover:text-purple-600"
                              }`}
                          >
                            {isActive && (
                              <span className="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                            )}
                            {v}
                          </button>
                        );
                      })}
                      {uniqueVots.length === 0 && (
                        <div className="text-slate-400 text-xs italic">
                          Tiada data Vot dijumpai.
                        </div>
                      )}
                    </div>
                  </div>

                  {/* 1. FILTER KATEGORI (UBAH JADI MULTI-SELECT CHIPS) */}
                      <div className="bg-white/50 p-6 rounded-3xl border border-white/60 shadow-sm mb-6">
                        <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">
                          <span className="w-2 h-2 rounded-full bg-orange-500"></span>
                          Kategori Perkhidmatan (Pilih Banyak)
                        </label>
                        <div className="flex flex-wrap gap-2">
                          {uniqueCategories.map((cat) => {
                            const isActive = selectedCategories.includes(cat);
                            return (
                              <button
                                key={cat}
                                onClick={() => toggleSelection(setSelectedCategories, selectedCategories, cat)}
                                className={`px-3 py-1.5 rounded-lg border text-[10px] font-bold transition-all flex items-center gap-2
                                  ${isActive 
                                    ? "bg-orange-500 border-orange-500 text-white shadow-md" 
                                    : "bg-white border-slate-200 text-slate-500 hover:border-orange-300 hover:text-orange-600"
                                  }`}
                              >
                                {isActive && <span className="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>}
                                {cat}
                              </button>
                            );
                          })}
                        </div>
                      </div>
                </div>

                {/* LAJUR KANAN: PARAMETER LAIN */}
                <div className="lg:col-span-5 space-y-6">
                  <div className="bg-slate-50/80 p-6 rounded-3xl border border-slate-200 shadow-inner h-full">
                    <h3 className="text-[11px] font-black text-slate-800 uppercase tracking-widest mb-5 border-b border-slate-200 pb-3">
                      Tapisan Lanjutan
                    </h3>

                    <div className="space-y-5">

                      {/* 3. TAHUN MULA (Optional - Boleh biar atau buang jika tak perlu) */}
                      <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">
                          Tahun Mula Projek
                        </label>
                        <div className="relative">
                          <select
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(e.target.value)}
                            className="w-full py-3 px-4 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-blue-500 appearance-none"
                          >
                            <option value="All">Semua Tahun Mula</option>
                            {uniqueYears.map((y) => (
                              <option key={y} value={y}>{y}</option>
                            ))}
                          </select>
                          <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                          </div>
                        </div>
                      </div>
                      
                      {/* 2. FILTER TAHUN SIAP SEBENAR (ACTUAL COMPLETION) */}
                      <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">
                          Tahun Siap Sebenar (Tarikh Selesai)
                        </label>
                        <div className="relative">
                          <select
                            value={selectedActualYear}
                            onChange={(e) => setSelectedActualYear(e.target.value)}
                            className="w-full py-3 px-4 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 appearance-none"
                          >
                            <option value="All">Semua Tahun</option>
                            {uniqueActualYears.map((y) => (
                              <option key={y} value={y}>{y}</option>
                            ))}
                          </select>
                          <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                          </div>
                        </div>
                        <p className="text-[9px] text-slate-400 mt-1 italic ml-1">
                          *Menapis berdasarkan tarikh siap sebenar projek (Tarikh Selesai).
                        </p>
                      </div>

                      {/* 1. FILTER PEGAWAI (SINGLE SELECT - INDIVIDU) */}
                      <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">
                          Pegawai Bertanggungjawab
                        </label>
                        <div className="relative">
                          <select
                            value={selectedPegawai}
                            onChange={(e) => setSelectedPegawai(e.target.value)}
                            className="w-full py-3 px-4 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 appearance-none"
                          >
                            <option value="All">Semua Pegawai</option>
                            {uniquePegawai.map((p, index) => (
                              <option key={index} value={p}>{p}</option>
                            ))}
                          </select>
                          <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                          </div>
                        </div>
                      </div>

                      {/* Bahagian */}
                      <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">
                          Bahagian / Sektor
                        </label>
                        <select
                          value={selectedBahagian}
                          onChange={(e) => setSelectedBahagian(e.target.value)}
                          className="w-full py-3 px-4 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                        >
                          <option value="All">Semua Bahagian</option>
                          {uniqueBahagian.map((b) => (
                            <option key={b} value={b}>
                              {b}
                            </option>
                          ))}
                        </select>
                      </div>

                      {/* Seksyen */}
                      <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">
                          Seksyen / Unit
                        </label>
                        <select
                          value={selectedSeksyen}
                          onChange={(e) => setSelectedSeksyen(e.target.value)}
                          className="w-full py-3 px-4 bg-white border border-slate-300 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                        >
                          <option value="All">Semua Seksyen</option>
                          {uniqueSeksyen.map((s) => (
                            <option key={s} value={s}>
                              {s}
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* C. FOOTER (Sticky Actions) */}
            <div className="p-6 border-t border-slate-200 bg-white/80 backdrop-blur-md z-20">
              <div className="flex flex-col sm:flex-row gap-4">
                <button
                  onClick={() => {
                    setSearchTerm("");
                    setSelectedStatuses([]);
                    setSelectedVots([]);
                    setSelectedCategories([]);
                    setSelectedPegawai("All");
                    setSelectedActualYear("All");
                    setSelectedBahagian("All");
                    setSelectedYear("All");
                    setSelectedSeksyen("All");
                  }}
                  className="px-8 py-4 rounded-2xl border-2 border-slate-200 text-slate-500 font-black text-xs uppercase tracking-[0.2em] hover:bg-slate-50 hover:text-red-500 hover:border-red-200 transition-all active:scale-95"
                >
                  Reset Semula
                </button>

                <button
                  onClick={() => setIsFilterOpen(false)}
                  className="flex-1 flex items-center justify-center gap-3 px-8 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-xl shadow-blue-500/30 hover:shadow-blue-500/50 hover:scale-[1.01] active:scale-[0.98] transition-all group"
                >
                  <span className="text-sm font-black uppercase tracking-[0.15em]">
                    Paparkan {filtered.length} Rekod
                  </span>
                  <svg
                    className="w-5 h-5 transition-transform group-hover:translate-x-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M17 8l4 4m0 0l-4 4m4-4H3"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };
  ReactDOM.render(<Dashboard />, document.getElementById("root"));

</script>